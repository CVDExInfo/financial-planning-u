AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Finanzas SD API (HTTP API + Cognito JWT + DynamoDB + EventBridge)

Parameters:
  CognitoUserPoolArn:
    Type: String
    Description: Existing Cognito User Pool ARN (from acta-ui)
  CognitoUserPoolId:
    Type: String
    Description: Existing Cognito User Pool ID (from acta-ui)
    Default: us-east-2_FyHLtOhiY
  CognitoUserPoolClientId:
    Type: String
    Description: Cognito app client ID used by Finanzas SD UI
    Default: dshos5iou44tuach7ta3ici5m
  StageName:
    Type: String
    Default: dev
  DocsBucketName:
    Type: String
    Description: S3 bucket for Finanzas document uploads
    Default: ukusi-ui-finanzas-prod
  TablePrefix:
    Type: String
    Default: finz_
  SkipAuth:
    Type: String
    Default: 'false'
  CloudFrontDomain:
    Type: String
    Default: d7t9x3j66yd8k.cloudfront.net
    Description: CloudFront domain used for Finanzas UI (no protocol)
  PolicyStoreId:
    Type: String
    Default: ''
    Description: Amazon Verified Permissions Policy Store ID (optional)
  AlarmEmail:
    Type: String
    Default: ''
    Description: Optional email address for CloudWatch alarm notifications
  EnableAdminDebug:
    Type: String
    Default: 'false'
    Description: Enable admin debug endpoints (set to 'true' for development/testing only)
  TaxonomyS3Bucket:
    Type: String
    Default: ''
    Description: Optional S3 bucket for taxonomy fallback (if local file missing in Lambda)
  TaxonomyS3Key:
    Type: String
    Default: 'taxonomy/rubros.taxonomy.json'
    Description: S3 object key for taxonomy file (default is taxonomy/rubros.taxonomy.json)

Conditions:
  HasPolicyStore: !Not [!Equals [!Ref PolicyStoreId, '']]
  HasAlarmEmail: !Not [!Equals [!Ref AlarmEmail, '']]
  HasTaxonomyBucket: !Not [!Equals [!Ref TaxonomyS3Bucket, '']]

Globals:
  Function:
    Runtime: nodejs20.x
    Timeout: 15
    MemorySize: 256
    Architectures:
      - x86_64
    Tracing: Active
    Environment:
      Variables:
        NODE_OPTIONS: --enable-source-maps

        # Canonical table env vars
        TABLE_PROJECTS: !Sub '${TablePrefix}projects'
        TABLE_RUBROS: !Sub '${TablePrefix}rubros'
        TABLE_RUBROS_TAXONOMIA: !Sub '${TablePrefix}rubros_taxonomia'
        TABLE_ALLOCATIONS: !Sub '${TablePrefix}allocations'
        TABLE_PAYROLL_ACTUALS: !Sub '${TablePrefix}payroll_actuals'
        TABLE_ADJUSTMENTS: !Sub '${TablePrefix}adjustments'
        TABLE_ALERTS: !Sub '${TablePrefix}alerts'
        TABLE_PROVIDERS: !Sub '${TablePrefix}providers'
        TABLE_AUDIT_LOG: !Sub '${TablePrefix}audit_log'
        TABLE_DOCS: !Sub '${TablePrefix}docs'
        TABLE_PREFACTURAS: !Sub '${TablePrefix}prefacturas'
        TABLE_CHANGES: !Sub '${TablePrefix}changes'

        # Back-compat aliases (do not remove without code audit)
        TABLE_ALLOC: !Sub '${TablePrefix}allocations'
        TABLE_PAYROLL: !Sub '${TablePrefix}payroll_actuals'
        TABLE_ADJ: !Sub '${TablePrefix}adjustments'
        TABLE_AUDIT: !Sub '${TablePrefix}audit_log'

        STAGE_NAME: !Ref StageName
        DOCS_BUCKET: !Ref DocsBucketName
        ALLOWED_ORIGIN: !Sub 'https://${CloudFrontDomain}'

        # Cognito
        COGNITO_USER_POOL_ARN: !Ref CognitoUserPoolArn
        COGNITO_USER_POOL_ID: !Ref CognitoUserPoolId
        COGNITO_CLIENT_ID: !Ref CognitoUserPoolClientId
        COGNITO_ISSUER: !Sub 'https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPoolId}'

        # Verified Permissions (optional)
        POLICY_STORE_ID: !If [HasPolicyStore, !Ref PolicyStoreId, '']

        # Taxonomy S3 Fallback (optional)
        TAXONOMY_S3_BUCKET: !If [HasTaxonomyBucket, !Ref TaxonomyS3Bucket, '']
        TAXONOMY_S3_KEY: !Ref TaxonomyS3Key

Resources:
  ApiAccessLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/http-api/${StageName}/finz-access'
      RetentionInDays: 14

  # -------------------
  # DynamoDB Tables
  # -------------------
  ProjectsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${TablePrefix}projects'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
        - AttributeName: sdm_manager_email
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1_sdmManagerEmail
          KeySchema:
            - AttributeName: sdm_manager_email
              KeyType: HASH
            - AttributeName: pk
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  RubrosTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${TablePrefix}rubros'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  RubrosTaxonomiaTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${TablePrefix}rubros_taxonomia'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  AllocationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${TablePrefix}allocations'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  PayrollTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${TablePrefix}payroll_actuals'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  AdjustmentsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${TablePrefix}adjustments'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  ChangesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${TablePrefix}changes'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  AlertsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${TablePrefix}alerts'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  ProvidersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${TablePrefix}providers'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  AuditTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${TablePrefix}audit_log'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  DocsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${TablePrefix}docs'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  PrefacturasTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${TablePrefix}prefacturas'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  # -------------------
  # HTTP API
  # -------------------
  Api:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: !Ref StageName
      CorsConfiguration:
        AllowOrigins:
          - !Sub 'https://${CloudFrontDomain}'
          - http://localhost:5173
          - http://localhost:4173
        AllowHeaders:
          - Authorization
          - Content-Type
          - X-Idempotency-Key
          - X-Amz-Date
          - X-Amz-Security-Token
          - X-Requested-With
          - X-Api-Key
        AllowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        # Credentials disabled to satisfy ApiGatewayV2 CORS rules when using wildcard origins.
        # Authentication uses Bearer tokens in Authorization header, so credentials are not needed.
        AllowCredentials: false
        MaxAge: 86400
      AccessLogSettings:
        DestinationArn: !GetAtt ApiAccessLogs.Arn
        Format: '{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","routeKey":"$context.routeKey","status":$context.status,"method":"$context.httpMethod","path":"$context.path","userAgent":"$context.identity.userAgent"}'
      Auth:
        Authorizers:
          CognitoJwt:
            JwtConfiguration:
              Audience:
                - !Ref CognitoUserPoolClientId
              Issuer: !Sub 'https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPoolId}'
            IdentitySource: $request.header.Authorization
        DefaultAuthorizer: CognitoJwt

  # -------------------
  # Functions
  # -------------------
  OptionsHandler:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/optionsHandler.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: optionsHandler.handler
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        OptionsProxy:
          Type: HttpApi
          Properties:
            Path: /{proxy+}
            Method: OPTIONS
            ApiId: !Ref Api
            Auth:
              Authorizer: NONE

  HealthFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/health.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: health.handler
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        Health:
          Type: HttpApi
          Properties:
            Path: /health
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: NONE

  ProjectsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/projects.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: projects.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AuditTable
        - DynamoDBReadPolicy:
            TableName: !Ref PrefacturasTable
        - !If
          - HasPolicyStore
          - Version: '2012-10-17'
            Statement:
              - Sid: AllowAVPIsAuthorizedWithToken
                Effect: Allow
                Action:
                  - verifiedpermissions:IsAuthorizedWithToken
                Resource: !Sub 'arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}'
          - !Ref AWS::NoValue
      Events:
        CreateProject:
          Type: HttpApi
          Properties:
            Path: /projects
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        ListProjects:
          Type: HttpApi
          Properties:
            Path: /projects
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        ProjectsHandoff:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/handoff
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  BaselineFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/baseline.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: baseline.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AuditTable
        - DynamoDBCrudPolicy:
            TableName: !Ref PrefacturasTable
      Events:
        CreateBaseline:
          Type: HttpApi
          Properties:
            Path: /baseline
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        GetBaseline:
          Type: HttpApi
          Properties:
            Path: /baseline/{baseline_id}
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        GetProjectBaseline:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/baselines/{baseline_id}
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        GetBaselineRubros:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/baselines/{baseline_id}/rubros
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        GetBaselineAllocations:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/baselines/{baseline_id}/allocations
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        GetBaselinePrefacturas:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/baselines/{baseline_id}/prefacturas
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        ListBaselines:
          Type: HttpApi
          Properties:
            Path: /prefacturas/baselines
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  CatalogFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/catalog.ts
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: catalog.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref RubrosTable
        - DynamoDBReadPolicy:
            TableName: !Ref RubrosTaxonomiaTable
      Events:
        ListRubros:
          Type: HttpApi
          Properties:
            Path: /catalog/rubros
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: NONE

  LineItemsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/line-items.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: line-items.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref RubrosTable
      Events:
        ListLineItems:
          Type: HttpApi
          Properties:
            Path: /line-items
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  AllocationRulesGet:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/allocationRules.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: allocationRules.handler
      Policies:
        - AWSLambdaBasicExecutionRole
      Environment:
        Variables:
          SKIP_AUTH: !Ref SkipAuth
      Events:
        GetAllocationRules:
          Type: HttpApi
          Properties:
            Path: /allocation-rules
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  HandoffFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/handoff.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: handoff.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AuditTable
        - DynamoDBReadPolicy:
            TableName: !Ref PrefacturasTable
      Events:
        GetHandoff:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/handoff
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        UpdateHandoff:
          Type: HttpApi
          Properties:
            Path: /handoff/{handoffId}
            Method: PUT
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  AcceptBaselineFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/acceptBaseline.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: acceptBaseline.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AuditTable
        - DynamoDBCrudPolicy:
            TableName: !Ref PrefacturasTable
        - DynamoDBCrudPolicy:
            TableName: !Ref RubrosTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AllocationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref RubrosTaxonomiaTable
      Events:
        AcceptBaseline:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/accept-baseline
            Method: PATCH
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  RejectBaselineFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/rejectBaseline.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: rejectBaseline.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AuditTable
      Events:
        RejectBaseline:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/reject-baseline
            Method: PATCH
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  BaselineSummaryFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/baselineSummary.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: baselineSummary.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBReadPolicy:
            TableName: !Ref PrefacturasTable
        - DynamoDBReadPolicy:
            TableName: !Ref DocsTable
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
              Resource: !Sub 'arn:aws:s3:::${DocsBucketName}/*'
      Events:
        GetBaselineSummary:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/baseline-summary
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  AdminBackfillFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/admin/backfillHandler.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: admin/backfillHandler.handler
      Timeout: 30
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBReadPolicy:
            TableName: !Ref PrefacturasTable
        - DynamoDBCrudPolicy:
            TableName: !Ref RubrosTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AllocationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref RubrosTaxonomiaTable
      Events:
        AdminBackfill:
          Type: HttpApi
          Properties:
            Path: /admin/backfill
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  AdminAllocationsDebugFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/admin/allocations-debug.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: admin/allocations-debug.handler
      Timeout: 15
      Environment:
        Variables:
          ENABLE_ADMIN_DEBUG: !Ref EnableAdminDebug
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref AllocationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref PrefacturasTable
      Events:
        AdminAllocationsVerify:
          Type: HttpApi
          Properties:
            Path: /admin/allocations/verify
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  UploadDocumentFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/upload-docs.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: upload-docs.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref DocsTable
        - Statement:
            - Effect: Allow
              Action:
                - s3:PutObject
                - s3:PutObjectAcl
                - s3:GetObject
              Resource: !Sub 'arn:aws:s3:::${DocsBucketName}/*'
      Events:
        RequestUploadUrl:
          Type: HttpApi
          Properties:
            Path: /uploads/docs
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  # Scheduled (Pep3) function — REQUIRED because Pep3Rule targets it
  AlertsPep3Fn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        # NOTE: keep this pointed at a file that exists in repo.
        # If you later create src/handlers/alerts-pep3.ts, update EntryPoints + Handler accordingly.
        EntryPoints:
          - src/handlers/health.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: health.handler
      Policies:
        - AWSLambdaBasicExecutionRole

  RubrosFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/rubros.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: rubros.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref RubrosTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AuditTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AllocationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref RubrosTaxonomiaTable
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
              Resource: !If
                - HasTaxonomyBucket
                - !Sub 'arn:aws:s3:::${TaxonomyS3Bucket}/${TaxonomyS3Key}'
                - 'arn:aws:s3:::*/*'
      Events:
        AttachRubro:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/rubros
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        ListRubros:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/rubros
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        DetachRubro:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/rubros/{rubroId}
            Method: DELETE
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  RubrosSummaryFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/getRubrosSummary.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: getRubrosSummary.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref RubrosTable
        - DynamoDBReadPolicy:
            TableName: !Ref ProjectsTable
      Events:
        GetRubrosSummary:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/rubros-summary
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  BillingFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/billing.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: billing.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref PrefacturasTable
      Events:
        GetBilling:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/billing
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  AllocationsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/allocations.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: allocations.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref AllocationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBReadPolicy:
            TableName: !Ref PrefacturasTable
        - !If
          - HasPolicyStore
          - Version: '2012-10-17'
            Statement:
              - Sid: AllowAVPIsAuthorizedWithToken
                Effect: Allow
                Action:
                  - verifiedpermissions:IsAuthorizedWithToken
                Resource: !Sub 'arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}'
          - !Ref AWS::NoValue
      Events:
        ListAllocations:
          Type: HttpApi
          Properties:
            Path: /allocations
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        BulkAllocations:
          Type: HttpApi
          Properties:
            Path: /projects/{id}/allocations:bulk
            Method: PUT
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  PlanFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/plan.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: plan.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBReadPolicy:
            TableName: !Ref AllocationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref PayrollTable
        - DynamoDBReadPolicy:
            TableName: !Ref AdjustmentsTable
        - DynamoDBReadPolicy:
            TableName: !Ref RubrosTable
      Events:
        GetPlan:
          Type: HttpApi
          Properties:
            Path: /projects/{id}/plan
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  PayrollFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/payroll.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: payroll.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref PayrollTable
        - DynamoDBReadPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBReadPolicy:
            TableName: !Ref AllocationsTable
      Events:
        ListPayrollActuals:
          Type: HttpApi
          Properties:
            Path: /payroll/actuals
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        IngestPayroll:
          Type: HttpApi
          Properties:
            Path: /payroll/ingest
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        GetPayroll:
          Type: HttpApi
          Properties:
            Path: /payroll
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        PostPayroll:
          Type: HttpApi
          Properties:
            Path: /payroll
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        GetPayrollSummary:
          Type: HttpApi
          Properties:
            Path: /payroll/summary
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        GetPayrollDashboard:
          Type: HttpApi
          Properties:
            Path: /payroll/dashboard
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        BulkUploadPayrollActuals:
          Type: HttpApi
          Properties:
            Path: /payroll/actuals/bulk
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  # Optional/large uploads endpoint — included for Payroll module completeness
  PayrollUploadFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/payroll-upload.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      # Keep handler path aligned with the source tree so esbuild can always resolve it.
      Handler: src/handlers/payroll-upload.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref PayrollTable
        - DynamoDBReadPolicy:
            TableName: !Ref ProjectsTable
      Events:
        UploadPayroll:
          Type: HttpApi
          Properties:
            Path: /payroll/upload
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  CloseMonthFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/close-month.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: close-month.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AllocationsTable
        - !If
          - HasPolicyStore
          - Version: '2012-10-17'
            Statement:
              - Sid: AllowAVPIsAuthorizedWithToken
                Effect: Allow
                Action:
                  - verifiedpermissions:IsAuthorizedWithToken
                Resource: !Sub 'arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}'
          - !Ref AWS::NoValue
      Events:
        CloseMonth:
          Type: HttpApi
          Properties:
            Path: /close-month
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  ReconFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/recon.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: recon.handler
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        GetRecon:
          Type: HttpApi
          Properties:
            Path: /recon
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  AdjustmentsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/adjustments.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: adjustments.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref AdjustmentsTable
        - !If
          - HasPolicyStore
          - Version: '2012-10-17'
            Statement:
              - Sid: AllowAVPIsAuthorizedWithToken
                Effect: Allow
                Action:
                  - verifiedpermissions:IsAuthorizedWithToken
                Resource: !Sub 'arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}'
          - !Ref AWS::NoValue
      Events:
        CreateAdjustment:
          Type: HttpApi
          Properties:
            Path: /adjustments
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        ListAdjustments:
          Type: HttpApi
          Properties:
            Path: /adjustments
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  AlertsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/alerts.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: alerts.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref AlertsTable
      Events:
        GetAlerts:
          Type: HttpApi
          Properties:
            Path: /alerts
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  ProvidersFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/providers.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: providers.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ProvidersTable
      Events:
        CreateProvider:
          Type: HttpApi
          Properties:
            Path: /providers
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        ListProviders:
          Type: HttpApi
          Properties:
            Path: /providers
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  ForecastFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/forecast.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: forecast.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBReadPolicy:
            TableName: !Ref AllocationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref PayrollTable
        - DynamoDBReadPolicy:
            TableName: !Ref AdjustmentsTable
        - DynamoDBReadPolicy:
            TableName: !Ref RubrosTable
      Events:
        GetForecast:
          Type: HttpApi
          Properties:
            Path: /plan/forecast
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  PrefacturasFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/prefacturas.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: prefacturas.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref PrefacturasTable
      Events:
        GetPrefacturas:
          Type: HttpApi
          Properties:
            Path: /prefacturas
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        PostPrefacturas:
          Type: HttpApi
          Properties:
            Path: /prefacturas
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  InvoicesFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/invoices/app.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: app.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref PrefacturasTable
        - DynamoDBReadPolicy:
            TableName: !Ref RubrosTable
      Events:
        GetProjectInvoices:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/invoices
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        CreateProjectInvoice:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/invoices
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        GetProjectInvoiceById:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/invoices/{invoiceId}
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        UpdateProjectInvoiceStatus:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/invoices/{invoiceId}/status
            Method: PUT
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  ChangesFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/changes.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: changes.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ChangesTable
      Events:
        ListProjectChanges:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/changes
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        CreateProjectChange:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/changes
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        UpdateProjectChangeApproval:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/changes/{changeId}/approval
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  # Hub Function (Module)
  HubFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/hub.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: hub.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBReadPolicy:
            TableName: !Ref AllocationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref PayrollTable
        - DynamoDBReadPolicy:
            TableName: !Ref AdjustmentsTable
        - DynamoDBReadPolicy:
            TableName: !Ref RubrosTable
        - !If
          - HasPolicyStore
          - Version: '2012-10-17'
            Statement:
              - Sid: AllowAVPIsAuthorizedWithToken
                Effect: Allow
                Action:
                  - verifiedpermissions:IsAuthorizedWithToken
                Resource: !Sub 'arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}'
          - !Ref AWS::NoValue
      Events:
        HubSummary:
          Type: HttpApi
          Properties:
            Path: /finanzas/hub/summary
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        HubModPerformance:
          Type: HttpApi
          Properties:
            Path: /finanzas/hub/mod-performance
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        HubCashflow:
          Type: HttpApi
          Properties:
            Path: /finanzas/hub/cashflow
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        HubRubrosBreakdown:
          Type: HttpApi
          Properties:
            Path: /finanzas/hub/rubros-breakdown
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        HubExport:
          Type: HttpApi
          Properties:
            Path: /finanzas/hub/export
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  # Budgets Function
  BudgetsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/budgets.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
    Properties:
      CodeUri: .
      Handler: budgets.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AllocationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref PayrollTable
        - !If
          - HasPolicyStore
          - Version: '2012-10-17'
            Statement:
              - Sid: AllowAVPIsAuthorizedWithToken
                Effect: Allow
                Action:
                  - verifiedpermissions:IsAuthorizedWithToken
                Resource: !Sub 'arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}'
          - !Ref AWS::NoValue
      Events:
        GetBudgetAllIn:
          Type: HttpApi
          Properties:
            Path: /budgets/all-in
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        PutBudgetAllIn:
          Type: HttpApi
          Properties:
            Path: /budgets/all-in
            Method: PUT
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        GetBudgetAllInOverview:
          Type: HttpApi
          Properties:
            Path: /budgets/all-in/overview
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        GetBudgetAllInMonthly:
          Type: HttpApi
          Properties:
            Path: /budgets/all-in/monthly
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        PutBudgetAllInMonthly:
          Type: HttpApi
          Properties:
            Path: /budgets/all-in/monthly
            Method: PUT
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  # -------------------
  # EventBridge (Pep3) schedule
  # -------------------
  Pep3Rule:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: cron(0 8 1 * ? *)
      State: ENABLED
      Targets:
        - Arn: !GetAtt AlertsPep3Fn.Arn
          Id: pep3-target

  Pep3Permission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref AlertsPep3Fn
      Principal: events.amazonaws.com
      SourceArn: !GetAtt Pep3Rule.Arn

  # -------------------
  # Observability (optional)
  # -------------------
  AlarmSNSTopic:
    Type: AWS::SNS::Topic
    Condition: HasAlarmEmail
    Properties:
      TopicName: !Sub 'finanzas-api-alarms-${StageName}'
      DisplayName: Finanzas API Alarms
      Subscription:
        - Endpoint: !Ref AlarmEmail
          Protocol: email

  Api5xxErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub 'finanzas-api-5xx-errors-${StageName}'
      AlarmDescription: Alert when API Gateway returns 5xx errors
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: ApiId
          Value: !Ref Api
      AlarmActions:
        - !Ref AlarmSNSTopic

  Api4xxErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub 'finanzas-api-4xx-errors-${StageName}'
      AlarmDescription: Alert when API Gateway returns excessive 4xx errors
      MetricName: 4XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 100
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: ApiId
          Value: !Ref Api
      AlarmActions:
        - !Ref AlarmSNSTopic

  ApiLatencyAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub 'finanzas-api-high-latency-${StageName}'
      AlarmDescription: Alert when API latency exceeds 3 seconds
      MetricName: Latency
      Namespace: AWS/ApiGateway
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 3000
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
        - Name: ApiId
          Value: !Ref Api
      AlarmActions:
        - !Ref AlarmSNSTopic

Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL for the Finanzas SD API
    Value: !Sub 'https://${Api}.execute-api.${AWS::Region}.amazonaws.com/${StageName}'
    Export:
      Name: !Sub 'finanzas-sd-api-endpoint-${StageName}'

  FinzApiId:
    Description: HTTP API ID
    Value: !Ref Api
    Export:
      Name: !Sub 'finz-api-id-${StageName}'

  FinzApiUrl:
    Description: HTTP API URL
    Value: !Sub 'https://${Api}.execute-api.${AWS::Region}.amazonaws.com/${StageName}'
    Export:
      Name: !Sub 'finz-api-url-${StageName}'

  CognitoUserPoolArnOut:
    Description: Cognito User Pool ARN used by this stack
    Value: !Ref CognitoUserPoolArn
    Export:
      Name: !Sub 'finz-cognito-userpool-arn-${StageName}'

  AlarmTopicArn:
    Description: SNS Topic ARN for CloudWatch alarms (if configured)
    Condition: HasAlarmEmail
    Value: !Ref AlarmSNSTopic
    Export:
      Name: !Sub 'finanzas-api-alarm-topic-${StageName}'
