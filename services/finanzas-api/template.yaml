AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Finanzas SD API (HTTP API + Cognito JWT + DynamoDB + EventBridge)

Parameters:
  CognitoUserPoolArn:
    Type: String
    Description: Existing Cognito User Pool ARN (from acta-ui)
  CognitoUserPoolId:
    Type: String
    Description: Existing Cognito User Pool ID (from acta-ui) - e.g., us-east-2_FyHLtOhiY
    Default: us-east-2_FyHLtOhiY
  CognitoUserPoolClientId:
    Type: String
    Description: Cognito app client ID used by Finanzas SD UI
    Default: dshos5iou44tuach7ta3ici5m
  StageName:
    Type: String
    Default: dev
  DocsBucketName:
    Type: String
    Description: S3 bucket for Finanzas document uploads
    Default: ukusi-ui-finanzas-prod
  TablePrefix:
    Type: String
    Default: finz_
  SkipAuth:
    Type: String
    Default: "false"
  AllowedCorsOrigin:
    Type: String
    Default: "https://d7t9x3j66yd8k.cloudfront.net"
    Description: CloudFront domain for CORS (e.g., https://d7t9x3j66yd8k.cloudfront.net)
  PolicyStoreId:
    Type: String
    Default: ""
    Description: Amazon Verified Permissions Policy Store ID (optional, for fine-grained authorization)

Globals:
  Function:
    Runtime: nodejs20.x
    Timeout: 15
    MemorySize: 256
    Architectures: [x86_64]
    Tracing: Active
    Environment:
      Variables:
        NODE_OPTIONS: --enable-source-maps
        TABLE_PROJECTS: !Sub "${TablePrefix}projects"
        TABLE_RUBROS: !Sub "${TablePrefix}rubros"
        TABLE_RUBROS_TAXONOMIA: !Sub "${TablePrefix}rubros_taxonomia"
        TABLE_ALLOC: !Sub "${TablePrefix}allocations"
        TABLE_PAYROLL: !Sub "${TablePrefix}payroll_actuals"
        TABLE_ADJ: !Sub "${TablePrefix}adjustments"
        TABLE_ALERTS: !Sub "${TablePrefix}alerts"
        TABLE_PROVIDERS: !Sub "${TablePrefix}providers"
        TABLE_AUDIT: !Sub "${TablePrefix}audit_log"
        TABLE_DOCS: !Sub "${TablePrefix}docs"
        TABLE_PREFACTURAS: !Sub "${TablePrefix}prefacturas"
        STAGE_NAME: !Ref StageName
        POLICY_STORE_ID: !Ref PolicyStoreId
        DOCS_BUCKET: !Ref DocsBucketName

Resources:
  # ========== DynamoDB tables ==========
  ApiAccessLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      # Dedicated access log group for HTTP API authorizer/integration diagnostics
      LogGroupName: !Sub "/aws/http-api/${StageName}/finz-access"
      RetentionInDays: 14
  ProjectsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${TablePrefix}projects"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - { AttributeName: pk, AttributeType: S }
        - { AttributeName: sk, AttributeType: S }
      KeySchema:
        - { AttributeName: pk, KeyType: HASH }
        - { AttributeName: sk, KeyType: RANGE }

  RubrosTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${TablePrefix}rubros"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - { AttributeName: pk, AttributeType: S }
        - { AttributeName: sk, AttributeType: S }
      KeySchema:
        - { AttributeName: pk, KeyType: HASH }
        - { AttributeName: sk, KeyType: RANGE }

  RubrosTaxonomiaTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${TablePrefix}rubros_taxonomia"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - { AttributeName: pk, AttributeType: S }
        - { AttributeName: sk, AttributeType: S }
      KeySchema:
        - { AttributeName: pk, KeyType: HASH }
        - { AttributeName: sk, KeyType: RANGE }

  AllocationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${TablePrefix}allocations"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - { AttributeName: pk, AttributeType: S }
        - { AttributeName: sk, AttributeType: S }
      KeySchema:
        - { AttributeName: pk, KeyType: HASH }
        - { AttributeName: sk, KeyType: RANGE }

  PayrollTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${TablePrefix}payroll_actuals"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - { AttributeName: pk, AttributeType: S }
        - { AttributeName: sk, AttributeType: S }
      KeySchema:
        - { AttributeName: pk, KeyType: HASH }
        - { AttributeName: sk, KeyType: RANGE }

  AdjustmentsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${TablePrefix}adjustments"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - { AttributeName: pk, AttributeType: S }
        - { AttributeName: sk, AttributeType: S }
      KeySchema:
        - { AttributeName: pk, KeyType: HASH }
        - { AttributeName: sk, KeyType: RANGE }

  AlertsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${TablePrefix}alerts"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - { AttributeName: pk, AttributeType: S }
        - { AttributeName: sk, AttributeType: S }
      KeySchema:
        - { AttributeName: pk, KeyType: HASH }
        - { AttributeName: sk, KeyType: RANGE }

  ProvidersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${TablePrefix}providers"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - { AttributeName: pk, AttributeType: S }
        - { AttributeName: sk, AttributeType: S }
      KeySchema:
        - { AttributeName: pk, KeyType: HASH }
        - { AttributeName: sk, KeyType: RANGE }

  AuditTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${TablePrefix}audit_log"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - { AttributeName: pk, AttributeType: S }
        - { AttributeName: sk, AttributeType: S }
      KeySchema:
        - { AttributeName: pk, KeyType: HASH }
        - { AttributeName: sk, KeyType: RANGE }

  DocsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${TablePrefix}docs"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - { AttributeName: pk, AttributeType: S }
        - { AttributeName: sk, AttributeType: S }
      KeySchema:
        - { AttributeName: pk, KeyType: HASH }
        - { AttributeName: sk, KeyType: RANGE }

  PrefacturasTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${TablePrefix}prefacturas"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - { AttributeName: pk, AttributeType: S }
        - { AttributeName: sk, AttributeType: S }
      KeySchema:
        - { AttributeName: pk, KeyType: HASH }
        - { AttributeName: sk, KeyType: RANGE }

  # ========== HTTP API with Cognito JWT ==========
  Api:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: !Ref StageName
      AccessLogSettings:
        DestinationArn: !GetAtt ApiAccessLogs.Arn
        # Simplified format per operational spec (master prompt)
        Format: "$context.requestId $context.identity.sourceIp $context.status $context.authorizer.error"
      CorsConfiguration:
        AllowOrigins:
          - !Ref AllowedCorsOrigin
        AllowMethods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
        AllowHeaders: ["Authorization", "Content-Type", "X-Idempotency-Key"]
        MaxAge: 600
      Auth:
        Authorizers:
          CognitoJwt:
            JwtConfiguration:
              Audience:
                - !Ref CognitoUserPoolClientId
              Issuer: !Sub https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPoolId}
            IdentitySource: "$request.header.Authorization"
        DefaultAuthorizer: CognitoJwt

  # Note: Serverless::HttpApi with StageName will create and manage the stage automatically.

  # ========== Lambdas ==========
  HealthFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node20
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/health.ts
    Properties:
      CodeUri: .
      Handler: health.handler
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        Health:
          Type: HttpApi
          Properties:
            Path: /health
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: NONE

  ProjectsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/projects.ts
    Properties:
      CodeUri: .
      Handler: projects.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ProjectsTable
        - Statement:
            - Sid: AVPIsAuthorizedWithToken
              Effect: Allow
              Action:
                - verifiedpermissions:IsAuthorizedWithToken
              Resource: !Sub "arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/*"
      Events:
        CreateProject:
          Type: HttpApi
          Properties:
            Path: /projects
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        ListProjects:
          Type: HttpApi
          Properties:
            Path: /projects
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  BaselineFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/baseline.ts
    Properties:
      CodeUri: .
      Handler: baseline.createBaseline
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AuditTable
      Events:
        CreateBaseline:
          Type: HttpApi
          Properties:
            Path: /baseline
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        GetBaseline:
          Type: HttpApi
          Properties:
            Path: /baseline/{baseline_id}
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  CatalogFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        EntryPoints:
          - src/handlers/catalog.ts
    Properties:
      CodeUri: .
      Handler: catalog.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref RubrosTable
        - DynamoDBReadPolicy:
            TableName: !Ref RubrosTaxonomiaTable
      Events:
        ListRubros:
          Type: HttpApi
          Properties:
            Path: /catalog/rubros
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: NONE

  AllocationRulesGet:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/allocationRules.ts
    Properties:
      CodeUri: .
      Handler: allocationRules.handler
      Policies:
        - AWSLambdaBasicExecutionRole
      Environment:
        Variables:
          SKIP_AUTH: !Ref SkipAuth
      Events:
        GetAllocationRules:
          Type: HttpApi
          Properties:
            Path: /allocation-rules
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  HandoffFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/handoff.ts
    Properties:
      CodeUri: .
      Handler: handoff.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AuditTable
      Events:
        CreateHandoff:
          Type: HttpApi
          Properties:
            Path: "/projects/{projectId}/handoff"
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        GetHandoff:
          Type: HttpApi
          Properties:
            Path: "/projects/{projectId}/handoff"
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        UpdateHandoff:
          Type: HttpApi
          Properties:
            Path: "/handoff/{handoffId}"
            Method: PUT
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  UploadDocumentFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node20
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/upload-docs.ts
    Properties:
      CodeUri: .
      Handler: uploadDocs.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref DocsTable
        - Statement:
            - Effect: Allow
              Action:
                - s3:PutObject
                - s3:PutObjectAcl
                - s3:GetObject
              Resource: !Sub "arn:aws:s3:::${DocsBucketName}/*"
      Events:
        RequestUploadUrl:
          Type: HttpApi
          Properties:
            Path: /uploads/docs
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  # TODO: Implement PEP-3 monthly alert logic for budget variance detection
  # Currently reuses health handler as placeholder
  AlertsPep3Fn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/health.ts
    Properties:
      CodeUri: .
      Handler: health.handler
      Policies:
        - AWSLambdaBasicExecutionRole

  # R1 MVP endpoints - stubbed for initial slice
  RubrosFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/rubros.ts
    Properties:
      CodeUri: .
      Handler: rubros.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref RubrosTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AuditTable
      Events:
        AttachRubro:
          Type: HttpApi
          Properties:
            Path: "/projects/{projectId}/rubros"
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        ListRubros:
          Type: HttpApi
          Properties:
            Path: "/projects/{projectId}/rubros"
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        DetachRubro:
          Type: HttpApi
          Properties:
            Path: "/projects/{projectId}/rubros/{rubroId}"
            Method: DELETE
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  AllocationsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/allocations.ts
    Properties:
      CodeUri: .
      Handler: allocations.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref AllocationsTable
        - Statement:
            - Sid: AVPIsAuthorizedWithToken
              Effect: Allow
              Action:
                - verifiedpermissions:IsAuthorizedWithToken
              Resource: !Sub "arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/*"
      Events:
        BulkAllocations:
          Type: HttpApi
          Properties:
            Path: "/projects/{id}/allocations:bulk"
            Method: PUT
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  PlanFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/plan.ts
    Properties:
      CodeUri: .
      Handler: plan.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBReadPolicy:
            TableName: !Ref AllocationsTable
        - DynamoDBReadPolicy:
            TableName: !Ref PayrollTable
        - DynamoDBReadPolicy:
            TableName: !Ref AdjustmentsTable
      Events:
        GetPlan:
          Type: HttpApi
          Properties:
            Path: "/projects/{id}/plan"
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  PayrollFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/payroll.ts
    Properties:
      CodeUri: .
      Handler: payroll.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref PayrollTable
      Events:
        IngestPayroll:
          Type: HttpApi
          Properties:
            Path: /payroll/ingest
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  CloseMonthFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/close-month.ts
    Properties:
      CodeUri: .
      Handler: close-month.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ProjectsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AllocationsTable
        - Statement:
            - Sid: AVPIsAuthorizedWithToken
              Effect: Allow
              Action:
                - verifiedpermissions:IsAuthorizedWithToken
              Resource: !Sub "arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/*"
      Events:
        CloseMonth:
          Type: HttpApi
          Properties:
            Path: /close-month
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  AdjustmentsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/adjustments.ts
    Properties:
      CodeUri: .
      Handler: adjustments.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref AdjustmentsTable
        - Statement:
            - Sid: AVPIsAuthorizedWithToken
              Effect: Allow
              Action:
                - verifiedpermissions:IsAuthorizedWithToken
              Resource: !Sub "arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/*"
      Events:
        CreateAdjustment:
          Type: HttpApi
          Properties:
            Path: /adjustments
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        ListAdjustments:
          Type: HttpApi
          Properties:
            Path: /adjustments
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  AlertsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/alerts.ts
    Properties:
      CodeUri: .
      Handler: alerts.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName: !Ref AlertsTable
      Events:
        GetAlerts:
          Type: HttpApi
          Properties:
            Path: /alerts
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  ProvidersFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node18
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/providers.ts
    Properties:
      CodeUri: .
      Handler: providers.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName: !Ref ProvidersTable
      Events:
        CreateProvider:
          Type: HttpApi
          Properties:
            Path: /providers
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt
        ListProviders:
          Type: HttpApi
          Properties:
            Path: /providers
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: CognitoJwt

  ForecastFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node20
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/forecast.ts
    Properties:
      CodeUri: .
      Handler: forecast.handler
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        GetForecast:
          Type: HttpApi
          Properties:
            Path: /plan/forecast
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: NONE

  PrefacturasFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: node20
        Sourcemap: true
        External:
          - aws-sdk
        EntryPoints:
          - src/handlers/prefacturas.ts
    Properties:
      CodeUri: .
      Handler: prefacturas.handler
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        GetPrefacturas:
          Type: HttpApi
          Properties:
            Path: /prefacturas
            Method: GET
            ApiId: !Ref Api
            Auth:
              Authorizer: NONE
        PostPrefacturas:
          Type: HttpApi
          Properties:
            Path: /prefacturas
            Method: POST
            ApiId: !Ref Api
            Auth:
              Authorizer: NONE

  Pep3Rule:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: cron(0 8 1 * ? *) # monthly, 8am UTC 1st
      State: ENABLED
      Targets:
        - Arn: !GetAtt AlertsPep3Fn.Arn
          Id: pep3-target
  Pep3Permission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref AlertsPep3Fn
      Principal: events.amazonaws.com
      SourceArn: !GetAtt Pep3Rule.Arn

Outputs:
  FinzApiId:
    Description: HTTP API ID
    Value: !Ref Api
    Export:
      Name: !Sub "finz-api-id-${StageName}"
  FinzApiUrl:
    Description: HTTP API URL
    Value: !Sub https://${Api}.execute-api.${AWS::Region}.amazonaws.com/${StageName}
    Export:
      Name: !Sub "finz-api-url-${StageName}"
