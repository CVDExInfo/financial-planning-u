AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Finanzas SD API (HTTP API + Cognito JWT + DynamoDB + EventBridge)
Parameters:
  CognitoUserPoolArn:
    Type: String
    Description: Existing Cognito User Pool ARN (from acta-ui)
  CognitoUserPoolId:
    Type: String
    Description: Existing Cognito User Pool ID (from acta-ui) - e.g., us-east-2_FyHLtOhiY
    Default: us-east-2_FyHLtOhiY
  CognitoUserPoolClientId:
    Type: String
    Description: Cognito app client ID used by Finanzas SD UI
    Default: dshos5iou44tuach7ta3ici5m
  StageName:
    Type: String
    Default: dev
  DocsBucketName:
    Type: String
    Description: S3 bucket for Finanzas document uploads
    Default: ukusi-ui-finanzas-prod
  TablePrefix:
    Type: String
    Default: finz_
  SkipAuth:
    Type: String
    Default: 'false'
  CloudFrontDomain:
    Type: String
    Default: d7t9x3j66yd8k.cloudfront.net
    Description: CloudFront domain used for Finanzas UI (no protocol)
  PolicyStoreId:
    Type: String
    Default: ''
    Description: Amazon Verified Permissions Policy Store ID (optional, for fine-grained
      authorization)
  AlarmEmail:
    Type: String
    Default: ''
    Description: Optional email address for CloudWatch alarm notifications
Conditions:
  HasPolicyStore:
    Fn::Not:
    - Fn::Equals:
      - Ref: PolicyStoreId
      - ''
  HasAlarmEmail:
    Fn::Not:
    - Fn::Equals:
      - Ref: AlarmEmail
      - ''
Globals:
  Function:
    Runtime: nodejs20.x
    Timeout: 15
    MemorySize: 256
    Architectures:
    - x86_64
    Tracing: Active
    Environment:
      Variables:
        NODE_OPTIONS: --enable-source-maps
        TABLE_PROJECTS:
          Fn::Sub: ${TablePrefix}projects
        TABLE_RUBROS:
          Fn::Sub: ${TablePrefix}rubros
        TABLE_RUBROS_TAXONOMIA:
          Fn::Sub: ${TablePrefix}rubros_taxonomia
        TABLE_ALLOCATIONS:
          Fn::Sub: ${TablePrefix}allocations
        TABLE_PAYROLL_ACTUALS:
          Fn::Sub: ${TablePrefix}payroll_actuals
        TABLE_ADJUSTMENTS:
          Fn::Sub: ${TablePrefix}adjustments
        TABLE_ALLOC:
          Fn::Sub: ${TablePrefix}allocations
        TABLE_PAYROLL:
          Fn::Sub: ${TablePrefix}payroll_actuals
        TABLE_ADJ:
          Fn::Sub: ${TablePrefix}adjustments
        TABLE_ALERTS:
          Fn::Sub: ${TablePrefix}alerts
        TABLE_PROVIDERS:
          Fn::Sub: ${TablePrefix}providers
        TABLE_AUDIT:
          Fn::Sub: ${TablePrefix}audit_log
        TABLE_AUDIT_LOG:
          Fn::Sub: ${TablePrefix}audit_log
        TABLE_DOCS:
          Fn::Sub: ${TablePrefix}docs
        TABLE_PREFACTURAS:
          Fn::Sub: ${TablePrefix}prefacturas
        TABLE_CHANGES:
          Fn::Sub: ${TablePrefix}changes
        STAGE_NAME:
          Ref: StageName
        POLICY_STORE_ID:
          Fn::If:
          - HasPolicyStore
          - Ref: PolicyStoreId
          - ''
        DOCS_BUCKET:
          Ref: DocsBucketName
        ALLOWED_ORIGIN:
          Fn::Sub: https://${CloudFrontDomain}
        COGNITO_USER_POOL_ID:
          Ref: CognitoUserPoolId
        COGNITO_CLIENT_ID:
          Ref: CognitoUserPoolClientId
        COGNITO_ISSUER:
          Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPoolId}
Resources:
  ApiAccessLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/http-api/${StageName}/finz-access
      RetentionInDays: 14
    Metadata:
      SamResourceId: ApiAccessLogs
  ProjectsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}projects
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      - AttributeName: sdm_manager_email
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
      GlobalSecondaryIndexes:
      - IndexName: GSI1_sdmManagerEmail
        KeySchema:
        - AttributeName: sdm_manager_email
          KeyType: HASH
        - AttributeName: pk
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
    Metadata:
      SamResourceId: ProjectsTable
  RubrosTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}rubros
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
    Metadata:
      SamResourceId: RubrosTable
  RubrosTaxonomiaTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}rubros_taxonomia
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
    Metadata:
      SamResourceId: RubrosTaxonomiaTable
  AllocationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}allocations
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
    Metadata:
      SamResourceId: AllocationsTable
  PayrollTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}payroll_actuals
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
    Metadata:
      SamResourceId: PayrollTable
  AdjustmentsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}adjustments
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
    Metadata:
      SamResourceId: AdjustmentsTable
  ChangesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}changes
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
    Metadata:
      SamResourceId: ChangesTable
  AlertsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}alerts
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
    Metadata:
      SamResourceId: AlertsTable
  ProvidersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}providers
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
    Metadata:
      SamResourceId: ProvidersTable
  AuditTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}audit_log
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
    Metadata:
      SamResourceId: AuditTable
  DocsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}docs
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
    Metadata:
      SamResourceId: DocsTable
  PrefacturasTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}prefacturas
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
    Metadata:
      SamResourceId: PrefacturasTable
  Api:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName:
        Ref: StageName
      CorsConfiguration:
        AllowOrigins:
        - Fn::Sub: https://${CloudFrontDomain}
        - http://localhost:5173
        - http://localhost:4173
        AllowHeaders:
        - authorization
        - content-type
        - Authorization
        - Content-Type
        - x-idempotency-key
        - x-amz-date
        - x-amz-security-token
        - x-requested-with
        - X-Requested-With
        - x-api-key
        AllowMethods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
        MaxAge: 86400
      AccessLogSettings:
        DestinationArn:
          Fn::GetAtt:
          - ApiAccessLogs
          - Arn
        Format: '{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","routeKey":"$context.routeKey","status":$context.status,"method":"$context.httpMethod","path":"$context.path","userAgent":"$context.identity.userAgent"}'
      Auth:
        Authorizers:
          CognitoJwt:
            JwtConfiguration:
              Audience:
              - Ref: CognitoUserPoolClientId
              Issuer:
                Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPoolId}
            IdentitySource: $request.header.Authorization
        DefaultAuthorizer: CognitoJwt
    Metadata:
      SamResourceId: Api
  OptionsHandler:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/optionsHandler.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: OptionsHandler
    Properties:
      CodeUri: .
      Handler: optionsHandler.handler
      Events:
        OptionsProxy:
          Type: HttpApi
          Properties:
            Path: /{proxy+}
            Method: OPTIONS
            ApiId:
              Ref: Api
            Auth:
              Authorizer: NONE
  HealthFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/health.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: HealthFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/7aa9e4a05f55b59dd067c5970a9f4d00
      Handler: health.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      Events:
        Health:
          Type: HttpApi
          Properties:
            Path: /health
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: NONE
  ProjectsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/projects.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: ProjectsFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/998d2febe2d1f4d1b194628a2fd7e13f
      Handler: projects.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ProjectsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AuditTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: PrefacturasTable
      - Fn::If:
        - HasPolicyStore
        - Version: '2012-10-17'
          Statement:
          - Sid: AllowAVPIsAuthorizedWithToken
            Effect: Allow
            Action:
            - verifiedpermissions:IsAuthorizedWithToken
            Resource:
              Fn::Sub: arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}
        - Ref: AWS::NoValue
      Events:
        CreateProject:
          Type: HttpApi
          Properties:
            Path: /projects
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        ListProjects:
          Type: HttpApi
          Properties:
            Path: /projects
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        ProjectsHandoff:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/handoff
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  BaselineFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/baseline.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: BaselineFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/07728672c1bd1b6bc788b9cd96473d11
      Handler: baseline.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ProjectsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AuditTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: PrefacturasTable
      Events:
        CreateBaseline:
          Type: HttpApi
          Properties:
            Path: /baseline
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        GetBaseline:
          Type: HttpApi
          Properties:
            Path: /baseline/{baseline_id}
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        ListBaselines:
          Type: HttpApi
          Properties:
            Path: /prefacturas/baselines
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  CatalogFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/catalog.ts
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: CatalogFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/c2092347f32fffd7743b72287cd537db
      Handler: catalog.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBReadPolicy:
          TableName:
            Ref: RubrosTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: RubrosTaxonomiaTable
      Events:
        ListRubros:
          Type: HttpApi
          Properties:
            Path: /catalog/rubros
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: NONE
  LineItemsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/line-items.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: LineItemsFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/9d30e7230d069bd0779d74b258770217
      Handler: line-items.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBReadPolicy:
          TableName:
            Ref: RubrosTable
      Events:
        ListLineItems:
          Type: HttpApi
          Properties:
            Path: /line-items
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  AllocationRulesGet:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/allocationRules.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: AllocationRulesGet
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/1c4528b92ceb1d9fd065988bc8b326bf
      Handler: allocationRules.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      Environment:
        Variables:
          SKIP_AUTH:
            Ref: SkipAuth
      Events:
        GetAllocationRules:
          Type: HttpApi
          Properties:
            Path: /allocation-rules
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  HandoffFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/handoff.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: HandoffFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/3c0bc6d1cc1535638a168c049d715eb7
      Handler: handoff.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ProjectsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AuditTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: PrefacturasTable
      Events:
        GetHandoff:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/handoff
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        UpdateHandoff:
          Type: HttpApi
          Properties:
            Path: /handoff/{handoffId}
            Method: PUT
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  AcceptBaselineFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/acceptBaseline.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: AcceptBaselineFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/be19a14b4a90801ea9020acce1692139
      Handler: acceptBaseline.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ProjectsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AuditTable
      Events:
        AcceptBaseline:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/accept-baseline
            Method: PATCH
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  RejectBaselineFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/rejectBaseline.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: RejectBaselineFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/8764712c5d446aee3ee15a8d0460f0bf
      Handler: rejectBaseline.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ProjectsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AuditTable
      Events:
        RejectBaseline:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/reject-baseline
            Method: PATCH
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  UploadDocumentFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/upload-docs.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: UploadDocumentFunction
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/6ef79b0b1ca6d1f9b467cf24abb3d267
      Handler: upload-docs.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DocsTable
      - Statement:
        - Effect: Allow
          Action:
          - s3:PutObject
          - s3:PutObjectAcl
          - s3:GetObject
          Resource:
            Fn::Sub: arn:aws:s3:::${DocsBucketName}/*
      Events:
        RequestUploadUrl:
          Type: HttpApi
          Properties:
            Path: /uploads/docs
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  AlertsPep3Fn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/health.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: AlertsPep3Fn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/f3948dd324ea20ebef39893429629d4a
      Handler: health.handler
      Policies:
      - AWSLambdaBasicExecutionRole
  RubrosFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/rubros.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: RubrosFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/de047cfa30b2cb44da0c9c18057d4905
      Handler: rubros.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: RubrosTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AuditTable
      Events:
        AttachRubro:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/rubros
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        ListRubros:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/rubros
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        DetachRubro:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/rubros/{rubroId}
            Method: DELETE
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  BillingFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/billing.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: BillingFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/f751bd8b659ab404e63f9e14647755f7
      Handler: billing.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBReadPolicy:
          TableName:
            Ref: PrefacturasTable
      Events:
        GetBilling:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/billing
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  AllocationsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/allocations.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: AllocationsFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/ccbfb2b0fbb2ebb0df4c87d1dd700d75
      Handler: allocations.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AllocationsTable
      - Fn::If:
        - HasPolicyStore
        - Version: '2012-10-17'
          Statement:
          - Sid: AllowAVPIsAuthorizedWithToken
            Effect: Allow
            Action:
            - verifiedpermissions:IsAuthorizedWithToken
            Resource:
              Fn::Sub: arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}
        - Ref: AWS::NoValue
      Events:
        ListAllocations:
          Type: HttpApi
          Properties:
            Path: /allocations
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        BulkAllocations:
          Type: HttpApi
          Properties:
            Path: /projects/{id}/allocations:bulk
            Method: PUT
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  PlanFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/plan.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: PlanFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/9851ef66cd4bfe9c63344f8cce16814a
      Handler: plan.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBReadPolicy:
          TableName:
            Ref: ProjectsTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: AllocationsTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: PayrollTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: AdjustmentsTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: RubrosTable
      Events:
        GetPlan:
          Type: HttpApi
          Properties:
            Path: /projects/{id}/plan
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  PayrollFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/payroll.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: PayrollFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/2613cd54abbbdfac89659b5d97f6ac9d
      Handler: payroll.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: PayrollTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: ProjectsTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: AllocationsTable
      Events:
        ListPayrollActuals:
          Type: HttpApi
          Properties:
            Path: /payroll/actuals
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        CreatePayrollActual:
          Type: HttpApi
          Properties:
            Path: /payroll/actuals
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        IngestPayrollActualsBulk:
          Type: HttpApi
          Properties:
            Path: /payroll/actuals/bulk
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        IngestPayroll:
          Type: HttpApi
          Properties:
            Path: /payroll/ingest
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        GetPayroll:
          Type: HttpApi
          Properties:
            Path: /payroll
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        PostPayroll:
          Type: HttpApi
          Properties:
            Path: /payroll
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        GetPayrollSummary:
          Type: HttpApi
          Properties:
            Path: /payroll/summary
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        GetPayrollDashboard:
          Type: HttpApi
          Properties:
            Path: /payroll/dashboard
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  CloseMonthFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/close-month.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: CloseMonthFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/e0b0c0d5dbb45531e559141a4883d706
      Handler: close-month.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ProjectsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AllocationsTable
      - Fn::If:
        - HasPolicyStore
        - Version: '2012-10-17'
          Statement:
          - Sid: AllowAVPIsAuthorizedWithToken
            Effect: Allow
            Action:
            - verifiedpermissions:IsAuthorizedWithToken
            Resource:
              Fn::Sub: arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}
        - Ref: AWS::NoValue
      Events:
        CloseMonth:
          Type: HttpApi
          Properties:
            Path: /close-month
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  ReconFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/recon.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: ReconFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/9defdcd39ce333dbbc0b34bb300e8c8b
      Handler: recon.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      Events:
        GetRecon:
          Type: HttpApi
          Properties:
            Path: /recon
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  AdjustmentsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/adjustments.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: AdjustmentsFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/a112963fd4ff4e94451836e482035832
      Handler: adjustments.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdjustmentsTable
      - Fn::If:
        - HasPolicyStore
        - Version: '2012-10-17'
          Statement:
          - Sid: AllowAVPIsAuthorizedWithToken
            Effect: Allow
            Action:
            - verifiedpermissions:IsAuthorizedWithToken
            Resource:
              Fn::Sub: arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}
        - Ref: AWS::NoValue
      Events:
        CreateAdjustment:
          Type: HttpApi
          Properties:
            Path: /adjustments
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        ListAdjustments:
          Type: HttpApi
          Properties:
            Path: /adjustments
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  AlertsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/alerts.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: AlertsFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/b1d44dd2db1327ad85f1e8a47fd8887a
      Handler: alerts.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBReadPolicy:
          TableName:
            Ref: AlertsTable
      Events:
        GetAlerts:
          Type: HttpApi
          Properties:
            Path: /alerts
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  ProvidersFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/providers.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: ProvidersFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/c318fd0b724a598a85ea6f23eeab4c1f
      Handler: providers.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ProvidersTable
      Events:
        CreateProvider:
          Type: HttpApi
          Properties:
            Path: /providers
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        ListProviders:
          Type: HttpApi
          Properties:
            Path: /providers
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  ForecastFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/forecast.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: ForecastFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/42778797fbf4c0ce0a913716dffcfa75
      Handler: forecast.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBReadPolicy:
          TableName:
            Ref: ProjectsTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: AllocationsTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: PayrollTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: AdjustmentsTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: RubrosTable
      Events:
        GetForecast:
          Type: HttpApi
          Properties:
            Path: /plan/forecast
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  PrefacturasFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/prefacturas.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: PrefacturasFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/3ac9757074e4b71969b13842c162e2a8
      Handler: prefacturas.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: PrefacturasTable
      Events:
        GetPrefacturas:
          Type: HttpApi
          Properties:
            Path: /prefacturas
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        PostPrefacturas:
          Type: HttpApi
          Properties:
            Path: /prefacturas
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  InvoicesFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/invoices/app.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: InvoicesFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/539bd5b9bd169ea0349e129b741e3e00
      Handler: app.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: PrefacturasTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: RubrosTable
      Events:
        GetProjectInvoices:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/invoices
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        CreateProjectInvoice:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/invoices
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        GetProjectInvoiceById:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/invoices/{invoiceId}
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        UpdateProjectInvoiceStatus:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/invoices/{invoiceId}/status
            Method: PUT
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  ChangesFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
        - src/handlers/changes.ts
        External:
        - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: ChangesFn
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-camiblsrpaa3/c8c92c114de2bd6709427a580ea72685
      Handler: changes.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ChangesTable
      Events:
        ListProjectChanges:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/changes
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        CreateProjectChange:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/changes
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        UpdateProjectChangeApproval:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/changes/{changeId}/approval
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
  Pep3Rule:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: cron(0 8 1 * ? *)
      State: ENABLED
      Targets:
      - Arn:
          Fn::GetAtt:
          - AlertsPep3Fn
          - Arn
        Id: pep3-target
    Metadata:
      SamResourceId: Pep3Rule
  Pep3Permission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: AlertsPep3Fn
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
        - Pep3Rule
        - Arn
    Metadata:
      SamResourceId: Pep3Permission
  AlarmSNSTopic:
    Type: AWS::SNS::Topic
    Condition: HasAlarmEmail
    Properties:
      TopicName:
        Fn::Sub: finanzas-api-alarms-${StageName}
      DisplayName: Finanzas API Alarms
      Subscription:
      - Endpoint:
          Ref: AlarmEmail
        Protocol: email
    Metadata:
      SamResourceId: AlarmSNSTopic
  Api5xxErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName:
        Fn::Sub: finanzas-api-5xx-errors-${StageName}
      AlarmDescription: Alert when API Gateway returns 5xx errors
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
      - Name: ApiId
        Value:
          Ref: Api
      AlarmActions:
      - Ref: AlarmSNSTopic
    Metadata:
      SamResourceId: Api5xxErrorAlarm
  Api4xxErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName:
        Fn::Sub: finanzas-api-4xx-errors-${StageName}
      AlarmDescription: Alert when API Gateway returns excessive 4xx errors
      MetricName: 4XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 100
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
      - Name: ApiId
        Value:
          Ref: Api
      AlarmActions:
      - Ref: AlarmSNSTopic
    Metadata:
      SamResourceId: Api4xxErrorAlarm
  ApiLatencyAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName:
        Fn::Sub: finanzas-api-high-latency-${StageName}
      AlarmDescription: Alert when API latency exceeds 3 seconds
      MetricName: Latency
      Namespace: AWS/ApiGateway
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 3000
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Dimensions:
      - Name: ApiId
        Value:
          Ref: Api
      AlarmActions:
      - Ref: AlarmSNSTopic
    Metadata:
      SamResourceId: ApiLatencyAlarm
Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL for the Finanzas SD API
    Value:
      Fn::Sub: https://${Api}.execute-api.${AWS::Region}.amazonaws.com/${StageName}
    Export:
      Name:
        Fn::Sub: finanzas-sd-api-endpoint-${StageName}
  FinzApiId:
    Description: HTTP API ID
    Value:
      Ref: Api
    Export:
      Name:
        Fn::Sub: finz-api-id-${StageName}
  FinzApiUrl:
    Description: HTTP API URL
    Value:
      Fn::Sub: https://${Api}.execute-api.${AWS::Region}.amazonaws.com/${StageName}
    Export:
      Name:
        Fn::Sub: finz-api-url-${StageName}
  AlarmTopicArn:
    Description: SNS Topic ARN for CloudWatch alarms (if configured)
    Condition: HasAlarmEmail
    Value:
      Ref: AlarmSNSTopic
    Export:
      Name:
        Fn::Sub: finanzas-api-alarm-topic-${StageName}
