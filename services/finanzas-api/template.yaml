AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Finanzas SD API (HTTP API + Cognito JWT + DynamoDB + EventBridge)

Parameters:
  CognitoUserPoolArn:
    Type: String
    Description: Existing Cognito User Pool ARN (from acta-ui)
  CognitoUserPoolId:
    Type: String
    Description: Existing Cognito User Pool ID (from acta-ui) - e.g., us-east-2_FyHLtOhiY
    Default: us-east-2_FyHLtOhiY
  CognitoUserPoolClientId:
    Type: String
    Description: Cognito app client ID used by Finanzas SD UI
    Default: dshos5iou44tuach7ta3ici5m
  StageName:
    Type: String
    Default: dev
  DocsBucketName:
    Type: String
    Description: S3 bucket for Finanzas document uploads
    Default: ukusi-ui-finanzas-prod
  TablePrefix:
    Type: String
    Default: finz_
  SkipAuth:
    Type: String
    Default: 'false'
  CloudFrontDomain:
    Type: String
    Default: d7t9x3j66yd8k.cloudfront.net
    Description: CloudFront domain used for Finanzas UI (no protocol)
  PolicyStoreId:
    Type: String
    Default: ''
    Description: Amazon Verified Permissions Policy Store ID (optional, for fine-grained authorization)

Conditions:
  HasPolicyStore:
    Fn::Not:
      - Fn::Equals:
          - Ref: PolicyStoreId
          - ""

Globals:
  Function:
    Runtime: nodejs20.x
    Timeout: 15
    MemorySize: 256
    Architectures:
      - x86_64
    Tracing: Active
    Environment:
      Variables:
        NODE_OPTIONS: --enable-source-maps
        TABLE_PROJECTS:
          Fn::Sub: ${TablePrefix}projects
        TABLE_RUBROS:
          Fn::Sub: ${TablePrefix}rubros
        TABLE_RUBROS_TAXONOMIA:
          Fn::Sub: ${TablePrefix}rubros_taxonomia
        TABLE_ALLOCATIONS:
          Fn::Sub: ${TablePrefix}allocations
        TABLE_PAYROLL_ACTUALS:
          Fn::Sub: ${TablePrefix}payroll_actuals
        TABLE_ADJUSTMENTS:
          Fn::Sub: ${TablePrefix}adjustments
        TABLE_ALLOC:
          Fn::Sub: ${TablePrefix}allocations
        TABLE_PAYROLL:
          Fn::Sub: ${TablePrefix}payroll_actuals
        TABLE_ADJ:
          Fn::Sub: ${TablePrefix}adjustments
        TABLE_ALERTS:
          Fn::Sub: ${TablePrefix}alerts
        TABLE_PROVIDERS:
          Fn::Sub: ${TablePrefix}providers
        TABLE_AUDIT:
          Fn::Sub: ${TablePrefix}audit_log
        TABLE_AUDIT_LOG:
          Fn::Sub: ${TablePrefix}audit_log
        TABLE_DOCS:
          Fn::Sub: ${TablePrefix}docs
        TABLE_PREFACTURAS:
          Fn::Sub: ${TablePrefix}prefacturas
        TABLE_CHANGES:
          Fn::Sub: ${TablePrefix}changes
        STAGE_NAME:
          Ref: StageName
        POLICY_STORE_ID:
          Fn::If:
            - HasPolicyStore
            - Ref: PolicyStoreId
            - ""
        DOCS_BUCKET:
          Ref: DocsBucketName
        ALLOWED_ORIGIN:
          Fn::Sub: https://${CloudFrontDomain}
        COGNITO_USER_POOL_ID:
          Ref: CognitoUserPoolId
        COGNITO_CLIENT_ID:
          Ref: CognitoUserPoolClientId
        COGNITO_ISSUER:
          Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPoolId}

Resources:
  ApiAccessLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/http-api/${StageName}/finz-access
      RetentionInDays: 14
    Metadata:
      SamResourceId: ApiAccessLogs

  ProjectsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}projects
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
    Metadata:
      SamResourceId: ProjectsTable

  RubrosTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}rubros
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
    Metadata:
      SamResourceId: RubrosTable

  RubrosTaxonomiaTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}rubros_taxonomia
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
    Metadata:
      SamResourceId: RubrosTaxonomiaTable

  AllocationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}allocations
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
    Metadata:
      SamResourceId: AllocationsTable

  PayrollTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}payroll_actuals
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
    Metadata:
      SamResourceId: PayrollTable

  AdjustmentsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}adjustments
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
    Metadata:
      SamResourceId: AdjustmentsTable

  ChangesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}changes
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
    Metadata:
      SamResourceId: ChangesTable

  AlertsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}alerts
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
    Metadata:
      SamResourceId: AlertsTable

  ProvidersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}providers
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
    Metadata:
      SamResourceId: ProvidersTable

  AuditTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}audit_log
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
    Metadata:
      SamResourceId: AuditTable

  DocsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}docs
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
    Metadata:
      SamResourceId: DocsTable

  PrefacturasTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${TablePrefix}prefacturas
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
    Metadata:
      SamResourceId: PrefacturasTable

  Api:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName:
        Ref: StageName
      CorsConfiguration:
        AllowOrigins:
          - Fn::Sub: https://${CloudFrontDomain}
        AllowHeaders:
          - Authorization
          - Content-Type
          - X-Idempotency-Key
          - X-Amz-Date
          - X-Amz-Security-Token
          - X-Requested-With
          - X-Api-Key
        AllowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        AllowCredentials: true
        MaxAge: 86400
      AccessLogSettings:
        DestinationArn:
          Fn::GetAtt:
            - ApiAccessLogs
            - Arn
        Format: '{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","routeKey":"$context.routeKey","status":$context.status,"method":"$context.httpMethod","path":"$context.path","userAgent":"$context.identity.userAgent"}'
      Auth:
        Authorizers:
          CognitoJwt:
            JwtConfiguration:
              Audience:
                - Ref: CognitoUserPoolClientId
              Issuer:
                Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPoolId}
            IdentitySource: $request.header.Authorization
        DefaultAuthorizer: CognitoJwt
    Metadata:
      SamResourceId: Api

  HealthFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/health.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: HealthFn
    Properties:
      CodeUri: .
      Handler: health.handler
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        Health:
          Type: HttpApi
          Properties:
            Path: /health
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: NONE

  ProjectsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/projects.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: ProjectsFn
    Properties:
      CodeUri: .
      Handler: projects.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ProjectsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AuditTable
      - DynamoDBReadPolicy:
          TableName:
            Ref: PrefacturasTable
      - Fn::If:
        - HasPolicyStore
        - Version: "2012-10-17"
          Statement:
          - Sid: AllowAVPIsAuthorizedWithToken
            Effect: Allow
            Action:
            - verifiedpermissions:IsAuthorizedWithToken
            Resource:
              Fn::Sub: arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}
        - !Ref AWS::NoValue
      Events:
        CreateProject:
          Type: HttpApi
          Properties:
            Path: /projects
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        ListProjects:
          Type: HttpApi
          Properties:
            Path: /projects
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        ProjectsHandoff:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/handoff
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  BaselineFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/baseline.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: BaselineFn
    Properties:
      CodeUri: .
      Handler: baseline.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName:
              Ref: ProjectsTable
        - DynamoDBCrudPolicy:
            TableName:
              Ref: AuditTable
        - DynamoDBCrudPolicy:
            TableName:
              Ref: PrefacturasTable
      Events:
        CreateBaseline:
          Type: HttpApi
          Properties:
            Path: /baseline
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        GetBaseline:
          Type: HttpApi
          Properties:
            Path: /baseline/{baseline_id}
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        ListBaselines:
          Type: HttpApi
          Properties:
            Path: /prefacturas/baselines
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  CatalogFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/catalog.ts
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: CatalogFn
    Properties:
      CodeUri: .
      Handler: catalog.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName:
              Ref: RubrosTable
        - DynamoDBReadPolicy:
            TableName:
              Ref: RubrosTaxonomiaTable
      Events:
        ListRubros:
          Type: HttpApi
          Properties:
            Path: /catalog/rubros
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: NONE

  LineItemsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/line-items.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: LineItemsFn
    Properties:
      CodeUri: .
      Handler: line-items.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName:
              Ref: RubrosTable
      Events:
        ListLineItems:
          Type: HttpApi
          Properties:
            Path: /line-items
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  AllocationRulesGet:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/allocationRules.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: AllocationRulesGet
    Properties:
      CodeUri: .
      Handler: allocationRules.handler
      Policies:
        - AWSLambdaBasicExecutionRole
      Environment:
        Variables:
          SKIP_AUTH:
            Ref: SkipAuth
      Events:
        GetAllocationRules:
          Type: HttpApi
          Properties:
            Path: /allocation-rules
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  HandoffFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/handoff.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: HandoffFn
    Properties:
      CodeUri: .
      Handler: handoff.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName:
              Ref: ProjectsTable
        - DynamoDBCrudPolicy:
            TableName:
              Ref: AuditTable
        - DynamoDBReadPolicy:
            TableName:
              Ref: PrefacturasTable
      Events:
        CreateHandoff:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/handoff
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        GetHandoff:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/handoff
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        UpdateHandoff:
          Type: HttpApi
          Properties:
            Path: /handoff/{handoffId}
            Method: PUT
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  UploadDocumentFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/upload-docs.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: UploadDocumentFunction
    Properties:
      CodeUri: .
      Handler: upload-docs.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName:
              Ref: DocsTable
        - Statement:
            - Effect: Allow
              Action:
                - s3:PutObject
                - s3:PutObjectAcl
                - s3:GetObject
              Resource:
                Fn::Sub: arn:aws:s3:::${DocsBucketName}/*
      Events:
        RequestUploadUrl:
          Type: HttpApi
          Properties:
            Path: /uploads/docs
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  AlertsPep3Fn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/health.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: AlertsPep3Fn
    Properties:
      CodeUri: .
      Handler: health.handler
      Policies:
        - AWSLambdaBasicExecutionRole

  RubrosFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/rubros.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: RubrosFn
    Properties:
      CodeUri: .
      Handler: rubros.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName:
              Ref: RubrosTable
        - DynamoDBCrudPolicy:
            TableName:
              Ref: AuditTable
      Events:
        AttachRubro:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/rubros
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        ListRubros:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/rubros
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        DetachRubro:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/rubros/{rubroId}
            Method: DELETE
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  BillingFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/billing.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: BillingFn
    Properties:
      CodeUri: .
      Handler: billing.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName:
              Ref: PrefacturasTable
      Events:
        GetBilling:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/billing
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  AllocationsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/allocations.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: AllocationsFn
    Properties:
      CodeUri: .
      Handler: allocations.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AllocationsTable
      - Fn::If:
        - HasPolicyStore
        - Version: "2012-10-17"
          Statement:
          - Sid: AllowAVPIsAuthorizedWithToken
            Effect: Allow
            Action:
            - verifiedpermissions:IsAuthorizedWithToken
            Resource:
              Fn::Sub: arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}
        - !Ref AWS::NoValue
      Events:
        ListAllocations:
          Type: HttpApi
          Properties:
            Path: /allocations
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        BulkAllocations:
          Type: HttpApi
          Properties:
            Path: /projects/{id}/allocations:bulk
            Method: PUT
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  PlanFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/plan.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: PlanFn
    Properties:
      CodeUri: .
      Handler: plan.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName:
              Ref: ProjectsTable
        - DynamoDBReadPolicy:
            TableName:
              Ref: AllocationsTable
        - DynamoDBReadPolicy:
            TableName:
              Ref: PayrollTable
        - DynamoDBReadPolicy:
            TableName:
              Ref: AdjustmentsTable
        - DynamoDBReadPolicy:
            TableName:
              Ref: RubrosTable
      Events:
        GetPlan:
          Type: HttpApi
          Properties:
            Path: /projects/{id}/plan
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  PayrollFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/payroll.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: PayrollFn
    Properties:
      CodeUri: .
      Handler: payroll.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName:
              Ref: PayrollTable
      Events:
        ListPayrollActuals:
          Type: HttpApi
          Properties:
            Path: /payroll/actuals
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        IngestPayroll:
          Type: HttpApi
          Properties:
            Path: /payroll/ingest
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  CloseMonthFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/close-month.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: CloseMonthFn
    Properties:
      CodeUri: .
      Handler: close-month.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: ProjectsTable
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AllocationsTable
      - Fn::If:
        - HasPolicyStore
        - Version: "2012-10-17"
          Statement:
          - Sid: AllowAVPIsAuthorizedWithToken
            Effect: Allow
            Action:
            - verifiedpermissions:IsAuthorizedWithToken
            Resource:
              Fn::Sub: arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}
        - !Ref AWS::NoValue
      Events:
        CloseMonth:
          Type: HttpApi
          Properties:
            Path: /close-month
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  ReconFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/recon.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: ReconFn
    Properties:
      CodeUri: .
      Handler: recon.handler
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        GetRecon:
          Type: HttpApi
          Properties:
            Path: /recon
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  AdjustmentsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/adjustments.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: AdjustmentsFn
    Properties:
      CodeUri: .
      Handler: adjustments.handler
      Policies:
      - AWSLambdaBasicExecutionRole
      - DynamoDBCrudPolicy:
          TableName:
            Ref: AdjustmentsTable
      - Fn::If:
        - HasPolicyStore
        - Version: "2012-10-17"
          Statement:
          - Sid: AllowAVPIsAuthorizedWithToken
            Effect: Allow
            Action:
            - verifiedpermissions:IsAuthorizedWithToken
            Resource:
              Fn::Sub: arn:aws:verifiedpermissions:${AWS::Region}:${AWS::AccountId}:policy-store/${PolicyStoreId}
        - !Ref AWS::NoValue
      Events:
        CreateAdjustment:
          Type: HttpApi
          Properties:
            Path: /adjustments
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        ListAdjustments:
          Type: HttpApi
          Properties:
            Path: /adjustments
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  AlertsFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/alerts.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: AlertsFn
    Properties:
      CodeUri: .
      Handler: alerts.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName:
              Ref: AlertsTable
      Events:
        GetAlerts:
          Type: HttpApi
          Properties:
            Path: /alerts
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  ProvidersFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/providers.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node18
      SamResourceId: ProvidersFn
    Properties:
      CodeUri: .
      Handler: providers.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName:
              Ref: ProvidersTable
      Events:
        CreateProvider:
          Type: HttpApi
          Properties:
            Path: /providers
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        ListProviders:
          Type: HttpApi
          Properties:
            Path: /providers
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  ForecastFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/forecast.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: ForecastFn
    Properties:
      CodeUri: .
      Handler: forecast.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBReadPolicy:
            TableName:
              Ref: ProjectsTable
        - DynamoDBReadPolicy:
            TableName:
              Ref: AllocationsTable
        - DynamoDBReadPolicy:
            TableName:
              Ref: PayrollTable
        - DynamoDBReadPolicy:
            TableName:
              Ref: AdjustmentsTable
        # Allow rubro queries when allocations are missing
        - DynamoDBReadPolicy:
            TableName:
              Ref: RubrosTable
      Events:
        GetForecast:
          Type: HttpApi
          Properties:
            Path: /plan/forecast
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  PrefacturasFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/prefacturas.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: PrefacturasFn
    Properties:
      CodeUri: .
      Handler: prefacturas.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName:
              Ref: PrefacturasTable
      Events:
        GetPrefacturas:
          Type: HttpApi
          Properties:
            Path: /prefacturas
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        PostPrefacturas:
          Type: HttpApi
          Properties:
            Path: /prefacturas
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  InvoicesFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/invoices/app.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: InvoicesFn
    Properties:
      CodeUri: .
      Handler: app.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName:
              Ref: PrefacturasTable
        - DynamoDBReadPolicy:
            TableName:
              Ref: RubrosTable
      Events:
        GetProjectInvoices:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/invoices
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        CreateProjectInvoice:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/invoices
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        GetProjectInvoiceById:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/invoices/{invoiceId}
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        UpdateProjectInvoiceStatus:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/invoices/{invoiceId}/status
            Method: PUT
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  ChangesFn:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        EntryPoints:
          - src/handlers/changes.ts
        External:
          - aws-sdk
        Minify: true
        Sourcemap: true
        Target: node20
      SamResourceId: ChangesFn
    Properties:
      CodeUri: .
      Handler: changes.handler
      Policies:
        - AWSLambdaBasicExecutionRole
        - DynamoDBCrudPolicy:
            TableName:
              Ref: ChangesTable
      Events:
        ListProjectChanges:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/changes
            Method: GET
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        CreateProjectChange:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/changes
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt
        UpdateProjectChangeApproval:
          Type: HttpApi
          Properties:
            Path: /projects/{projectId}/changes/{changeId}/approval
            Method: POST
            ApiId:
              Ref: Api
            Auth:
              Authorizer: CognitoJwt

  Pep3Rule:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: cron(0 8 1 * ? *)
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - AlertsPep3Fn
              - Arn
          Id: pep3-target
    Metadata:
      SamResourceId: Pep3Rule

  Pep3Permission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Ref: AlertsPep3Fn
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
          - Pep3Rule
          - Arn
    Metadata:
      SamResourceId: Pep3Permission

Outputs:
  FinzApiId:
    Description: HTTP API ID
    Value:
      Ref: Api
    Export:
      Name:
        Fn::Sub: finz-api-id-${StageName}
  FinzApiUrl:
    Description: HTTP API URL
    Value:
      Fn::Sub: https://${Api}.execute-api.${AWS::Region}.amazonaws.com/${StageName}
    Export:
      Name:
        Fn::Sub: finz-api-url-${StageName}
