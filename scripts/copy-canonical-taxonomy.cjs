#!/usr/bin/env node
/**
 * Copy Canonical Taxonomy Script
 * 
 * This script copies the canonical taxonomy from the client source (src/lib/rubros/canonical-taxonomy.ts)
 * to the server source (services/finanzas-api/src/lib/canonical-taxonomy.ts) to ensure both
 * client and server use the same canonical data.
 * 
 * This should be run as part of the build process before building the server.
 * 
 * Usage:
 *   node scripts/copy-canonical-taxonomy.js
 */

const fs = require('fs');
const path = require('path');

// Define paths
const rootDir = path.resolve(__dirname, '..');
const sourceFile = path.join(rootDir, 'src/lib/rubros/canonical-taxonomy.ts');
const targetFile = path.join(rootDir, 'services/finanzas-api/src/lib/canonical-taxonomy.ts');

// Validate source file exists
if (!fs.existsSync(sourceFile)) {
  console.error(`❌ Error: Source file not found at ${sourceFile}`);
  process.exit(1);
}

// Read source file
let sourceContent;
try {
  sourceContent = fs.readFileSync(sourceFile, 'utf8');
  console.log(`✓ Read source file from ${sourceFile}`);
} catch (error) {
  console.error(`❌ Error reading source file: ${error.message}`);
  process.exit(1);
}

// Ensure target directory exists
const targetDir = path.dirname(targetFile);
if (!fs.existsSync(targetDir)) {
  try {
    fs.mkdirSync(targetDir, { recursive: true });
    console.log(`✓ Created target directory ${targetDir}`);
  } catch (error) {
    console.error(`❌ Error creating target directory: ${error.message}`);
    process.exit(1);
  }
}

// Write to target file
try {
  // Add a header comment to indicate this is a generated file
  const header = `/**
 * GENERATED FILE - DO NOT EDIT DIRECTLY
 * 
 * This file is automatically generated from src/lib/rubros/canonical-taxonomy.ts
 * by the build script: scripts/copy-canonical-taxonomy.js
 * 
 * To update this file, modify src/lib/rubros/canonical-taxonomy.ts and run:
 *   node scripts/copy-canonical-taxonomy.js
 * 
 * Last updated: ${new Date().toISOString()}
 */

`;
  
  fs.writeFileSync(targetFile, header + sourceContent, 'utf8');
  console.log(`✓ Copied canonical taxonomy to ${targetFile}`);
} catch (error) {
  console.error(`❌ Error writing target file: ${error.message}`);
  process.exit(1);
}

// Verify the copy
try {
  const targetContent = fs.readFileSync(targetFile, 'utf8');
  if (targetContent.includes('CANONICAL_RUBROS_TAXONOMY') && 
      targetContent.includes('LEGACY_RUBRO_ID_MAP')) {
    console.log('✅ Canonical taxonomy copied successfully!');
    console.log(`   Source: ${sourceFile}`);
    console.log(`   Target: ${targetFile}`);
    process.exit(0);
  } else {
    console.error('❌ Error: Target file is missing expected exports');
    process.exit(1);
  }
} catch (error) {
  console.error(`❌ Error verifying target file: ${error.message}`);
  process.exit(1);
}
