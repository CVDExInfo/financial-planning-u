#!/usr/bin/env node
/**
 * Copy Canonical Taxonomy Script
 * 
 * This script copies the canonical taxonomy and normalization utilities from the client source
 * to the server source to ensure both client and server use the same canonical data.
 * 
 * Copies:
 *   - src/lib/rubros/canonical-taxonomy.ts → services/finanzas-api/src/lib/canonical-taxonomy.ts
 *   - src/lib/rubros/normalize-key.ts → services/finanzas-api/src/lib/normalize-key.ts
 * 
 * This should be run as part of the build process before building the server.
 * 
 * Usage:
 *   node scripts/copy-canonical-taxonomy.cjs
 */

const fs = require('fs');
const path = require('path');

// Define paths
const rootDir = path.resolve(__dirname, '..');

const filesToCopy = [
  {
    source: path.join(rootDir, 'src/lib/rubros/canonical-taxonomy.ts'),
    target: path.join(rootDir, 'services/finanzas-api/src/lib/canonical-taxonomy.ts'),
    name: 'canonical taxonomy'
  },
  {
    source: path.join(rootDir, 'src/lib/rubros/normalize-key.ts'),
    target: path.join(rootDir, 'services/finanzas-api/src/lib/normalize-key.ts'),
    name: 'normalize-key utility'
  }
];

let hasErrors = false;

filesToCopy.forEach(({ source, target, name }) => {
  // Validate source file exists
  if (!fs.existsSync(source)) {
    console.error(`❌ Error: Source file not found at ${source}`);
    hasErrors = true;
    return;
  }

  // Read source file
  let sourceContent;
  try {
    sourceContent = fs.readFileSync(source, 'utf8');
    console.log(`✓ Read ${name} from ${source}`);
  } catch (error) {
    console.error(`❌ Error reading ${name}: ${error.message}`);
    hasErrors = true;
    return;
  }

  // Ensure target directory exists
  const targetDir = path.dirname(target);
  if (!fs.existsSync(targetDir)) {
    try {
      fs.mkdirSync(targetDir, { recursive: true });
      console.log(`✓ Created target directory ${targetDir}`);
    } catch (error) {
      console.error(`❌ Error creating target directory: ${error.message}`);
      hasErrors = true;
      return;
    }
  }

  // Write to target file
  try {
    // Add a header comment to indicate this is a generated file
    const header = `/**
 * GENERATED FILE - DO NOT EDIT DIRECTLY
 * 
 * This file is automatically generated from ${source.replace(rootDir, '')}
 * by the build script: scripts/copy-canonical-taxonomy.cjs
 * 
 * To update this file, modify the source file and run:
 *   node scripts/copy-canonical-taxonomy.cjs
 * 
 * Last updated: ${new Date().toISOString()}
 */

`;
    
    fs.writeFileSync(target, header + sourceContent, 'utf8');
    console.log(`✓ Copied ${name} to ${target}`);
  } catch (error) {
    console.error(`❌ Error writing ${name}: ${error.message}`);
    hasErrors = true;
  }
});

if (hasErrors) {
  console.error('\n❌ Copy failed with errors');
  process.exit(1);
}

// Verify the copies
const canonicalTaxonomyTarget = path.join(rootDir, 'services/finanzas-api/src/lib/canonical-taxonomy.ts');
const normalizeKeyTarget = path.join(rootDir, 'services/finanzas-api/src/lib/normalize-key.ts');

try {
  const taxonomyContent = fs.readFileSync(canonicalTaxonomyTarget, 'utf8');
  const normalizeContent = fs.readFileSync(normalizeKeyTarget, 'utf8');
  
  if (taxonomyContent.includes('CANONICAL_RUBROS_TAXONOMY') && 
      taxonomyContent.includes('LEGACY_RUBRO_ID_MAP') &&
      normalizeContent.includes('normalizeKey')) {
    console.log('\n✅ All files copied successfully!');
    console.log(`   Canonical taxonomy: ${canonicalTaxonomyTarget}`);
    console.log(`   Normalize utility: ${normalizeKeyTarget}`);
    process.exit(0);
  } else {
    console.error('❌ Error: Target files are missing expected exports');
    process.exit(1);
  }
} catch (error) {
  console.error(`❌ Error verifying target files: ${error.message}`);
  process.exit(1);
}

