---
title: Financial Planning System - Data Flow & Lineage
description: End-to-end data flow for budget estimation and cost management
---

sequenceDiagram
    autonumber
    participant User as ðŸ‘¤ User (PMO/SDMT)
    participant UI as ðŸ–¥ï¸ React SPA
    participant API as ðŸšª API Gateway
    participant Auth as ðŸ” Cognito + AVP
    participant Lambda as âš™ï¸ Lambda Functions
    participant DDB as ðŸ’¾ DynamoDB
    participant S3 as ðŸ“¦ S3 Storage
    participant SharePoint as ðŸ”— SharePoint
    participant Events as ðŸ“§ SNS/EventBridge
    
    Note over User,Events: Budget Baseline Creation Flow
    
    User->>UI: Create Project Estimate
    UI->>API: POST /projects (JWT)
    API->>Auth: Validate Token & Permissions
    Auth-->>API: Authorized (PMO role)
    API->>Lambda: Invoke PMO Service
    Lambda->>DDB: PutItem Project
    Lambda->>DDB: PutItem BudgetBaseline (Draft)
    Lambda-->>API: Project Created
    API-->>UI: 201 Created with project_id
    
    Note over User,Events: Multi-step Estimator Wizard
    
    User->>UI: Input Labor Costs
    UI->>API: PUT /projects/{id}/baseline/labor
    API->>Lambda: Update Baseline
    Lambda->>DDB: UpdateItem BudgetBaseline
    Lambda->>DDB: PutItem AuditLog
    
    User->>UI: Input Non-Labor Costs
    UI->>API: PUT /projects/{id}/baseline/costs
    API->>Lambda: Update Baseline
    Lambda->>DDB: UpdateItem BudgetBaseline
    
    User->>UI: Sign & Finalize Baseline
    UI->>API: POST /projects/{id}/baseline/sign
    API->>Lambda: Generate Signature
    Lambda->>Lambda: Calculate Hash (SHA-256)
    Lambda->>DDB: UpdateItem BudgetBaseline (status=SIGNED)
    Lambda->>S3: Store PDF Export
    Lambda->>SharePoint: Upload via Graph API
    Lambda->>Events: Publish BudgetSigned Event
    Events->>Lambda: Trigger Notification Lambda
    Lambda->>DDB: Create Notification Records
    
    Note over User,Events: Forecast Management Flow
    
    User->>UI: View 60-Month Forecast Grid
    UI->>API: GET /projects/{id}/forecasts
    API->>Lambda: Query Forecasts
    Lambda->>DDB: Query ForecastAllocation (GSI: project+period)
    Lambda-->>UI: Return Grid Data
    
    User->>UI: Update Forecast Values
    UI->>API: PUT /projects/{id}/forecasts/batch
    API->>Lambda: Batch Update
    Lambda->>DDB: BatchWriteItem ForecastAllocation
    Lambda->>Lambda: Calculate Variances
    Lambda->>DDB: UpdateItem CashFlowProjection
    Lambda->>Events: Publish VarianceAlert (if threshold exceeded)
    
    Note over User,Events: Invoice Reconciliation Flow
    
    User->>UI: Upload Invoice (PDF/Image)
    UI->>S3: PutObject (presigned URL)
    S3-->>UI: Upload Complete
    UI->>API: POST /invoices (metadata + s3_key)
    API->>Lambda: Process Invoice
    Lambda->>DDB: PutItem Invoice
    Lambda->>Lambda: ML Matching Algorithm
    Lambda->>DDB: Query ForecastAllocation (unmatched)
    Lambda->>DDB: UpdateItem Invoice (matched_allocation_id)
    Lambda->>DDB: UpdateItem ForecastAllocation (amount_actual)
    Lambda->>Events: Publish InvoiceMatched Event
    
    Note over User,Events: Analytics & Reporting
    
    User->>UI: View Cash Flow Analysis
    UI->>API: GET /projects/{id}/analytics/cashflow
    API->>Lambda: Calculate Analytics
    Lambda->>DDB: Scan ForecastAllocation (last 60 periods)
    Lambda->>Lambda: Aggregate by Period
    Lambda->>DDB: Query Invoice (actual costs)
    Lambda->>Lambda: Calculate Margins & Projections
    Lambda-->>UI: Return Chart Data
    
    User->>UI: Export to Excel
    UI->>API: POST /exports (type=EXCEL)
    API->>Lambda: Generate Export
    Lambda->>DDB: Query Project + Forecasts + Invoices
    Lambda->>Lambda: Build Excel with Formulas
    Lambda->>S3: Store Excel File
    Lambda->>SharePoint: Upload via Graph API (optional)
    Lambda-->>UI: Return Download URL
