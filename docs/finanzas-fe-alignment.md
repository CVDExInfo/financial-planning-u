# Finanzas FE ↔ API ↔ Cedar Alignment

Triangulation of the primary frontend callers against the real API Gateway contract (`m3g6am67aj`, stage `dev`) and the current Cedar policy (`hhKNjToeFMfEtGyLuUjg6`). File references point to the React workspace under `src/`.

| FE Function (file)                                                | FE Call (method & path)                      | OAS Route                             | Cedar Action Present? | Notes                                                                                                                                    |
| ----------------------------------------------------------------- | -------------------------------------------- | ------------------------------------- | --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| `ApiService.getProjects` (`src/lib/api.ts`)                       | `GET /projects`                              | `GET /projects`                       | ✅ `get /projects`    | Fully aligned.                                                                                                                           |
| `ApiService.createBaseline` (`src/lib/api.ts`)                    | `POST /baseline`                             | `POST /baseline`                      | ❌                    | Route exists but Cedar is missing `post /baseline`, so FIN users receive 403.                                                            |
| `ApiService.getBaseline` (`src/lib/api.ts`)                       | `GET /baseline/{id}`                         | `GET /baseline/{baseline_id}`         | ❌                    | Backend path matches but Cedar lacks `get /baseline/{...}` allowing only mock fallbacks.                                                 |
| `ApiService.getBillingPlan` (`src/lib/api.ts`)                    | `GET /projects/{projectId}/billing`          | `GET /projects/{projectId}/billing`   | ❌                    | Policy only lists `get /projects`/`plan`; billing path is absent, causing AVP denial.                                                    |
| `ApiService.handoffBaseline` (`src/lib/api.ts`)                   | `POST /projects/{projectId}/handoff`         | `POST /projects/{projectId}/handoff`  | ❌                    | Cedar action uses literal `/projects/{id}/handoff`; mismatch blocks FIN group even though Lambda exists.                                 |
| `ApiService.getLineItems` (`src/lib/api.ts`)                      | `GET /projects/{projectId}/rubros`           | `GET /projects/{projectId}/rubros`    | ❌                    | Cedar only knows `/projects/{id}/rubros`; UI calls are rejected.                                                                         |
| `ApiService.getInvoices` (`src/lib/api.ts`)                       | `GET /prefacturas?projectId=...`             | `GET /prefacturas`                    | ❌                    | Route is secured but policy lacks `get /prefacturas`. Query param is ignored by API (expects filter in body), leading to 403/empty data. |
| `ApiService.updateInvoiceStatus` (`src/lib/api.ts`)               | `PUT /invoices/{invoice_id}/status`          | —                                     | —                     | No such route in OAS; any call will 404 before AVP.                                                                                      |
| `finanzasClient.createProject` (`src/api/finanzasClient.ts`)      | `POST /projects`                             | `POST /projects`                      | ✅ `post /projects`   | Works when Cognito token present.                                                                                                        |
| `finanzasClient.saveAllocations` (`src/api/finanzasClient.ts`)    | `PUT /projects/{projectId}/allocations:bulk` | `PUT /projects/{id}/allocations:bulk` | ✅                    | Path placeholder differs but expands to same literal runtime path, so Cedar action hits.                                                 |
| `finanzasClient.createProjectRubro` (`src/api/finanzasClient.ts`) | `POST /projects/{projectId}/rubros`          | `POST /projects/{projectId}/rubros`   | ❌                    | Cedar only allows `/projects/{id}/rubros`; FIN group blocked.                                                                            |
| `uploadInvoice` (`src/api/finanzas.ts`)                           | `POST /prefacturas`                          | `POST /prefacturas`                   | ❌                    | Lambda exists but Cedar lacks `post /prefacturas`, so uploads fail with 403.                                                             |
| `presignUpload` (`src/api/finanzas.ts`)                           | `POST /uploads/docs`                         | `POST /uploads/docs`                  | ❌                    | No Cedar action, so document upload presign step is denied.                                                                              |
| `finanzasClient.health` (`src/api/finanzasClient.ts`)             | `GET /health`                                | `GET /health`                         | ✅                    | Route is public; Cedar entry redundant but harmless.                                                                                     |

Additional mismatches spotted:

- `src/config/api.ts` still points helper endpoints such as `projectById`, `billingByProject`, and `rubros` at legacy REST patterns (`/projects/{id}`, `/billing?project_id=`) that no longer exist in the exported OAS. Any code path that uses these helpers will 404 regardless of Cedar.
- Several frontend flows (prefactura list/upload, baseline read/write, billing plan, rubros CRUD, handoff) currently have **zero** Cedar coverage even though the Lambdas are wired and the API contract is correct. This is the primary reason FIN users see `403`/`Failed to fetch` despite the Cognito JWT being valid.
