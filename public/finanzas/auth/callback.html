<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Authenticating…</title>
    <meta name="robots" content="noindex" />
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 40px;
        color: #222;
      }
      .box {
        max-width: 500px;
        margin: auto;
        padding: 24px;
        border: 1px solid #ddd;
        border-radius: 12px;
      }
      code {
        background: #f6f6f6;
        padding: 2px 4px;
        border-radius: 4px;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="box">
      <h1>Signing you in…</h1>
      <p id="status">Processing identity token.</p>
      <p style="font-size: 12px">
        If you are not redirected automatically, choose:
        <a href="/finanzas/" id="finzLink">Finanzas</a> |
        <a href="/" id="pmoLink">PMO</a>
      </p>
      <script>
        (function () {
          function fail(msg) {
            document.getElementById("status").textContent = msg;
          }
          
          // Check for authorization code in URL query params (code flow)
          const urlParams = new URLSearchParams(location.search);
          const authCode = urlParams.get("code");

          if (authCode) {
            // Authorization code flow detected, but token exchange is not yet implemented
            console.warn(
              "[Callback] Authorization code received, but code → token exchange is not implemented yet. " +
                "Check VITE_COGNITO_DOMAIN and response_type configuration in src/config/aws.ts"
            );
            fail(
              "Authorization code flow is not yet supported. " +
                "Please ensure response_type is set to 'token' in aws.ts configuration."
            );
            return;
          }

          // Extract tokens from implicit flow hash (#id_token=...&access_token=...)
          const rawHash = window.location.hash || "";
          const hash = rawHash.startsWith("#") ? rawHash.slice(1) : rawHash;
          const params = new URLSearchParams(hash);
          const idToken = params.get("id_token");
          const accessToken = params.get("access_token");

          // Cognito implicit flow uses response_type=token.
          // With scope including "openid", Cognito returns both id_token and access_token
          // in the URL hash (#id_token=...&access_token=...).
          // If id_token is missing here, check:
          // - App client has Implicit grant enabled in Cognito.
          // - Hosted UI URL is using response_type=token && scope includes "openid".
          if (!idToken) {
            console.error("[Callback] Missing id_token. Hash received:", hash);
            fail("No id_token present. Check Cognito OAuth configuration.");
            return;
          }
          
          // Lightweight JWT payload decode
          function decodeJWT(t) {
            try {
              const p = t.split(".")[1];
              return JSON.parse(atob(p.replace(/-/g, "+").replace(/_/g, "/")));
            } catch (e) {
              return {};
            }
          }
          
          const claims = decodeJWT(idToken);
          
          // Persist unified token (multiple keys for compatibility)
          localStorage.setItem("cv.jwt", idToken);
          localStorage.setItem("finz_jwt", idToken);
          localStorage.setItem("idToken", idToken);
          localStorage.setItem("cognitoIdToken", idToken);
          if (accessToken) {
            localStorage.setItem("finz_access_token", accessToken);
          }
          
          // Extract user groups from token claims
          const groupsRaw = claims["cognito:groups"] || claims["groups"] || [];
          const groups = Array.isArray(groupsRaw)
            ? groupsRaw
            : groupsRaw
                .toString()
                .split(",")
                .map((s) => s.trim())
                .filter(Boolean);
          
          // Determine user's module access based on groups
          const canSDT = groups.some((g) =>
            ["SDT", "FIN", "AUD", "sdmt", "fin", "aud"].includes(g.toUpperCase())
          );
          const canPMO = groups.some((g) =>
            ["PM", "PMO", "EXEC_RO", "VENDOR", "admin", "pmo"].includes(g.toUpperCase())
          );
          
          // Preference resolution for dual-role users
          const pref = localStorage.getItem("cv.module");
          let target;
          
          if (canSDT && !canPMO) {
            target = "/finanzas/";
          } else if (canPMO && !canSDT) {
            target = "/";
          } else if (canSDT && canPMO) {
            // Both roles - use preference or default to Finanzas
            if (pref === "pmo" && canPMO) {
              target = "/";
            } else if (pref === "finanzas" && canSDT) {
              target = "/finanzas/";
            } else {
              // Default bias to Finanzas for dual-role users
              target = "/finanzas/";
            }
          } else {
            // No recognized groups - default to Finanzas
            target = "/finanzas/";
          }
          
          document.getElementById("status").textContent = "Redirecting…";
          setTimeout(() => {
            location.replace(target);
          }, 50);
        })();
      </script>
    </div>
  </body>
</html>
