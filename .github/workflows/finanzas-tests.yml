name: Finanzas SD – Smoke Tests

on:
  # Manual trigger from the Actions tab
  workflow_dispatch:

  # Auto-run when FE/API/tests for Finanzas change
  push:
    branches:
      - main
      - develop
      - finz/**
    paths:
      - "services/finanzas-api/**"
      - "src/**"
      - "tests/finanzas/**"
      - "docs/EVIDENCE_FINZ.md"
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "services/finanzas-api/**"
      - "src/**"
      - "tests/finanzas/**"

jobs:
  finanzas-smoke:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
    
      # Use existing DEV API URL (dev stage only)
      FINZ_API_BASE: ${{ vars.DEV_API_URL }}
    
      # Derive UI base from CF_DOMAIN
      FINZ_UI_BASE: https://${{ vars.CF_DOMAIN }}/finanzas
    
      # Cognito tester credentials
      COGNITO_TESTER_USERNAME: ${{ vars.COGNITO_TESTER_USERNAME }}
      COGNITO_TESTER_PASSWORD: ${{ vars.COGNITO_TESTER_PASSWORD }}
    
      # Cognito config
      COGNITO_USER_POOL_ID: ${{ vars.COGNITO_USER_POOL_ID }}
      COGNITO_WEB_CLIENT: ${{ vars.COGNITO_WEB_CLIENT }}
    
      FINZ_LOG_DIR: /tmp/finanzas-tests

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure test scripts are executable
        run: |
          chmod +x tests/finanzas/**/run-*.sh || true

      - name: Show env summary (no secrets)
        run: |
          echo "FINZ_API_BASE=$FINZ_API_BASE" >> "$GITHUB_STEP_SUMMARY"
          echo "FINZ_UI_BASE=$FINZ_UI_BASE" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

      - name: Cognito login smoke test
        run: |
          echo "## Cognito Login Test" >> "$GITHUB_STEP_SUMMARY"
          chmod +x tests/finanzas/shared/run-login-test.sh
          bash tests/finanzas/shared/run-login-test.sh | tee -a "$GITHUB_STEP_SUMMARY"

      - name: URL sanity check
        shell: bash
        run: |
          set -euo pipefail
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## URL Sanity Check" >> "$GITHUB_STEP_SUMMARY"
          bash tests/finanzas/shared/run-url-sanity.sh | tee -a "$GITHUB_STEP_SUMMARY"
          test ${PIPESTATUS[0]} -eq 0

      - name: Projects – /projects list
        shell: bash
        run: |
          set -euo pipefail
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Projects – run-projects-tests.sh" >> "$GITHUB_STEP_SUMMARY"
          bash tests/finanzas/projects/run-projects-tests.sh | tee -a "$GITHUB_STEP_SUMMARY"
          test ${PIPESTATUS[0]} -eq 0

      - name: Catalog – line items & POST rubro
        shell: bash
        run: |
          set -euo pipefail
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Catalog – run-catalog-tests.sh" >> "$GITHUB_STEP_SUMMARY"
          bash tests/finanzas/catalog/run-catalog-tests.sh | tee -a "$GITHUB_STEP_SUMMARY"
          test ${PIPESTATUS[0]} -eq 0

      - name: Forecast – /plan/forecast checks
        shell: bash
        run: |
          set -euo pipefail
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Forecast – run-forecast-tests.sh" >> "$GITHUB_STEP_SUMMARY"
          bash tests/finanzas/forecast/run-forecast-tests.sh | tee -a "$GITHUB_STEP_SUMMARY"
          test ${PIPESTATUS[0]} -eq 0

      - name: Reconciliation – /prefacturas & forecast
        shell: bash
        run: |
          set -euo pipefail
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Reconciliation – run-reconciliation-tests.sh" >> "$GITHUB_STEP_SUMMARY"
          bash tests/finanzas/reconciliation/run-reconciliation-tests.sh | tee -a "$GITHUB_STEP_SUMMARY"
          test ${PIPESTATUS[0]} -eq 0

      - name: Changes – adjustments
        shell: bash
        run: |
          set -euo pipefail
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Changes – run-changes-tests.sh" >> "$GITHUB_STEP_SUMMARY"
          bash tests/finanzas/changes/run-changes-tests.sh | tee -a "$GITHUB_STEP_SUMMARY"
          test ${PIPESTATUS[0]} -eq 0

      - name: Handoff – create/read
        shell: bash
        run: |
          set -euo pipefail
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## Handoff – run-handoff-tests.sh" >> "$GITHUB_STEP_SUMMARY"
          bash tests/finanzas/handoff/run-handoff-tests.sh | tee -a "$GITHUB_STEP_SUMMARY"
          test ${PIPESTATUS[0]} -eq 0
