name: Docs (Build + Package)

on:
  workflow_dispatch:
  push:
    branches: [ main, develop, docs/** ]
    paths:
      - 'docs/**'
      - 'diagrams/**'
      - 'scripts/docs/**'
      - '.github/workflows/docs-build.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'diagrams/**'
      - 'scripts/docs/**'
      - '.github/workflows/docs-build.yml'

jobs:
  build-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # OIDC available if ever needed; not used in this job
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- OPTIONAL: DEBUG SCAN (non-failing) ---
      # Shows any Pre-Factura references but does not fail the job.
      # Keep this while cleaning up, then remove or comment out if you prefer.
      - name: DEBUG scan (does not fail)
        run: |
          set -euo pipefail
          DIRS=()
          [ -d docs ] && DIRS+=(docs)
          [ -d diagrams ] && DIRS+=(diagrams)
          [ -d scripts ] && DIRS+=(scripts)
          if [ ${#DIRS[@]} -eq 0 ]; then
            echo "No docs/diagrams/scripts directories to scan."
            exit 0
          fi
          echo "DEBUG: scanning for Pre-Factura references in: ${DIRS[*]}"
          grep -RniE 'Pre-?Fact(ura)?|acta-ui-pre-factura' \
            --binary-files=without-match \
            --exclude-dir .git \
            --exclude-dir dist \
            --exclude-dir node_modules \
            --exclude '*.png' --exclude '*.jpg' --exclude '*.jpeg' \
            --exclude '*.svg' --exclude '*.pdf' --exclude '*.zip' \
            --exclude '*.fig' --exclude '*.lucid' --exclude '*.drawio' \
            "${DIRS[@]}" || true

      # --- ENFORCING SCOPE CHECK (failing if there are matches) ---
      - name: Verify repo scope (Finanzas-only)
        run: |
          set -euo pipefail
          DIRS=()
          [ -d docs ] && DIRS+=(docs)
          [ -d diagrams ] && DIRS+=(diagrams)
          if [ ${#DIRS[@]} -eq 0 ]; then
            echo "No docs/diagrams directories to scan."
            exit 0
          fi
      
          if grep -RniE 'Pre-?Fact(ura)?|acta-ui-pre-factura' \
               --binary-files=without-match \
               --exclude-dir .git \
               --exclude-dir dist \
               --exclude-dir node_modules \
               --include '*.md' \
               --include '*.mdx' \
               --include '*.mmd' \
               --include '*.svg' \
               --include '*.drawio' \
               --include '*.yaml' --include '*.yml' \
               --include '*.json' \
               "${DIRS[@]}" > /tmp/prefact_matches.txt 2>/dev/null
          then
            echo "::error ::Pre-Factura references found in Repo A content files. Please purge them."
            echo "----- Matches -----"
            cat /tmp/prefact_matches.txt
            echo "-------------------"
            exit 1
          else
            echo "OK: No Pre-Factura references found in docs/diagrams."
          fi
          
      - name: Setup Node (for Mermaid CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Mermaid CLI
        run: |
          set -euo pipefail
          npm i -g @mermaid-js/mermaid-cli@10

      - name: Prepare export scripts
        run: |
          set -euo pipefail
          chmod +x scripts/docs/export.sh scripts/docs/package.sh

      - name: Render diagrams + Export docs (HTML/PDF) + Package
        run: |
          set -euo pipefail
          scripts/docs/export.sh
          scripts/docs/package.sh

      - name: Upload dist bundle
        uses: actions/upload-artifact@v4
        with:
          name: finanzas-docs-bundle
          path: |
            dist/package-*-docs.zip
            dist/docs/**
            diagrams/**
            docs/**
            dist/checks/**
          if-no-files-found: error
