name: Pre-merge preflight checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  preflight:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Ensure required secrets/env present
        shell: bash
        env:
          API_BASE: ${{ secrets.API_BASE }}
          API_TOKEN: ${{ secrets.API_TOKEN }}
          BASELINE_ID: ${{ secrets.BASELINE_ID }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          CLOUDWATCH_LOG_GROUP: ${{ secrets.CLOUDWATCH_LOG_GROUP }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          set -euo pipefail
          echo "Validating required environment variables are set..."
          missing=false
          for s in API_BASE API_TOKEN BASELINE_ID PROJECT_ID AWS_REGION CLOUDWATCH_LOG_GROUP AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY; do
            val="${!s}"
            if [ -z "$val" ]; then
              echo "::error::Required env/secret $s is not set or empty"
              missing=true
            else
              echo "Found $s"
            fi
          done
          if [ "$missing" = true ]; then
            echo "::error::One or more required secrets are missing. Please set repository secrets and re-run the workflow."
            exit 1
          fi

      - name: Ensure pnpm is available
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking for pnpm..."
          if command -v pnpm >/dev/null 2>&1; then
            echo "pnpm already available: $(pnpm -v)"
          else
            echo "pnpm not found â€” attempting corepack enable + prepare"
            # try corepack (node 18+)
            if command -v corepack >/dev/null 2>&1; then
              corepack enable || true
              corepack prepare pnpm@latest --activate || true
            fi

            # If pnpm still not available, install globally via npm as fallback
            if ! command -v pnpm >/dev/null 2>&1; then
              echo "Falling back to npm install -g pnpm@latest"
              npm install -g pnpm@latest
            fi

            # Final verification
            if command -v pnpm >/dev/null 2>&1; then
              echo "pnpm installed: $(pnpm -v)"
            else
              echo "::error::pnpm installation failed; please ensure the runner can install global npm packages or adjust workflow"
              exit 1
            fi
          fi

      - name: Diagnostic: Node / pnpm versions
        shell: bash
        run: |
          set -euo pipefail
          echo "node: $(node -v)"
          echo "npm: $(npm -v)"
          if command -v pnpm >/dev/null 2>&1; then pnpm -v; else echo "pnpm: not found"; fi

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          pnpm install --frozen-lockfile

      - name: Run pre-merge checks
        shell: bash
        env:
          CI: true
          VITE_FINZ_ENABLED: "true"
          VITE_API_BASE_URL: "https://pyorjw6lbe.execute-api.us-east-2.amazonaws.com/dev"
        run: |
          set -euo pipefail
          if [ -f ./scripts/pre_merge_checks.sh ]; then
            chmod +x ./scripts/pre_merge_checks.sh
            ./scripts/pre_merge_checks.sh
          else
            echo "Pre-merge checks script not found, skipping..."
          fi
