name: Pre-merge preflight checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  BASELINE_ID: "base_5c62d927a71b"
  PROJECT_ID: "P-7e4fbaf2-dc12-4b22-a75e-1b8bed96a4c7"
  AWS_REGION: ${{ secrets.AWS_REGION }}
  CLOUDWATCH_LOG_GROUP: ${{ secrets.CLOUDWATCH_LOG_GROUP }}
  # prefer VITE_API_BASE_URL if present
  API_BASE: ${{ secrets.VITE_API_BASE_URL || secrets.API_BASE }}

jobs:
  preflight:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Validate Cognito credentials + fetch API token
        shell: bash
        env:
          COGNITO_USER: ${{ vars.COGNITO_TESTER_USERNAME }}
          COGNITO_PASS: ${{ vars.COGNITO_TESTER_PASSWORD }}
          COGNITO_CLIENT: ${{ vars.COGNITO_WEB_CLIENT }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          set -euo pipefail
          echo "Validating Cognito tester credentials..."
          missing=false
          for v in COGNITO_USER COGNITO_PASS COGNITO_CLIENT; do
            if [ -z "${!v}" ]; then
              echo "::error::Required env variable $v is not set"
              missing=true
            else
              echo "Found $v"
            fi
          done
          if [ "$missing" = true ]; then
            echo "::error::Add Cognito tester credentials (COGNITO_TESTER_USERNAME, COGNITO_TESTER_PASSWORD, COGNITO_WEB_CLIENT) to repository environment variables."
            exit 1
          fi

          # Use AWS CLI to authenticate via Cognito USER_PASSWORD_AUTH
          echo "Requesting Cognito token via aws cli..."
          auth=$(aws cognito-idp initiate-auth \
            --region "${AWS_REGION}" \
            --client-id "${COGNITO_CLIENT}" \
            --auth-flow USER_PASSWORD_AUTH \
            --auth-parameters "USERNAME=${COGNITO_USER},PASSWORD=${COGNITO_PASS}" \
            --output json) || { echo "::error::Cognito auth failed"; echo "$auth"; exit 1; }

          token=$(echo "$auth" | jq -r '.AuthenticationResult.AccessToken // empty')
          if [ -z "$token" ]; then
            echo "::error::Failed to extract AccessToken from Cognito response"
            echo "$auth"
            exit 1
          fi

          echo "Cognito token fetched (masked): ****"
          # export for subsequent steps
          echo "API_TOKEN=${token}" >> $GITHUB_ENV

      - name: Ensure required AWS secrets present
        shell: bash
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          CLOUDWATCH_LOG_GROUP: ${{ secrets.CLOUDWATCH_LOG_GROUP }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          set -euo pipefail
          echo "Validating required AWS environment variables are set..."
          missing=false
          for s in AWS_REGION CLOUDWATCH_LOG_GROUP AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY; do
            val="${!s}"
            if [ -z "$val" ]; then
              echo "::error::Required env/secret $s is not set or empty"
              missing=true
            else
              echo "Found $s"
            fi
          done
          if [ "$missing" = true ]; then
            echo "::error::One or more required AWS secrets are missing. Please set repository secrets and re-run the workflow."
            exit 1
          fi
          
          # Verify hardcoded values are set
          echo "Verifying hardcoded BASELINE_ID and PROJECT_ID..."
          if [ -z "$BASELINE_ID" ] || [ -z "$PROJECT_ID" ]; then
            echo "::error::BASELINE_ID or PROJECT_ID not set in workflow env"
            exit 1
          fi
          echo "BASELINE_ID: $BASELINE_ID"
          echo "PROJECT_ID: $PROJECT_ID"
          
          # Verify API_BASE is set
          if [ -z "$API_BASE" ]; then
            echo "::error::API_BASE not set (requires VITE_API_BASE_URL or API_BASE secret)"
            exit 1
          fi
          echo "API_BASE: $API_BASE"

      - name: Ensure pnpm is available
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking for pnpm..."
          if command -v pnpm >/dev/null 2>&1; then
            echo "pnpm already available: $(pnpm -v)"
          else
            echo "pnpm not found — attempting corepack enable + prepare"
            # try corepack (node 18+)
            if command -v corepack >/dev/null 2>&1; then
              corepack enable || true
              corepack prepare pnpm@latest --activate || true
            fi

            # If pnpm still not available, install globally via npm as fallback
            if ! command -v pnpm >/dev/null 2>&1; then
              echo "Falling back to npm install -g pnpm@latest"
              npm install -g pnpm@latest
            fi

            # Final verification
            if command -v pnpm >/dev/null 2>&1; then
              echo "pnpm installed: $(pnpm -v)"
            else
              echo "::error::pnpm installation failed; please ensure the runner can install global npm packages or adjust workflow"
              exit 1
            fi
          fi

      - name: "Diagnostic: Node / pnpm versions"
        shell: bash
        run: |
          set -euo pipefail
          echo "node: $(node -v)"
          echo "npm: $(npm -v)"
          if command -v pnpm >/dev/null 2>&1; then echo "pnpm: $(pnpm -v)"; else echo "pnpm: not found"; fi

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          pnpm install --frozen-lockfile

      - name: Run pre-merge checks
        shell: bash
        env:
          CI: true
          VITE_FINZ_ENABLED: "true"
          VITE_API_BASE_URL: "https://pyorjw6lbe.execute-api.us-east-2.amazonaws.com/dev"
        run: |
          set -euo pipefail
          if [ -f ./scripts/pre_merge_checks.sh ]; then
            chmod +x ./scripts/pre_merge_checks.sh
            ./scripts/pre_merge_checks.sh
          else
            echo "Pre-merge checks script not found, skipping..."
          fi

      - name: Run finanzas-api unit tests
        shell: bash
        working-directory: ./services/finanzas-api
        run: |
          set -euo pipefail
          echo "Running finanzas-api unit tests..."
          pnpm test 2>&1 | tee ../../ci_tests_output.txt
          echo "✅ Unit tests completed"

      - name: Run preflight allocations smoke test
        shell: bash
        env:
          COGNITO_TESTER_USERNAME: ${{ vars.COGNITO_TESTER_USERNAME }}
          COGNITO_TESTER_PASSWORD: ${{ vars.COGNITO_TESTER_PASSWORD }}
          COGNITO_WEB_CLIENT: ${{ vars.COGNITO_WEB_CLIENT }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          API_BASE: ${{ secrets.VITE_API_BASE_URL || secrets.API_BASE }}
          BASELINE_ID: ${{ env.BASELINE_ID }}
          PROJECT_ID: ${{ env.PROJECT_ID }}
          ARTIFACTS_DIR: ./preflight-artifacts
        run: |
          set -euo pipefail
          echo "Running preflight allocations smoke test..."
          node services/finanzas-api/scripts/preflight-allocations.js
          echo "✅ Preflight smoke test completed"

      - name: Upload preflight artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preflight-artifacts
          path: |
            preflight-artifacts/
            ci_tests_output.txt
          retention-days: 30

      - name: Summary
        if: always()
        shell: bash
        run: |
          echo "================================================================================"
          echo "PREFLIGHT CHECKS SUMMARY"
          echo "================================================================================"
          if [ -f preflight-artifacts/preflight_summary.txt ]; then
            cat preflight-artifacts/preflight_summary.txt
          fi
          echo "================================================================================"
          echo "Artifacts uploaded. Check workflow artifacts for detailed results."

