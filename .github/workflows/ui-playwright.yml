name: UI Playwright Tests (Behavioral)

on:
  workflow_dispatch:
    inputs:
      ui_base_url:
        description: "UI Base URL (optional override)"
        required: false
        type: string
        default: "https://d7t9x3j66yd8k.cloudfront.net/finanzas"
  schedule:
    # Run nightly at 2 AM UTC
    - cron: "0 2 * * *"

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  playwright-ui-tests:
    name: Playwright UI Behavioral Tests
    runs-on: ubuntu-latest

    env:
      # AWS Configuration
      AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}

      # UI Configuration
      FINZ_UI_BASE_URL: ${{ inputs.ui_base_url || vars.FINZ_UI_BASE_URL || 'https://d7t9x3j66yd8k.cloudfront.net/finanzas' }}

      # Cognito Configuration
      COGNITO_USER_POOL_ID: ${{ vars.COGNITO_USER_POOL_ID || 'us-east-2_FyHLtOhiY' }}
      COGNITO_WEB_CLIENT: ${{ vars.COGNITO_WEB_CLIENT || 'dshos5iou44tuach7ta3ici5m' }}
      COGNITO_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}

      # Role-based Test Credentials (from secrets)
      E2E_PMO_EMAIL: ${{ secrets.E2E_PMO_EMAIL }}
      E2E_PMO_PASSWORD: ${{ secrets.E2E_PMO_PASSWORD }}
      E2E_SDM_FIN_EMAIL: ${{ secrets.E2E_SDM_FIN_EMAIL || secrets.E2E_SDMT_EMAIL }}
      E2E_SDM_FIN_PASSWORD: ${{ secrets.E2E_SDM_FIN_PASSWORD || secrets.E2E_SDMT_PASSWORD }}
      E2E_SDMT_EMAIL: ${{ secrets.E2E_SDMT_EMAIL }}
      E2E_SDMT_PASSWORD: ${{ secrets.E2E_SDMT_PASSWORD }}
      E2E_EXEC_EMAIL: ${{ secrets.E2E_EXEC_EMAIL }}
      E2E_EXEC_PASSWORD: ${{ secrets.E2E_EXEC_PASSWORD }}
      E2E_NO_GROUP_EMAIL: ${{ secrets.E2E_NO_GROUP_EMAIL }}
      E2E_NO_GROUP_PASSWORD: ${{ secrets.E2E_NO_GROUP_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Validate configuration
        run: |
          set -euo pipefail
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Configuration Validation"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Sanitize URL
          FINZ_UI_BASE_URL="$(printf '%s' "$FINZ_UI_BASE_URL" | tr -d '\r\n' | sed 's:/*$::')"
          
          # Export cleaned value
          echo "FINZ_UI_BASE_URL=${FINZ_UI_BASE_URL}" >> $GITHUB_ENV
          
          echo "âœ“ UI Base URL:        ${FINZ_UI_BASE_URL}"
          echo "âœ“ AWS Region:         ${AWS_REGION}"
          echo "âœ“ Cognito Pool ID:    ${COGNITO_USER_POOL_ID}"
          echo "âœ“ Cognito Client ID:  ${COGNITO_WEB_CLIENT}"
          echo ""
          
          # Check which role credentials are configured
          echo "Role Credentials Status:"
          [[ -n "${E2E_PMO_EMAIL:-}" ]] && echo "  âœ“ PMO" || echo "  âš ï¸  PMO (not configured)"
          [[ -n "${E2E_SDM_FIN_EMAIL:-}" ]] && echo "  âœ“ SDM_FIN" || echo "  âš ï¸  SDM_FIN (not configured)"
          [[ -n "${E2E_SDMT_EMAIL:-}" ]] && echo "  âœ“ SDMT" || echo "  âš ï¸  SDMT (not configured)"
          [[ -n "${E2E_EXEC_EMAIL:-}" ]] && echo "  âœ“ EXEC_RO" || echo "  âš ï¸  EXEC_RO (not configured)"
          [[ -n "${E2E_NO_GROUP_EMAIL:-}" ]] && echo "  âœ“ NO_GROUP" || echo "  âš ï¸  NO_GROUP (not configured - SECURITY TEST)"
          echo ""

      - name: Run Playwright UI Tests
        id: playwright-tests
        run: |
          set -euo pipefail
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Running Playwright UI Behavioral Tests"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Run the UI test suite
          npm run test:ui
          
          # Capture exit code
          TEST_EXIT_CODE=$?
          
          echo "TEST_EXIT_CODE=${TEST_EXIT_CODE}" >> $GITHUB_OUTPUT
          
          exit $TEST_EXIT_CODE

      - name: Generate Test Summary
        if: always()
        run: |
          set +e  # Don't fail on errors in summary generation
          
          {
            echo "## ðŸŽ­ Playwright UI Test Results"
            echo ""
            echo "**Configuration:**"
            echo "- UI Base URL: \`${FINZ_UI_BASE_URL}\`"
            echo "- AWS Region: \`${AWS_REGION}\`"
            echo ""
            
            if [[ "${{ steps.playwright-tests.outcome }}" == "success" ]]; then
              echo "### âœ… All UI Tests Passed"
              echo ""
              echo "**Test Coverage:**"
              echo "- âœ… Routing/RBAC: Role-based route visibility"
              echo "- âœ… NO_GROUP: Security validation for users without groups"
              echo "- âœ… Data States: Empty vs populated data handling"
              echo "- âœ… Charts: Meaningful visualizations validation"
              echo ""
              echo "**Key Validations:**"
              echo "- Users with no groups are denied access"
              echo "- SDMT users see appropriate routes"
              echo "- EXEC_RO users have read-only access"
              echo "- Empty states are clearly shown"
              echo "- Charts don't show misleading empty visuals"
            else
              echo "### âŒ UI Tests Failed"
              echo ""
              echo "Some UI tests failed. Please review the Playwright report artifact for details."
              echo ""
              echo "**Common failure causes:**"
              echo "- Missing role credentials"
              echo "- UI routes changed or renamed"
              echo "- Role-based routing logic changed"
              echo "- Empty state components missing"
            fi
            
            echo ""
            echo "### ðŸ” Security Validation"
            if [[ -n "${E2E_NO_GROUP_EMAIL:-}" ]]; then
              echo "- âœ… NO_GROUP user tested (UI prevents unauthorized access)"
            else
              echo "- âš ï¸  NO_GROUP user NOT tested (missing credentials)"
              echo "  - **IMPORTANT:** Configure E2E_NO_GROUP_EMAIL/PASSWORD"
            fi
            
            echo ""
            echo "### ðŸ“Š Report"
            echo "- Download the Playwright HTML report artifact for detailed results"
            echo "- Report includes screenshots and traces for failures"
            
            echo ""
            echo "### ðŸ“š Next Steps"
            if [[ "${{ steps.playwright-tests.outcome }}" != "success" ]]; then
              echo "1. Download and review the Playwright report"
              echo "2. Check screenshots/videos of failed tests"
              echo "3. Verify role credentials are correct"
              echo "4. Test manually with the failing role"
            else
              echo "- All UI behavioral validations passed"
              echo "- Role-based routing working correctly"
              echo "- Empty states properly implemented"
            fi
          } >> $GITHUB_STEP_SUMMARY

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore
