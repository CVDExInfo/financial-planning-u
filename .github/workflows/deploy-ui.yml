name: Deploy UIs (PMO + Finanzas)

on:
  workflow_dispatch: {}
  push:
    branches:
      - r1-finanzas-dev-wiring
      - main

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}
  DEPLOYMENT_ENV: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
  PMO_BUCKET_NAME: ${{ github.ref == 'refs/heads/main' && (vars.PMO_BUCKET_NAME_PROD || 'acta-ui-frontend-prod') || vars.PMO_BUCKET_NAME_DEV }}
  FINANZAS_BUCKET_NAME: ${{ github.ref == 'refs/heads/main' && (vars.FINANZAS_BUCKET_NAME_PROD || 'ukusi-ui-finanzas-prod') || vars.FINANZAS_BUCKET_NAME_DEV }}
  CLOUDFRONT_DIST_ID: ${{ github.ref == 'refs/heads/main' && (vars.CLOUDFRONT_DIST_ID_PROD || 'EPQU7PVDLQXUA') || vars.CLOUDFRONT_DIST_ID_DEV }}
  CF_DOMAIN: ${{ vars.CF_DOMAIN || '' }}
  FINZ_API_ID: ${{ github.ref == 'refs/heads/main' && vars.FINZ_API_ID_PROD || vars.FINZ_API_ID_DEV }}
  FINZ_API_STAGE: ${{ github.ref == 'refs/heads/main' && (vars.FINZ_API_STAGE_PROD || 'prod') || (vars.FINZ_API_STAGE_DEV || 'dev') }}
  EXPECTED_API_ID: ${{ github.ref == 'refs/heads/main' && vars.FINZ_API_ID_PROD || vars.FINZ_API_ID_DEV }}
  DEV_API_URL: ${{ vars.DEV_API_URL || '' }}
  VITE_FINZ_ENABLED: ${{ vars.VITE_FINZ_ENABLED || 'true' }}
  VITE_USE_MOCKS: "false"

jobs:
  build-and-deploy-all:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 1) Preflight
      - name: Preflight env
        run: |
          set -euo pipefail
          echo "ðŸš€ Deployment Environment: ${DEPLOYMENT_ENV}"
          for k in AWS_REGION PMO_BUCKET_NAME FINANZAS_BUCKET_NAME CLOUDFRONT_DIST_ID FINZ_API_ID FINZ_API_STAGE; do
            v="${!k:-}"; [ -n "$v" ] || { echo "âŒ Missing repo var: $k"; exit 1; }
          done
          printf '%s\n' "VITE_USE_MOCKS=false" >> "$GITHUB_ENV"
          sed -i 's/\r$//' "$GITHUB_ENV"
          echo "âœ… Env OK"

      # 2) Ensure correct Node + jq
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install deps
        run: |
          set -e
          if ! npm ci; then
            npm install
          fi

      # 3) Compute API base URL
      - name: Compute API base URL
        id: apibase
        run: |
          set -euo pipefail
          if [ -z "${DEV_API_URL}" ]; then
            DEFAULT_URL="https://${FINZ_API_ID}.execute-api.${AWS_REGION}.amazonaws.com/${FINZ_API_STAGE}"
            printf '%s\n' "VITE_API_BASE_URL=$DEFAULT_URL" >> "$GITHUB_ENV"
            echo "Using constructed API endpoint: $DEFAULT_URL"
          else
            CLEAN_URL="${DEV_API_URL%/}"
            printf '%s\n' "VITE_API_BASE_URL=$CLEAN_URL" >> "$GITHUB_ENV"
            echo "Using explicit API endpoint override: $CLEAN_URL"
          fi
          sed -i 's/\r$//' "$GITHUB_ENV"

      # 4) Build PMO (base: /)
      - name: Build PMO Portal (base: /)
        run: |
          echo "Building PMO Portal (base: /)..."
          BUILD_TARGET=pmo npm run build || { echo "âŒ PMO build failed"; exit 1; }
          test -d dist-pmo || { echo "âŒ PMO build missing dist-pmo/"; exit 1; }
          echo "âœ… PMO Portal built â†’ dist-pmo/"

      # 5) Build Finanzas (base: /finanzas/)
      - name: Build Finanzas SDT Portal (base: /finanzas/)
        env:
          VITE_API_BASE_URL: ${{ env.VITE_API_BASE_URL }}
          VITE_FINZ_ENABLED: "true"
          VITE_USE_MOCKS: "false"
          VITE_PUBLIC_BASE: "/finanzas/"
        run: |
          set -euo pipefail
          printf '%s\n' "VITE_PUBLIC_BASE=/finanzas/" >> "$GITHUB_ENV"
          printf '%s\n' "VITE_FINZ_ENABLED=true" >> "$GITHUB_ENV"
          printf '%s\n' "VITE_USE_MOCKS=false" >> "$GITHUB_ENV"
          printf '%s\n' "VITE_AWS_REGION=${AWS_REGION}" >> "$GITHUB_ENV"
          sed -i 's/\r$//' "$GITHUB_ENV"
          echo "Building Finanzas SDT Portal (base: /finanzas/)..."
          echo "  API Base URL: ${VITE_API_BASE_URL}"
          BUILD_TARGET=finanzas npm run build || { echo "âŒ Finanzas build failed"; exit 1; }
          test -d dist-finanzas || { echo "âŒ Finanzas build missing dist-finanzas/"; exit 1; }
          echo "âœ… Finanzas Portal built â†’ dist-finanzas/"

      # 6) Configure AWS (OIDC) â€“ and guard we are NOT a user/
      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: deploy-ui-${{ github.run_id }}

      - name: Verify identity (must be assumed-role)
        run: |
          ARN=$(aws sts get-caller-identity --query Arn --output text)
          echo "Caller: $ARN"
          echo "$ARN" | grep -q 'assumed-role/' || { echo "âŒ Not using assumed role"; exit 1; }

      # 7) Guards: S3 & CF exist
      - name: Guard - S3 buckets and CloudFront exist
        run: |
          set -euo pipefail
          aws s3api head-bucket --bucket "${PMO_BUCKET_NAME}" >/dev/null || { echo "âŒ Missing PMO bucket ${PMO_BUCKET_NAME}"; exit 1; }
          aws s3api head-bucket --bucket "${FINANZAS_BUCKET_NAME}" >/dev/null || { echo "âŒ Missing Finanzas bucket ${FINANZAS_BUCKET_NAME}"; exit 1; }
          aws cloudfront get-distribution --id "${CLOUDFRONT_DIST_ID}" >/dev/null || { echo "âŒ Missing CloudFront distribution ${CLOUDFRONT_DIST_ID}"; exit 1; }
          echo "âœ… Buckets & CloudFront found"

      # 8) Guard: API endpoint health
      - name: Guard - API endpoint present (VITE_API_BASE_URL)
        run: |
          set -euo pipefail
          : ${VITE_API_BASE_URL:?VITE_API_BASE_URL missing}
          BASE="${VITE_API_BASE_URL%/}"
          HOST_ID=$(echo "$BASE" | awk -F'[/.]' '{print $3}')
          : ${EXPECTED_API_ID:?EXPECTED_API_ID missing}
          if [ "$HOST_ID" != "$EXPECTED_API_ID" ]; then
            echo "âŒ Expected API id ${EXPECTED_API_ID}, got ${HOST_ID}"; exit 1;
          fi
          CODE=$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || true)
          if [ "$CODE" != "200" ]; then
            echo "âŒ /health returned $CODE â€” check stage deployment"; exit 1;
          fi
          echo "âœ… API endpoint ID and /health verified: $BASE"

      # 9) Guard: Finanzas build artifacts
      - name: Guard - Finanzas build artifacts
        run: |
          set -euo pipefail
          grep -R -nE 'src="/assets/|href="/assets/' dist-finanzas/index.html && { echo "âŒ index points to /assets/*"; exit 1; } || true
          ! grep -R -i 'github\.dev\|codespaces' dist-finanzas/ 2>/dev/null || { echo "âŒ Build contains dev references"; exit 1; }
          echo "âœ… Finanzas build artifacts look good"

      # 10) Upload PMO (/)
      - name: Upload PMO Portal to S3 (root /)
        run: |
          aws s3 sync dist-pmo/ "s3://${PMO_BUCKET_NAME}/" --exclude '*.map' --delete
          echo "âœ… PMO uploaded: s3://${PMO_BUCKET_NAME}/"

      # 11) Upload Finanzas (/finanzas)
      - name: Upload Finanzas Portal to S3 (/finanzas prefix)
        run: |
          aws s3 sync dist-finanzas/ "s3://${FINANZAS_BUCKET_NAME}/finanzas/" --exclude '*.map' --delete
          echo "âœ… Finanzas uploaded: s3://${FINANZAS_BUCKET_NAME}/finanzas/"

      # 12) Guard: Verify CloudFront behaviors for Finanzas
      - name: Guard - Verify CloudFront Finanzas behaviors
        run: |
          set -euo pipefail
          CFG=$(aws cloudfront get-distribution-config --id "${CLOUDFRONT_DIST_ID}")
          F1=$(echo "$CFG" | jq -r '.DistributionConfig.CacheBehaviors.Items[] | select(.PathPattern=="/finanzas/*") | .TargetOriginId')
          F2=$(echo "$CFG" | jq -r '.DistributionConfig.CacheBehaviors.Items[] | select(.PathPattern=="/finanzas/") | .TargetOriginId')
          F3=$(echo "$CFG" | jq -r '.DistributionConfig.CacheBehaviors.Items[] | select(.PathPattern=="/finanzas") | .TargetOriginId')
          test -n "$F1" || { echo "âŒ Missing behavior /finanzas/*"; exit 1; }
          test -n "$F2" || { echo "âŒ Missing behavior /finanzas/"; exit 1; }
          test -n "$F3" || { echo "âŒ Missing behavior /finanzas"; exit 1; }
          echo "âœ… Finanzas behaviors present (/finanzas, /finanzas/, /finanzas/*)"

      # 13) Invalidate CloudFront
      - name: Invalidate CloudFront (all + Finanzas SPA)
        run: |
          set -euo pipefail
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id "${CLOUDFRONT_DIST_ID}" \
            --paths '/*' '/finanzas/*' '/finanzas/index.html' \
            --query 'Invalidation.Id' --output text)
          echo "âœ… Invalidation queued: $INVALIDATION_ID"

      # 14) UI smokes
      - name: UI Smoke (PMO root /)
        run: |
          set -euo pipefail
          DOMAIN="${CF_DOMAIN:-$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)}"
          ROOT="https://${DOMAIN}/"
          STATUS=$(curl -sS -o /dev/null -w '%{http_code}' "$ROOT")
          echo "PMO / status: $STATUS"
          [ "$STATUS" = "200" ] || { echo "âŒ PMO root not accessible"; exit 1; }

      - name: UI Smoke (Finanzas /finanzas and /finanzas/)
        run: |
          set -euo pipefail
          DOMAIN="${CF_DOMAIN:-$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)}"
          for P in "/finanzas" "/finanzas/"; do
            URL="https://${DOMAIN}${P}"
            STATUS=$(curl -sS -o /dev/null -w '%{http_code}' "$URL")
            echo "$P status: $STATUS"
            [ "$STATUS" = "200" ] || { echo "âŒ $P not accessible"; exit 1; }
          done
          HTML_SNIPPET=$(curl -sS "https://${DOMAIN}/finanzas/" | head -n 60)
          echo "$HTML_SNIPPET" | grep -q "/finanzas/assets/" || { echo "âš ï¸ HTML missing /finanzas/assets references"; }

      # 15) API smokes
      - name: API Smokes (public /health, /catalog/rubros)
        run: |
          set -euo pipefail
          : ${VITE_API_BASE_URL:?VITE_API_BASE_URL missing}
          BASE="${VITE_API_BASE_URL%/}"
          CODE=$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || true)
          [ "$CODE" = "200" ] || { echo "âŒ /health returned $CODE"; exit 1; }
          LEN=$(curl -sS "$BASE/catalog/rubros" | jq '.data | length' || echo "0")
          echo "Catalog items: $LEN"
          [ "$LEN" != "0" ] || echo "âš ï¸ catalog/rubros length is 0 (seed missing?)"

      # 16) Summary
      - name: Summary & Evidence Pack
        if: always()
        run: |
          set -euo pipefail
          DOMAIN="${CF_DOMAIN:-$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)}"
          cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          # ðŸš€ Finanzas UI Deployment â€” $DEPLOYMENT_ENV

          ## ðŸ“Š Build Targets
          - PMO â†’ dist-pmo/ (root /)
          - Finanzas â†’ dist-finanzas/ (/finanzas/)

          ## âš™ï¸ Environment
          - AWS_REGION: $AWS_REGION
          - FINZ_API_ID: $FINZ_API_ID
          - FINZ_API_STAGE: $FINZ_API_STAGE
          - VITE_API_BASE_URL: $VITE_API_BASE_URL

          ## â˜ï¸ AWS
          - PMO Bucket: $PMO_BUCKET_NAME
          - Finanzas Bucket: $FINANZAS_BUCKET_NAME
          - CloudFront ID: $CLOUDFRONT_DIST_ID
          - CloudFront Domain: $DOMAIN

          ## ðŸŒ Access
          - PMO: https://$DOMAIN/
          - Finanzas: https://$DOMAIN/finanzas/
          EOF
