name: Deploy Finanzas UI

on:
  workflow_dispatch: {}
  push:
    branches:
      - r1-finanzas-dev-wiring
      - main

permissions:
  id-token: write
  contents: write

# --------- GLOBAL ENV (branch-aware) ----------
env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}

  # Branch ‚Üí environment
  DEPLOYMENT_ENV: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}

  # S3 bucket for Finanzas (PMO is deployed by acta-ui repo)
  FINANZAS_BUCKET_NAME: ${{ vars.FINANZAS_BUCKET_NAME || 'ukusi-ui-finanzas-prod' }}

  # CloudFront (single distribution)
  CLOUDFRONT_DIST_ID: ${{ vars.CLOUDFRONT_DIST_ID || 'EPQU7PVDLQXUA' }}
  CF_DOMAIN: ${{ vars.CF_DOMAIN || 'd7t9x3j66yd8k.cloudfront.net' }}

  # API ID / Stage (ID from vars, stage by branch)
  FINZ_API_ID: ${{ vars.FINZ_API_ID || 'm3g6am67aj' }}
  FINZ_API_STAGE: ${{ github.ref == 'refs/heads/main' && (vars.FINZ_API_STAGE_PROD || 'prod') || (vars.FINZ_API_STAGE_DEV || 'dev') }}
  EXPECTED_API_ID: ${{ vars.FINZ_API_ID || 'm3g6am67aj' }}

  # Optional escape hatch: explicit API base (if set, overrides derived)
  DEV_API_URL: ${{ vars.DEV_API_URL || '' }}

  # Frontend feature flags
  VITE_FINZ_ENABLED: ${{ vars.VITE_FINZ_ENABLED || 'true' }}
  VITE_USE_MOCKS: "false"

jobs:
  build-and-deploy-all:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ---- Preflight guards (fail fast with clear messages) ----
      - name: Preflight env
        run: |
          set -euo pipefail
          echo "üöÄ Deployment Environment: ${DEPLOYMENT_ENV}"
          for k in AWS_REGION FINANZAS_BUCKET_NAME CLOUDFRONT_DIST_ID FINZ_API_ID FINZ_API_STAGE; do
            v="${!k:-}"; [ -n "$v" ] || { echo "‚ùå Missing repo var: $k"; exit 1; }
          done
          printf '%s\n' "VITE_USE_MOCKS=false" >> "$GITHUB_ENV"
          sed -i 's/\r$//' "$GITHUB_ENV"
          echo "‚úÖ Env OK"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: |
          set -e
          echo "Installing frontend dependencies (prefer lock; fallback to install)"
          if ! npm ci; then
            echo "‚ö†Ô∏è npm ci failed; running npm install"
            npm install
          fi

      # ---- Compute the API base URL for the build (from ID + stage unless DEV_API_URL override) ----
      - name: Validate & compute API base URL
        id: apibase
        run: |
          set -euo pipefail
          if [ -z "${DEV_API_URL}" ]; then
            DEFAULT_URL="https://${FINZ_API_ID}.execute-api.${AWS_REGION}.amazonaws.com/${FINZ_API_STAGE}"
            printf '%s\n' "VITE_API_BASE_URL=$DEFAULT_URL" >> "$GITHUB_ENV"
            echo "Using constructed API endpoint: $DEFAULT_URL"
          else
            if [ "${DEPLOYMENT_ENV}" = "prod" ]; then
              echo "‚ùå DEV_API_URL override is not allowed for prod deployments" >&2
              exit 1
            fi
            CLEAN_URL="${DEV_API_URL%%\?*}"
            CLEAN_URL="${CLEAN_URL%%#*}"
            CLEAN_URL="${CLEAN_URL%/}"
            if [[ -z "$CLEAN_URL" ]]; then
              echo "‚ùå DEV_API_URL is unexpectedly empty after trimming" >&2
              exit 1
            fi
            if [[ "$CLEAN_URL" != https://* ]]; then
              echo "‚ùå DEV_API_URL must start with https://" >&2
              exit 1
            fi

            HOST_WITH_PATH="${CLEAN_URL#https://}"
            HOST="${HOST_WITH_PATH%%/*}"
            STAGE_PATH="${HOST_WITH_PATH#*/}"
            if [[ "$HOST_WITH_PATH" == "$HOST" ]]; then
              echo "‚ùå DEV_API_URL must include the stage path (e.g., /dev)" >&2
              exit 1
            fi
            if [[ "$STAGE_PATH" == *"/"* ]]; then
              echo "‚ùå DEV_API_URL must point to the stage root only (no resource suffix)" >&2
              exit 1
            fi

            EXPECTED_HOST="${EXPECTED_API_ID}.execute-api.${AWS_REGION}.amazonaws.com"
            if [[ -z "$EXPECTED_API_ID" || "$HOST" != "$EXPECTED_HOST" ]]; then
              echo "‚ùå DEV_API_URL host must match ${EXPECTED_HOST}, got ${HOST:-<empty>}" >&2
              exit 1
            fi

            if [[ "$STAGE_PATH" != "$FINZ_API_STAGE" ]]; then
              echo "‚ùå DEV_API_URL stage '$STAGE_PATH' does not match FINZ_API_STAGE '$FINZ_API_STAGE'" >&2
              exit 1
            fi

            printf '%s\n' "VITE_API_BASE_URL=https://${HOST}/${STAGE_PATH}" >> "$GITHUB_ENV"
            echo "Using explicit API endpoint override: https://${HOST}/${STAGE_PATH}"
          fi
          sed -i 's/\r$//' "$GITHUB_ENV"

      # ---- Build Finanzas (/finanzas) ----
      - name: Preflight API health (build input)
        run: |
          set -euo pipefail
          : ${VITE_API_BASE_URL:?VITE_API_BASE_URL missing after compute step}
          BASE="${VITE_API_BASE_URL%/}"
          echo "Checking ${BASE}/health before build..."
          STATUS=$(curl -sS -o /dev/null -w '%{http_code}' "${BASE}/health" || true)
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå API /health preflight failed with HTTP $STATUS" >&2
            exit 1
          fi
          echo "‚úÖ API /health preflight ok"

      - name: Build Finanzas SDT Portal (base /finanzas/)
        env:
          VITE_API_BASE_URL: ${{ env.VITE_API_BASE_URL }}
          VITE_FINZ_ENABLED: "true"
          VITE_USE_MOCKS: ${{ env.VITE_USE_MOCKS }}
          VITE_PUBLIC_BASE: "/finanzas/"
        run: |
          set -euo pipefail
          : ${VITE_API_BASE_URL:?VITE_API_BASE_URL missing}
          printf '%s\n' "VITE_PUBLIC_BASE=/finanzas/" >> "$GITHUB_ENV"
          printf '%s\n' "VITE_FINZ_ENABLED=true" >> "$GITHUB_ENV"
          printf '%s\n' "VITE_USE_MOCKS=false" >> "$GITHUB_ENV"
          printf '%s\n' "VITE_AWS_REGION=${AWS_REGION}" >> "$GITHUB_ENV"
          sed -i 's/\r$//' "$GITHUB_ENV"

          echo "Building Finanzas SDT Portal (base: /finanzas/)..."
          echo "  Environment: ${DEPLOYMENT_ENV}"
          echo "  API Base URL: ${VITE_API_BASE_URL}"
          BUILD_TARGET=finanzas npm run build || { echo "‚ùå Finanzas build failed"; exit 1; }
          echo "‚úÖ Finanzas Portal built ‚Üí dist-finanzas/"

      # ---- Configure AWS via OIDC (must be before any aws CLI) ----
      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: deploy-ui-${{ github.run_id }}

      - name: Verify identity
        run: aws sts get-caller-identity

      # ---- Guards: S3 & CF exist ----
      - name: Guard - S3 buckets and CloudFront exist
        run: |
          set -euo pipefail
          aws s3api head-bucket --bucket "${FINANZAS_BUCKET_NAME}" >/dev/null || { echo "‚ùå Missing Finanzas bucket ${FINANZAS_BUCKET_NAME}"; exit 1; }
          aws cloudfront get-distribution --id "${CLOUDFRONT_DIST_ID}" >/dev/null || { echo "‚ùå Missing CloudFront distribution ${CLOUDFRONT_DIST_ID}"; exit 1; }
          echo "‚úÖ Buckets & CloudFront found"

      # ---- Guard: API host ID & /health for the same URL we inject in UI ----
      - name: Guard - API endpoint present (VITE_API_BASE_URL)
        run: |
          set -euo pipefail
          : ${VITE_API_BASE_URL:?VITE_API_BASE_URL missing}
          BASE="${VITE_API_BASE_URL%/}"
          HOST_ID=$(echo "$BASE" | awk -F'[/.]' '{print $3}')
          : ${EXPECTED_API_ID:?EXPECTED_API_ID missing}
          if [ "$HOST_ID" != "$EXPECTED_API_ID" ]; then
            echo "‚ùå Expected API id ${EXPECTED_API_ID}, got ${HOST_ID}"; exit 1;
          fi
          CODE=$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || true)
          if [ "$CODE" != "200" ]; then
            echo "‚ùå /health returned $CODE ‚Äî check stage deployment"; exit 1;
          fi
          echo "‚úÖ API endpoint ID and /health verified: $BASE"

      # ---- Build artifact validation ----
      - name: Guard - Finanzas build artifacts
        run: |
          set -euo pipefail
          if grep -R -nE 'src="/assets/|href="/assets/' dist-finanzas/index.html; then
            echo "‚ùå dist-finanzas/index.html points to /assets/* (missing base '/finanzas/')"; exit 1;
          fi
          if grep -R -i 'github\.dev\|codespaces' dist-finanzas/ 2>/dev/null; then
            echo "‚ùå Build contains github.dev/codespaces references"; exit 1;
          fi
          # PR #126: Ensure aws-exports.js is NOT in Finanzas (PMO/Amplify only)
          if find dist-finanzas -name "aws-exports.js" -o -name "aws-exports.ts" | grep -q .; then
            echo "‚ùå CRITICAL: aws-exports.js found in Finanzas build!"; 
            echo "   aws-exports.js is a PMO/Amplify concern and should NOT be in Finanzas";
            exit 1;
          fi
          echo "‚úÖ Finanzas build artifacts look good"

      # ---- Upload Finanzas (/finanzas) ----
      - name: Upload Finanzas Portal to S3 (/finanzas prefix)
        run: |
          aws s3 sync dist-finanzas/ "s3://${FINANZAS_BUCKET_NAME}/finanzas/" --exclude '*.map' --delete
          echo "‚úÖ Finanzas uploaded to s3://${FINANZAS_BUCKET_NAME}/finanzas/"

      # ---- CF behavior check for /finanzas/* ----
      - name: Guard - Verify CloudFront /finanzas/* Behavior (CRITICAL)
        run: |
          set -euo pipefail
          BEHAVIOR_COUNT=$(aws cloudfront get-distribution-config \
            --id "${CLOUDFRONT_DIST_ID}" \
            --query 'DistributionConfig.CacheBehaviors.Items[?PathPattern==`/finanzas/*`] | length(@)' \
            --output text)
          if [ "$BEHAVIOR_COUNT" != "1" ]; then
            echo "‚ùå CRITICAL: /finanzas/* behavior missing in CloudFront ${CLOUDFRONT_DIST_ID}"; exit 1;
          fi
          echo "‚úÖ /finanzas/* behavior configured"

      # ---- CloudFront Function Association Check (PR #126) ----
      - name: Guard - Verify CloudFront Function Association (CRITICAL for SPA)
        run: |
          set -euo pipefail
          echo "üîç Verifying CloudFront Function associations for Finanzas behaviors..."
          
          # Get distribution config
          DIST_CONFIG=$(aws cloudfront get-distribution-config --id "${CLOUDFRONT_DIST_ID}" --output json)
          
          # Check for Finanzas function existence
          FUNCTIONS=$(aws cloudfront list-functions --stage LIVE --output json)
          FINANZAS_FUNCTION=$(echo "$FUNCTIONS" | jq -r '.FunctionList.Items[] | select(.Name | contains("finanzas") or contains("path-rewrite")) | .Name' | head -1)
          
          if [ -z "$FINANZAS_FUNCTION" ]; then
            echo "‚ö†Ô∏è  WARNING: No Finanzas CloudFront Function found"
            echo "   Expected: finanzas-path-rewrite or similar"
            echo "   Impact: Deep links (e.g., /finanzas/catalog/rubros) may 404"
            echo "   This is not a blocker but should be fixed manually in CloudFront console"
          else
            echo "‚úÖ Found CloudFront Function: $FINANZAS_FUNCTION"
            
            # Verify function associations on key behaviors
            for PATTERN in "/finanzas" "/finanzas/" "/finanzas/*"; do
              FUNC_ASSOC=$(echo "$DIST_CONFIG" | jq -r ".DistributionConfig.CacheBehaviors.Items[]? | select(.PathPattern == \"$PATTERN\") | .FunctionAssociations.Items[]? | select(.EventType == \"viewer-request\") | .FunctionARN // \"\"" 2>/dev/null || echo "")
              
              if [ -n "$FUNC_ASSOC" ] && echo "$FUNC_ASSOC" | grep -qi "finanzas\|path-rewrite"; then
                echo "‚úÖ $PATTERN ‚Üí Function attached at viewer-request"
              else
                echo "‚ö†Ô∏è  WARNING: $PATTERN ‚Üí NO function attached or wrong function"
                echo "   Expected: $FINANZAS_FUNCTION at viewer-request"
                echo "   This should be fixed manually in CloudFront console to enable SPA deep links"
              fi
            done
          fi
          
          # Check OriginPath is empty (critical for correct S3 routing)
          echo ""
          echo "üîç Verifying Finanzas origin OriginPath..."
          ORIGIN_PATH=$(echo "$DIST_CONFIG" | jq -r '.DistributionConfig.Origins.Items[] | select(.DomainName | contains("finanzas")) | .OriginPath // ""' | head -1)
          
          if [ -z "$ORIGIN_PATH" ]; then
            echo "‚úÖ Finanzas origin OriginPath is empty (correct)"
          else
            echo "‚ùå CRITICAL: Finanzas origin has OriginPath='$ORIGIN_PATH'"
            echo "   Expected: empty string"
            echo "   This will cause incorrect S3 path lookups!"
            exit 1
          fi

      # ---- Invalidate CF caches ----
      - name: Invalidate CloudFront (all + Finanzas SPA)
        run: |
          set -euo pipefail
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id "${CLOUDFRONT_DIST_ID}" \
            --paths '/*' '/finanzas/*' '/finanzas/index.html' \
            --query 'Invalidation.Id' --output text)
          echo "‚úÖ Invalidation queued: $INVALIDATION_ID"

      # ---- UI smoke: Finanzas ----
      - name: UI Smoke (Finanzas /finanzas/)
        run: |
          set -euo pipefail
          DOMAIN="${CF_DOMAIN}"
          if [ -z "$DOMAIN" ]; then
            DOMAIN=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
          fi
          FINZ="https://${DOMAIN}/finanzas/"
          STATUS=$(curl -sS -o /dev/null -w '%{http_code}' "$FINZ")
          echo "Finanzas /finanzas/ status: $STATUS"
          if [ "$STATUS" = "200" ]; then
            HTML_SNIPPET=$(curl -sS "$FINZ" | head -n 40)
            echo "$HTML_SNIPPET" | grep -q "/finanzas/assets/" || { echo "‚ö†Ô∏è HTML missing /finanzas/assets references"; }
          else
            echo "‚ùå Finanzas portal not accessible (HTTP $STATUS)"; exit 1;
          fi

      # ---- API smokes (use VITE_API_BASE_URL) ----
      - name: API Smokes (public /health, /catalog/rubros)
        run: |
          set -euo pipefail
          : ${VITE_API_BASE_URL:?VITE_API_BASE_URL missing}
          BASE="${VITE_API_BASE_URL%/}"
          echo "API base: $BASE"
          CODE=$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || true)
          [ "$CODE" = "200" ] || { echo "‚ùå /health returned $CODE"; exit 1; }
          LEN=$(curl -sS "$BASE/catalog/rubros" | jq '.data | length' || echo "0")
          echo "Catalog items: $LEN"
          [ "$LEN" != "0" ] || echo "‚ö†Ô∏è catalog/rubros length is 0 (seed missing?)"

      # ---- Summary (always runs; heredoc to avoid brace errors) ----
      - name: Summary & Evidence Pack
        if: always()
        run: |
          set -euo pipefail
          DOMAIN="${CF_DOMAIN}"
          if [ -z "$DOMAIN" ]; then
            DOMAIN=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
          fi
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # üöÄ Finanzas UI Deployment ‚Äî ${DEPLOYMENT_ENV}

          ## üìä Build Target
          - Finanzas ‚Üí dist-finanzas/ (/finanzas/)

          ## ‚öôÔ∏è Environment
          - AWS_REGION: ${AWS_REGION}
          - FINZ_API_ID: ${FINZ_API_ID}
          - FINZ_API_STAGE: ${FINZ_API_STAGE}
          - VITE_API_BASE_URL: ${VITE_API_BASE_URL}

          ## ‚òÅÔ∏è AWS
          - Finanzas Bucket: ${FINANZAS_BUCKET_NAME}
          - CloudFront ID: ${CLOUDFRONT_DIST_ID}
          - CloudFront Domain: ${DOMAIN}

          ## üåê Access
          - Finanzas: https://${DOMAIN}/finanzas/

          ## ‚úÖ Checklist
          - Base path OK (/finanzas/)
          - /finanzas/* behavior exists
          - /health returns 200
          - catalog/rubros returns JSON (length shown above)

          EOF
