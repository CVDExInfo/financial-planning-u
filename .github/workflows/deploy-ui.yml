name: Deploy Finanzas UI (dev)

on:
  workflow_dispatch: {}
  push:
    branches: ["r1-finanzas-dev-wiring"]

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}
  S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
  CLOUDFRONT_DIST_ID: ${{ vars.CLOUDFRONT_DIST_ID }}
  FINZ_API_STACK: ${{ vars.FINZ_API_STACK || 'finanzas-sd-api-dev' }}
  DEV_API_URL: ${{ vars.DEV_API_URL || '' }}
  VITE_FINZ_ENABLED: ${{ vars.VITE_FINZ_ENABLED || 'true' }}
  VITE_USE_MOCKS: "false"

jobs:
  deploy-ui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Preflight env
        run: |
          set -euo pipefail
          for k in S3_BUCKET_NAME CLOUDFRONT_DIST_ID; do
            v="${!k:-}"; [ -n "$v" ] || { echo "❌ Missing repo var: $k"; exit 1; }
          done
          echo "VITE_USE_MOCKS=false" >> $GITHUB_ENV
          echo "✅ Env OK"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: |
          set -e
          echo "Installing frontend dependencies (prefer lock, fallback to dynamic)"
          if ! npm ci; then
            echo "npm ci failed (likely lock mismatch). Falling back to npm install."
            npm install
          fi

      - name: Build UI
        env:
          VITE_API_BASE_URL: ${{ env.VITE_API_BASE_URL }}
          VITE_FINZ_ENABLED: ${{ env.VITE_FINZ_ENABLED }}
          VITE_USE_MOCKS: ${{ env.VITE_USE_MOCKS }}
        run: |
          echo "Using VITE_API_BASE_URL=$VITE_API_BASE_URL"
          echo "Using VITE_FINZ_ENABLED=$VITE_FINZ_ENABLED"
          echo "Using VITE_USE_MOCKS=$VITE_USE_MOCKS"
          npm run build || { echo "❌ UI build failed"; exit 1; }

      - name: Configure AWS (OIDC)
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: deploy-ui-${{ github.run_id }}

      - name: Verify identity
        run: aws sts get-caller-identity

      - name: Resolve API URL from CloudFormation
        run: |
          set -euo pipefail
          API_URL=$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" \
            --query "Stacks[0].Outputs[?OutputKey=='FinzApiUrl'].OutputValue" --output text)
          if [ -z "${API_URL}" ] || [ "${API_URL}" = "None" ]; then
            echo "❌ Could not resolve API URL from stack ${FINZ_API_STACK}"; exit 1;
          fi
          CLEAN_URL=$(echo "$API_URL" | sed 's:/*$::')
          echo "DEV_API_URL=${CLEAN_URL}" >> $GITHUB_ENV
          echo "VITE_API_BASE_URL=${CLEAN_URL}" >> $GITHUB_ENV
          echo "Resolved API URL: ${CLEAN_URL}"

      - name: Guard - correct API and /health exists
        env:
          EXPECTED_API_ID: ${{ vars.FINZ_EXPECTED_API_ID || '' }}
        run: |
          set -euo pipefail
          BASE="$DEV_API_URL"
          HOST_ID=$(echo "$BASE" | awk -F'[/.]' '{print $3}')
          # If EXPECTED_API_ID provided, enforce it
          if [ -n "${EXPECTED_API_ID}" ] && [ "$HOST_ID" != "$EXPECTED_API_ID" ]; then
            echo "❌ Expected API id ${EXPECTED_API_ID}, got ${HOST_ID} from ${BASE}"; exit 1;
          fi
          # Verify route exists on the API
          aws apigatewayv2 get-routes --api-id "$HOST_ID" --query 'Items[].RouteKey' --output text | tr '\t' '\n' | grep -q "GET /health" || {
            echo "❌ Route GET /health not found on API ${HOST_ID}"; exit 1; }

      - name: Upload to S3 (prefix /finanzas)
        run: |
          aws s3 sync dist/ "s3://${S3_BUCKET_NAME}/finanzas/" --delete

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${CLOUDFRONT_DIST_ID}" \
            --paths '/finanzas/*'
      - name: UI Smoke (HEAD /finanzas/ root)
        env:
          FINZ_PREFIX: /finanzas
        run: |
          set -euo pipefail
          DOMAIN=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
            ROOT="https://${DOMAIN}${FINZ_PREFIX}/"
          STATUS=$(curl -sS -o /dev/null -w '%{http_code}' -I "$ROOT")
          echo "## UI Root (HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "URL: $ROOT" >> $GITHUB_STEP_SUMMARY
          echo "Status: $STATUS" >> $GITHUB_STEP_SUMMARY
      - name: UI Smoke (GET /finanzas/ root)
        env:
          FINZ_PREFIX: /finanzas
        run: |
          set -euo pipefail
          DOMAIN=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
          ROOT="https://${DOMAIN}${FINZ_PREFIX}/"
          STATUS=$(curl -sS -o /dev/null -w '%{http_code}' -L "$ROOT")
          echo "## UI Root (GET)" >> $GITHUB_STEP_SUMMARY
          echo "URL: $ROOT" >> $GITHUB_STEP_SUMMARY
          echo "Status: $STATUS" >> $GITHUB_STEP_SUMMARY
      - name: UI Smoke (GET /finanzas/catalog/rubros)
        id: ui_smoke
        env:
          FINZ_PREFIX: /finanzas
        run: |
          set -euo pipefail
          DOMAIN=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
          URL="https://${DOMAIN}${FINZ_PREFIX}/catalog/rubros"
          echo "UI_URL=$URL" >> $GITHUB_OUTPUT
          echo "## UI Smoke" >> $GITHUB_STEP_SUMMARY
          echo "URL: $URL" >> $GITHUB_STEP_SUMMARY
          STATUS=$(curl -sS -o /dev/null -w '%{http_code}' -L "$URL")
          echo "Status: $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "\n<details><summary>HTML snippet</summary>" >> $GITHUB_STEP_SUMMARY
          echo '```html' >> $GITHUB_STEP_SUMMARY
          curl -sS -L "$URL" | sed -n '1,20p' >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Generate JWT for API smokes
        id: jwt
        uses: ./.github/actions/cognito-generate-jwt
        with:
          user_pool_id: ${{ vars.COGNITO_USER_POOL_ID }}
          client_id: ${{ vars.COGNITO_WEB_CLIENT }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          aws_region: ${{ env.AWS_REGION }}

      - name: "Post-deploy API smokes (/health & /catalog/rubros)"
        env:
          DEV_API_URL: ${{ env.DEV_API_URL }}
          TOKEN: ${{ steps.jwt.outputs.access_token }}
        run: |
          set -euo pipefail
          BASE=$(echo "$DEV_API_URL" | sed 's:/*$::')
          echo "BASE=$BASE"
          echo "# UI Post-Deploy API Smokes" >> $GITHUB_STEP_SUMMARY
          echo "API Base: $BASE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## GET /health" >> $GITHUB_STEP_SUMMARY
          curl -sS -f "$BASE/health" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## GET /catalog/rubros (auth required)" >> $GITHUB_STEP_SUMMARY
          RUBROS_JSON=$(curl -sS -f -H "Authorization: Bearer $TOKEN" "$BASE/catalog/rubros")
          COUNT=$(echo "$RUBROS_JSON" | jq '.data | length // 0')
          echo "Items: $COUNT" >> $GITHUB_STEP_SUMMARY
          echo "Sample:" >> $GITHUB_STEP_SUMMARY
          echo "$RUBROS_JSON" | jq '.data[:5]' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## GET /allocation-rules (auth)" >> $GITHUB_STEP_SUMMARY
          RULES_JSON=$(curl -sS -f -H "Authorization: Bearer $TOKEN" "$BASE/allocation-rules")
          RC=$(echo "$RULES_JSON" | jq '.data | length // 0')
          echo "Rules: $RC" >> $GITHUB_STEP_SUMMARY
          echo "Sample:" >> $GITHUB_STEP_SUMMARY
          echo "$RULES_JSON" | jq '.data[:3]' >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          {
            echo "## Finanzas UI deployed (dev)"
            echo "- Bucket: ${S3_BUCKET_NAME}"
            echo "- Distribution: ${CLOUDFRONT_DIST_ID}"
            echo "- Base Path: /finanzas/"
            echo "- API Base: ${VITE_API_BASE_URL} (derived from DEV_API_URL)"
            echo "- Feature: VITE_FINZ_ENABLED=${VITE_FINZ_ENABLED}"
            echo "- Mocks: VITE_USE_MOCKS=${VITE_USE_MOCKS}"
            echo ""
            echo "### Try it"
            echo '```bash'
            echo "open https://d7t9x3j66yd8k.cloudfront.net/finanzas/"
            echo '```'
          } >> $GITHUB_STEP_SUMMARY
