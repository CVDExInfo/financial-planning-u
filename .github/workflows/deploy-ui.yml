name: Deploy Finanzas UI

on:
  workflow_dispatch:
    inputs:
      deployment_env:
        description: "Environment (dev|prod)"
        required: true
        default: "prod"
        type: choice
        options: [dev, prod]
  push:
    branches: [main]
    paths:
      - "src/**"
      - "vite.config.*"
      - ".github/workflows/deploy-ui.yml"

permissions:
  id-token: write
  contents: read

jobs:
  deploy-finanzas:
    runs-on: ubuntu-latest

    env:
      # ---------- From GitHub Variables ----------
      AWS_REGION: ${{ vars.AWS_REGION }}
      FINANZAS_BUCKET_NAME: ${{ vars.FINANZAS_BUCKET_NAME }}
      CLOUDFRONT_DIST_ID: ${{ vars.CLOUDFRONT_DIST_ID }}
      CF_DOMAIN: ${{ vars.CF_DOMAIN }}
      FINZ_API_ID: ${{ vars.FINZ_API_ID }}
      FINZ_API_STAGE_DEV: ${{ vars.FINZ_API_STAGE_DEV }}
      FINZ_API_STAGE_PROD: ${{ vars.FINZ_API_STAGE_PROD }}
      DEV_API_URL: ${{ vars.DEV_API_URL }}

      # ---------- Vite defaults (overridable below) ----------
      VITE_PUBLIC_BASE: /finanzas/
      VITE_FINZ_ENABLED: "true"
      VITE_USE_MOCKS: "false"
      VITE_AWS_REGION: ${{ vars.AWS_REGION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Resolve API base and sanity-check /health
        id: apibase
        shell: bash
        run: |
          set -euo pipefail

          DEPLOYMENT_ENV="${{ inputs.deployment_env }}"
          if [[ -z "${DEPLOYMENT_ENV}" ]]; then DEPLOYMENT_ENV="prod"; fi
          echo "DEPLOYMENT_ENV=$DEPLOYMENT_ENV" >> "$GITHUB_ENV"

          # Promote DEV_API_URL to VITE_API_BASE_URL if not provided via environment
          if [[ -z "${VITE_API_BASE_URL:-}" ]]; then
            if [[ -n "${DEV_API_URL:-}" ]]; then
              VITE_API_BASE_URL="$DEV_API_URL"
              echo "Promoting DEV_API_URL to VITE_API_BASE_URL: $VITE_API_BASE_URL"
            else
              echo "::error title=Missing API base::Neither VITE_API_BASE_URL nor DEV_API_URL is set."
              exit 1
            fi
          fi

          # Normalize (strip trailing slash)
          VITE_API_BASE_URL="${VITE_API_BASE_URL%/}"
          echo "VITE_API_BASE_URL=$VITE_API_BASE_URL" >> "$GITHUB_ENV"

          # Extract API Gateway ID to confirm it matches expected (optional)
          host="$(echo "$VITE_API_BASE_URL" | awk -F[/:] '{print $4}')"
          api_id="${host%%.*}"
          expected="${{ env.FINZ_API_ID }}"
          if [[ -n "$expected" && "$api_id" != "$expected" ]]; then
            echo "::warning title=API id mismatch::expected $expected, got $api_id"
          fi

          # Health must be 200
          code="$(curl -sS -o /dev/null -w '%{http_code}' "$VITE_API_BASE_URL/health" || true)"
          if [[ "$code" != "200" ]]; then
            echo "::error title=API /health failed::GET $VITE_API_BASE_URL/health -> $code"
            exit 1
          fi

      - name: Install Node & build Finanzas bundle
        shell: bash
        run: |
          set -euo pipefail
          corepack enable
          corepack prepare pnpm@9.12.0 --activate || true
          pnpm -v || npm -v
          npm ci
          # Ensure Vite gets our API base and base path
          export VITE_API_BASE_URL="${VITE_API_BASE_URL}"
          export VITE_PUBLIC_BASE="${VITE_PUBLIC_BASE}"
          export VITE_FINZ_ENABLED="${VITE_FINZ_ENABLED}"
          export VITE_USE_MOCKS="${VITE_USE_MOCKS}"
          export VITE_AWS_REGION="${VITE_AWS_REGION}"
          # Your build script that outputs dist-finanzas/
          npm run build:finanzas

      - name: Verify build artifacts
        shell: bash
        run: |
          set -euo pipefail
          test -f dist-finanzas/index.html || { echo "::error ::dist-finanzas/index.html missing"; exit 1; }
          if grep -R -nE 'src="/assets/|href="/assets/' dist-finanzas/index.html; then
            echo "::error ::index.html points to /assets/* (base path missing)"; exit 1;
          fi
          if find dist-finanzas -name "aws-exports.js" -o -name "aws-exports.ts" | grep -q .; then
            echo "::error ::aws-exports.* must not be in Finanzas build"; exit 1;
          fi

      - name: Upload to S3
        shell: bash
        run: |
          set -euo pipefail
          aws s3 sync dist-finanzas/ "s3://${FINANZAS_BUCKET_NAME}/finanzas/" --exclude '*.map' --delete
          echo "uploaded=true" >> "$GITHUB_OUTPUT"

      - name: Check CloudFront path behaviors
        shell: bash
        run: |
          set -euo pipefail
          count=$(aws cloudfront get-distribution-config \
            --id "${CLOUDFRONT_DIST_ID}" \
            --query 'DistributionConfig.CacheBehaviors.Items[?PathPattern==`/finanzas/*`] | length(@)' \
            --output text)
          if [[ "$count" != "1" ]]; then
            echo "::error ::/finanzas/* behavior missing in CloudFront ${CLOUDFRONT_DIST_ID}"
            exit 1
          fi

      - name: Invalidate CloudFront
        shell: bash
        run: |
          set -euo pipefail
          aws cloudfront create-invalidation \
            --distribution-id "${CLOUDFRONT_DIST_ID}" \
            --paths '/*' '/finanzas/*' '/finanzas/index.html' >/dev/null

      - name: Postâ€‘deploy smoke (HTML + assets)
        shell: bash
        run: |
          set -euo pipefail
          domain="${CF_DOMAIN}"
          if [[ -z "$domain" ]]; then
            domain=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
          fi
          base="https://${domain}/finanzas"
          html_code=$(curl -sS -o /dev/null -w '%{http_code}' "$base/")
          [[ "$html_code" == "200" ]] || { echo "::error ::$base not reachable ($html_code)"; exit 1; }
          # quick spot check for asset pathing
          if ! curl -sS "$base/" | head -n 60 | grep -q "/finanzas/assets/"; then
            echo "::warning ::HTML missing /finanzas/assets references"
          fi

      - name: Deployment Summary
        shell: bash
        run: |
          set -euo pipefail
          domain="${CF_DOMAIN:-d7t9x3j66yd8k.cloudfront.net}"
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          # ðŸš€ Finanzas UI Deployment â€” ${{ inputs.deployment_env }}

          **Region:** ${AWS_REGION}  
          **Bucket:** ${FINANZAS_BUCKET_NAME}  
          **CloudFront:** ${CLOUDFRONT_DIST_ID}  
          **API Base:** ${VITE_API_BASE_URL}

          **Access:** https://${domain}/finanzas/
          EOF
