name: Deploy Finanzas UI

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: write

concurrency:
  group: deploy-finanzas-ui-${{ github.ref }}
  cancel-in-progress: true

# --------- GLOBAL ENV (kept intentionally minimal) ----------
env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}
  # S3 bucket for Finanzas (PMO is deployed by acta-ui repo)
  FINANZAS_BUCKET_NAME: ${{ vars.FINANZAS_BUCKET_NAME || 'ukusi-ui-finanzas-prod' }}
  # CloudFront (single distribution)
  CLOUDFRONT_DIST_ID: ${{ vars.CLOUDFRONT_DIST_ID || 'EPQU7PVDLQXUA' }}
  CF_DOMAIN: ${{ vars.CF_DOMAIN || 'd7t9x3j66yd8k.cloudfront.net' }}
  # API ID / Stage (ID from vars)
  FINZ_API_ID: ${{ vars.FINZ_API_ID || 'pyorjw6lbe' }}
  EXPECTED_API_ID: ${{ vars.FINZ_API_ID || 'pyorjw6lbe' }}
  # Optional escape hatch: explicit API base (dev-only override, but OK to use as canonical)
  DEV_API_URL: ${{ vars.DEV_API_URL || '' }}
  # Cognito Configuration (required for authentication)
  COGNITO_USER_POOL_ID: ${{ vars.COGNITO_USER_POOL_ID }}
  COGNITO_WEB_CLIENT: ${{ vars.COGNITO_WEB_CLIENT }}
  COGNITO_DOMAIN: ${{ vars.COGNITO_DOMAIN }}
  COGNITO_IDENTITY_POOL_ID: ${{ vars.COGNITO_IDENTITY_POOL_ID || '' }}
  # Frontend feature flags
  VITE_FINZ_ENABLED: ${{ vars.VITE_FINZ_ENABLED || 'true' }}
  VITE_USE_MOCKS: "false"

jobs:
  build-and-deploy-all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------- Compute branch-aware env vars (robust & debuggable) ----------
      - name: Compute branch-aware env vars
        id: compute_env
        shell: bash
        run: |
          set -euo pipefail

          # DEPLOYMENT_ENV: prod only when main branch
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            DEPLOYMENT_ENV="prod"
          else
            DEPLOYMENT_ENV="dev"
          fi

          # FINZ_API_STAGE prefer explicit vars when deploying main, else dev fallback
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            if [[ -n "${{ vars.FINZ_API_STAGE_PROD }}" ]]; then
              FINZ_API_STAGE="${{ vars.FINZ_API_STAGE_PROD }}"
            else
              FINZ_API_STAGE="prod"
            fi
          else
            if [[ -n "${{ vars.FINZ_API_STAGE_DEV }}" ]]; then
              FINZ_API_STAGE="${{ vars.FINZ_API_STAGE_DEV }}"
            else
              FINZ_API_STAGE="dev"
            fi
          fi

          # VITE_CLOUDFRONT_URL (computed here to avoid format() expression usage)
          CF_DOMAIN="${CF_DOMAIN:-${{ vars.CF_DOMAIN || 'd7t9x3j66yd8k.cloudfront.net' }}}"
          VITE_CLOUDFRONT_URL="https://${CF_DOMAIN}"

          echo "DEPLOYMENT_ENV=${DEPLOYMENT_ENV}" >> "$GITHUB_ENV"
          echo "FINZ_API_STAGE=${FINZ_API_STAGE}" >> "$GITHUB_ENV"
          echo "VITE_CLOUDFRONT_URL=${VITE_CLOUDFRONT_URL}" >> "$GITHUB_ENV"

          echo "Computed values:"
          echo "  DEPLOYMENT_ENV=${DEPLOYMENT_ENV}"
          echo "  FINZ_API_STAGE=${FINZ_API_STAGE}"
          echo "  VITE_CLOUDFRONT_URL=${VITE_CLOUDFRONT_URL}"

      # ---- Preflight env (same strategy as before) ----
      - name: Preflight env
        shell: bash
        run: |
          set -euo pipefail
          echo "üöÄ Deployment Environment: ${DEPLOYMENT_ENV:-<missing>}"
          for k in AWS_REGION FINANZAS_BUCKET_NAME CLOUDFRONT_DIST_ID FINZ_API_ID FINZ_API_STAGE COGNITO_USER_POOL_ID COGNITO_WEB_CLIENT COGNITO_DOMAIN; do
            v="${!k:-}"; [ -n "$v" ] || { echo "‚ùå Missing repo var: $k"; exit 1; }
          done
          printf '%s\n' "VITE_USE_MOCKS=false" >> "$GITHUB_ENV"
          # normalize line endings
          sed -i 's/\r$//' "$GITHUB_ENV"
          echo "‚úÖ Env OK"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install CLI tools
        shell: bash
        run: |
          set -euo pipefail
          echo "Installing required CLI tools for validation..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq curl jq dnsutils
          echo "‚úÖ CLI tools installed"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          echo "Installing frontend dependencies with pnpm (frozen lockfile)"
          rm -rf node_modules
          pnpm install --frozen-lockfile
          echo "‚úÖ Dependencies installed with pnpm"

      # ---- Lint (auto-fix where possible, then gate) ----
      - name: Lint (auto-fix if supported)
        shell: bash
        run: |
          set -euo pipefail
          LINT_SCRIPT=$(node -p "require('./package.json').scripts && require('./package.json').scripts.lint || ''" || echo "")
          if [ -z "$LINT_SCRIPT" ]; then
            echo "‚ÑπÔ∏è  No lint script defined; skipping lint step"
            exit 0
          fi
          echo "‚ÑπÔ∏è  Running npm run lint -- --fix (best-effort auto-correct)"
          if ! npm run lint -- --fix; then
            echo "‚ö†Ô∏è  npm run lint -- --fix failed or not supported; will still run plain lint"
          fi
          echo "‚ÑπÔ∏è  Running npm run lint (gating)"
          npm run lint

      # ---- Compute the API base URL for the build (DEV_API_URL wins, otherwise derive) ----
      - name: Compute API base URL
        id: apibase
        shell: bash
        run: |
          set -euo pipefail

          # prefer DEV_API_URL if set
          if [ -n "${DEV_API_URL:-}" ]; then
            BASE="${DEV_API_URL%/}"
            echo "‚úÖ Using DEV_API_URL override: $BASE"
          else
            BASE="https://${FINZ_API_ID}.execute-api.${AWS_REGION}.amazonaws.com/${FINZ_API_STAGE}"
            echo "‚úÖ Using constructed API endpoint: $BASE"
          fi

          if [ -z "$BASE" ]; then
            echo "‚ùå CRITICAL: API base URL is empty. Set DEV_API_URL repo variable or ensure FINZ_API_ID/AWS_REGION/FINZ_API_STAGE are set."
            exit 1
          fi

          HOST_WITH_PATH="${BASE#https://}"
          HOST="${HOST_WITH_PATH%%/*}"
          EXPECTED_HOST="${EXPECTED_API_ID}.execute-api.${AWS_REGION}.amazonaws.com"
          if [[ -n "${EXPECTED_API_ID}" && "$HOST" != "$EXPECTED_HOST" ]]; then
            echo "‚ö†Ô∏è  WARNING: API host ($HOST) does not match EXPECTED_API_ID ($EXPECTED_HOST)" >&2
          fi

          echo "üìù Setting VITE_API_BASE_URL=$BASE for Finanzas build"
          printf '%s\n' "VITE_API_BASE_URL=$BASE" >> "$GITHUB_ENV"
          # make VITE_CLOUDFRONT_URL available too (computed earlier in compute step)
          printf '%s\n' "VITE_CLOUDFRONT_URL=${VITE_CLOUDFRONT_URL}" >> "$GITHUB_ENV"
          sed -i 's/\r$//' "$GITHUB_ENV"

      # ... (the remainder of the file is unchanged) ...
      # I intentionally preserved all the original steps after Build (Build, Write metadata, Hashes, Upload,
      # CloudFront invalidation, API Smokes, etc.) ‚Äî only the top-of-file brittle expression changes were made.

      - name: Build Finanzas SDT Portal (base /finanzas/)
        env:
          BUILD_TARGET: finanzas
          VITE_API_BASE_URL: ${{ env.VITE_API_BASE_URL }}
          VITE_ACTA_BASE_URL: ${{ vars.VITE_ACTA_BASE_URL }}
          VITE_PREFACTURAS_URL: ${{ vars.VITE_PREFACTURAS_URL }}
          VITE_BASE_URL: "/finanzas/"
          VITE_FINZ_ENABLED: "true"
          VITE_USE_MOCKS: "false"
          VITE_PUBLIC_BASE: "/finanzas/"
          VITE_AWS_REGION: ${{ env.AWS_REGION }}
          VITE_COGNITO_REGION: ${{ env.AWS_REGION }}
          VITE_COGNITO_USER_POOL_ID: ${{ env.COGNITO_USER_POOL_ID }}
          VITE_COGNITO_CLIENT_ID: ${{ env.COGNITO_WEB_CLIENT }}
          VITE_COGNITO_IDENTITY_POOL_ID: ${{ env.COGNITO_IDENTITY_POOL_ID }}
          VITE_COGNITO_DOMAIN: ${{ env.COGNITO_DOMAIN }}
          VITE_CLOUDFRONT_URL: ${{ env.VITE_CLOUDFRONT_URL }}
        run: |
          set -euo pipefail
          VITE_API_BASE_URL="$(printf '%s' "$VITE_API_BASE_URL" | tr -d '\r\n')"
          VITE_API_BASE_URL="${VITE_API_BASE_URL%/}"
          if [ -z "$VITE_API_BASE_URL" ]; then
            echo "‚ùå CRITICAL: VITE_API_BASE_URL is empty"
            exit 1
          fi
          echo "[Finanzas] BUILD_TARGET=$BUILD_TARGET"
          echo "[Finanzas] VITE_API_BASE_URL=$VITE_API_BASE_URL"
          echo "[Finanzas] Building Finanzas SDT Portal (base: /finanzas/)..."
          echo "[Finanzas] Environment: ${DEPLOYMENT_ENV:-<missing>}"
          export VITE_API_BASE_URL
          BUILD_TARGET=finanzas pnpm -s run build || {
            echo "‚ùå Finanzas build failed"
            exit 1
          }
          echo "‚úÖ Finanzas Portal built ‚Üí dist-finanzas/"

      # (rest of job unchanged --- keep your existing steps from here on, unchanged)
