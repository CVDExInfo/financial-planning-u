name: Deploy UIs (PMO + Finanzas)

on:
  workflow_dispatch: {}
  push:
    branches: ["r1-finanzas-dev-wiring", "main"]

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}
  S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
  CLOUDFRONT_DIST_ID: ${{ vars.CLOUDFRONT_DIST_ID }}
  FINZ_API_STACK: ${{ vars.FINZ_API_STACK || 'finanzas-sd-api-dev' }}
  DEV_API_URL: ${{ vars.DEV_API_URL || '' }}
  VITE_FINZ_ENABLED: ${{ vars.VITE_FINZ_ENABLED || 'true' }}
  VITE_USE_MOCKS: "false"
  EXPECTED_API_ID: ${{ vars.FINZ_EXPECTED_API_ID || 'm3g6am67aj' }}

jobs:
  build-and-deploy-all:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Preflight env
        run: |
          set -euo pipefail
          for k in S3_BUCKET_NAME CLOUDFRONT_DIST_ID; do
            v="${!k:-}"; [ -n "$v" ] || { echo "âŒ Missing repo var: $k"; exit 1; }
          done
          printf '%s\n' "VITE_USE_MOCKS=false" >> "$GITHUB_ENV"
          sed -i 's/\r$//' "$GITHUB_ENV"
          echo "âœ… Env OK"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: |
          set -e
          echo "Installing frontend dependencies (prefer lock, fallback to dynamic)"
          if ! npm ci; then
            echo "npm ci failed (likely lock mismatch). Falling back to npm install."
            npm install
          fi

      - name: Normalize API base from repo var
        run: |
          set -euo pipefail
          if [ -z "${DEV_API_URL}" ]; then
            echo "âš ï¸  DEV_API_URL repo var is empty. Finanzas build will skip API env."; 
          else
            CLEAN_URL="${DEV_API_URL%/}"
            printf '%s\n' "DEV_API_URL=$CLEAN_URL" >> "$GITHUB_ENV"
            printf '%s\n' "VITE_API_BASE_URL=$CLEAN_URL" >> "$GITHUB_ENV"
            sed -i 's/\r$//' "$GITHUB_ENV"
            echo "Using DEV_API_URL=$CLEAN_URL"
          fi

      - name: "Build PMO Portal (base: /)"
        run: |
          echo "Building PMO Portal (base: /)..."
          BUILD_TARGET=pmo npm run build || { echo "âŒ PMO build failed"; exit 1; }
          mkdir -p tmp-pmo && mv dist/* tmp-pmo/ && rm -rf dist && mv tmp-pmo dist-pmo
          echo "âœ… PMO Portal built â†’ dist-pmo/"

      - name: "Build Finanzas SDT Portal (base: /finanzas/)"
        env:
          VITE_API_BASE_URL: ${{ env.VITE_API_BASE_URL }}
          VITE_FINZ_ENABLED: "true"
          VITE_USE_MOCKS: ${{ env.VITE_USE_MOCKS }}
        run: |
          echo "Building Finanzas SDT Portal (base: /finanzas/)..."
          BUILD_TARGET=finanzas npm run build || { echo "âŒ Finanzas build failed"; exit 1; }
          mkdir -p tmp-finanzas && mv dist/* tmp-finanzas/ && rm -rf dist && mv tmp-finanzas dist-finanzas
          echo "âœ… Finanzas Portal built â†’ dist-finanzas/"

      - name: Configure AWS (OIDC)
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: deploy-ui-${{ github.run_id }}

      - name: Verify identity
        run: aws sts get-caller-identity

      - name: "Guard - S3 bucket and CloudFront exist"
        run: |
          set -euo pipefail
          echo "Verifying S3 bucket exists..."
          aws s3api head-bucket --bucket "${S3_BUCKET_NAME}" || {
            echo "âŒ S3 bucket ${S3_BUCKET_NAME} not found"; exit 1; }
          echo "âœ… S3 bucket found: ${S3_BUCKET_NAME}"

          echo "Verifying CloudFront distribution exists..."
          aws cloudfront get-distribution --id "${CLOUDFRONT_DIST_ID}" >/dev/null || {
            echo "âŒ CloudFront distribution ${CLOUDFRONT_DIST_ID} not found"; exit 1; }
          echo "âœ… CloudFront distribution found: ${CLOUDFRONT_DIST_ID}"

      - name: "Guard - API endpoint present (if provided)"
        if: env.DEV_API_URL != ''
        run: |
          set -euo pipefail
          BASE="${DEV_API_URL%/}"
          echo "Verifying API endpoint exists at $BASE"

          HOST_ID=$(echo "$BASE" | awk -F'[/.]' '{print $3}')
          echo "Extracted API host ID: $HOST_ID"

          if [ "$HOST_ID" != "$EXPECTED_API_ID" ]; then
            echo "âŒ Expected API id ${EXPECTED_API_ID}, got ${HOST_ID}"; exit 1;
          fi
          echo "âœ… API endpoint ID verified: ${HOST_ID}"

      - name: "Upload PMO Portal to S3 (root /)"
        run: |
          echo "Uploading PMO Portal to S3 root..."
          aws s3 sync dist-pmo/ "s3://${S3_BUCKET_NAME}/" \
            --exclude '*.map' \
            --delete
          echo "âœ… PMO Portal uploaded to s3://${S3_BUCKET_NAME}/"

      - name: "Upload Finanzas Portal to S3 (/finanzas prefix)"
        run: |
          echo "Uploading Finanzas Portal to S3 /finanzas/ prefix..."
          aws s3 sync dist-finanzas/ "s3://${S3_BUCKET_NAME}/finanzas/" \
            --exclude '*.map' \
            --delete
          echo "âœ… Finanzas Portal uploaded to s3://${S3_BUCKET_NAME}/finanzas/"

      - name: "Guard - Verify CloudFront /finanzas/* Behavior (CRITICAL)"
        run: |
          set -euo pipefail
          echo "ðŸ” Critical Guard: Verifying CloudFront /finanzas/* behavior exists..."

          # Query specifically for /finanzas/* behavior
          BEHAVIOR_COUNT=$(aws cloudfront get-distribution-config \
            --id "${CLOUDFRONT_DIST_ID}" \
            --query 'DistributionConfig.CacheBehaviors.Items[?PathPattern==`/finanzas/*`] | length(@)' \
            --output text)

          if [ "$BEHAVIOR_COUNT" != "1" ]; then
            echo "âŒ CRITICAL: /finanzas/* behavior is MISSING from CloudFront distribution"
            echo "   Finanzas Portal cannot be served correctly without this behavior"
            echo ""
            echo "   To fix this:"
            echo "   1. Go to AWS CloudFront console â†’ Distribution ${CLOUDFRONT_DIST_ID}"
            echo "   2. Select Behaviors tab"
            echo "   3. Create a new behavior with:"
            echo "      - Path pattern: /finanzas/*"
            echo "      - Origin: finanzas-ui-s3 (S3 bucket: ukusi-ui-finanzas-prod)"
            echo "      - Origin access control: finanzas-ui-oac"
            echo "      - Cache policy: Managed-CachingDisabled or equivalent"
            echo ""
            exit 1
          fi

          echo "âœ… PASS: /finanzas/* behavior is configured"

          # Additional verification - check it points to the right origin
          ORIGIN=$(aws cloudfront get-distribution-config \
            --id "${CLOUDFRONT_DIST_ID}" \
            --query 'DistributionConfig.CacheBehaviors.Items[?PathPattern==`/finanzas/*`][0].TargetOriginId' \
            --output text)

          echo "   âœ“ Target origin: $ORIGIN"

          if [ "$ORIGIN" != "finanzas-ui-s3" ]; then
            echo "âš ï¸  WARNING: /finanzas/* points to '$ORIGIN', expected 'finanzas-ui-s3'"
            echo "   This may cause incorrect content serving"
          fi

      - name: "Invalidate CloudFront (all paths + Finanzas SPA)"
        run: |
          set -euo pipefail
          echo "Invalidating CloudFront cache..."
          echo "  Paths: /* (all content), /finanzas/* (SPA paths), /finanzas/index.html (SPA fallback)"

          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id "${CLOUDFRONT_DIST_ID}" \
            --paths '/*' '/finanzas/*' '/finanzas/index.html' \
            --query 'Invalidation.Id' \
            --output text)

          echo "âœ… Invalidation queued: $INVALIDATION_ID"
          echo "   Note: Cache propagation may take 30-60 seconds"

      - name: "UI Smoke (PMO root /)"
        env:
          PMO_PREFIX: ""
        run: |
          set -euo pipefail
          DOMAIN=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
          ROOT="https://${DOMAIN}/"
          STATUS=$(curl -sS -o /dev/null -w '%{http_code}' "$ROOT")
          echo "## PMO Portal (root /)" >> $GITHUB_STEP_SUMMARY
          echo "URL: $ROOT" >> $GITHUB_STEP_SUMMARY
          echo "Status: $STATUS" >> $GITHUB_STEP_SUMMARY

      - name: "UI Smoke (Finanzas /finanzas/)"
        env:
          FINZ_PREFIX: /finanzas
        run: |
          set -euo pipefail
          DOMAIN=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
          ROOT="https://${DOMAIN}${FINZ_PREFIX}/"
          STATUS=$(curl -sS -o /dev/null -w '%{http_code}' "$ROOT")
          echo "## Finanzas Portal (/finanzas/)" >> $GITHUB_STEP_SUMMARY
          echo "URL: $ROOT" >> $GITHUB_STEP_SUMMARY
          echo "Status: $STATUS" >> $GITHUB_STEP_SUMMARY

      - name: "API Readiness Check (if DEV_API_URL set)"
        if: env.DEV_API_URL != ''
        run: |
          set -euo pipefail
          BASE="${DEV_API_URL%/}"
          echo "Checking API readiness at $BASE"
          for i in $(seq 1 6); do
            CODE=$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || true)
            if [ "$CODE" = "200" ]; then
              echo "API ready (health=200)"
              break
            fi
            echo "Waiting for API... (try $i, code=$CODE)"
            sleep 5
            if [ "$i" = "6" ]; then echo "âš ï¸  API not ready (will continue)"; fi
          done

      - name: "API Smokes (if DEV_API_URL set)"
        if: env.DEV_API_URL != ''
        env:
          DEV_API_URL: ${{ env.DEV_API_URL }}
        run: |
          set -euo pipefail
          BASE="${DEV_API_URL%/}"
          echo "## Post-Deploy API Smokes" >> $GITHUB_STEP_SUMMARY
          echo "Base: $BASE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Health (public)
          echo "### GET /health" >> $GITHUB_STEP_SUMMARY
          curl -sS -f "$BASE/health" | jq . >> $GITHUB_STEP_SUMMARY || echo "âš ï¸  Could not fetch /health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "Summary & Evidence Pack"
        run: |
          set -euo pipefail
          {
            echo "## Dual-SPA Deployment Complete âœ…"
            echo ""
            echo "### PMO Portal"
            echo "- **Location**: CloudFront root (/)"
            echo "- **Build**: dist-pmo/"
            echo "- **S3 Prefix**: / (root)"
            echo "- **Access**: https://d7t9x3j66yd8k.cloudfront.net/"
            echo ""
            echo "### Finanzas SDT Portal"
            echo "- **Location**: /finanzas/"
            echo "- **Build**: dist-finanzas/"
            echo "- **S3 Prefix**: /finanzas/"
            echo "- **API Base**: ${VITE_API_BASE_URL:-'(not set)'}"
            echo "- **API Stack**: ${FINZ_API_STACK}"
            echo "- **Access**: https://d7t9x3j66yd8k.cloudfront.net/finanzas/"
            echo ""
            echo "### CloudFront Configuration"
            DIST_DOMAIN=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
            echo "- **Distribution ID**: ${CLOUDFRONT_DIST_ID}"
            echo "- **Domain**: $DIST_DOMAIN"
            echo ""
            echo "#### Origins"
            aws cloudfront get-distribution-config --id "${CLOUDFRONT_DIST_ID}" \
              --query 'DistributionConfig.Origins.Items[*].[Id, DomainName, OriginAccessControlId]' \
              --output text | awk '{printf "- **%s**: %s (OAC: %s)\n", $1, $2, $3}' >> $GITHUB_STEP_SUMMARY || true
            echo ""
            echo "#### Cache Behaviors"
            aws cloudfront get-distribution-config --id "${CLOUDFRONT_DIST_ID}" \
              --query 'DistributionConfig.CacheBehaviors.Items[*].[PathPattern, TargetOriginId]' \
              --output text | awk '{printf "- **%s** â†’ %s\n", $1, $2}' >> $GITHUB_STEP_SUMMARY || true
            echo ""
            echo "### Health Checks"
            
            # PMO
            PMO_STATUS=$(curl -sS -o /dev/null -w '%{http_code}' "https://${DIST_DOMAIN}/")
            echo "- **PMO Portal**: HTTP $PMO_STATUS âœ…" || echo "- **PMO Portal**: HTTP $PMO_STATUS âŒ"
            
            # Finanzas
            FINZ_STATUS=$(curl -sS -o /dev/null -w '%{http_code}' "https://${DIST_DOMAIN}/finanzas/")
            echo "- **Finanzas Portal**: HTTP $FINZ_STATUS âœ…" || echo "- **Finanzas Portal**: HTTP $FINZ_STATUS âŒ"
            
            # Catalog (public)
            CATALOG_STATUS=$(curl -sS -o /dev/null -w '%{http_code}' "https://${DIST_DOMAIN}/finanzas/catalog/rubros" || echo "000")
            if [ "$CATALOG_STATUS" = "200" ]; then
              echo "- **Catalog Endpoint**: HTTP $CATALOG_STATUS âœ…"
            else
              echo "- **Catalog Endpoint**: HTTP $CATALOG_STATUS (may require API routing)"
            fi
            
            echo ""
            echo "### Next Steps"
            echo "1. **Verify Deployment**: Access https://${DIST_DOMAIN}/finanzas/ and ensure Finanzas tab is visible"
            echo "2. **Test Navigation**: Click 'Rubros' â†’ should navigate to /catalog/rubros"
            echo "3. **Monitor Propagation**: Cache invalidation in progress (30-60 seconds)"
            echo "4. **Cognito Setup**: Ensure callback URLs include https://${DIST_DOMAIN}/finanzas/"
            echo ""
            echo "### Deployment Summary"
            echo "- Build Target: Dual-SPA (PMO + Finanzas)"
            echo "- Deploy Time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo "- Build Target Env: BUILD_TARGET=pmo, BUILD_TARGET=finanzas"
            echo "- S3 Bucket: ${S3_BUCKET_NAME}"
            echo "- CloudFront Distribution: ${CLOUDFRONT_DIST_ID}"
          } >> $GITHUB_STEP_SUMMARY

      - name: Summary (Legacy)
        run: |
          {
            echo "## UIs Deployed (dev)"
            echo ""
            echo "### PMO Portal"
            echo "- Path: / (CloudFront root)"
            echo "- Build: dist-pmo/"
            echo ""
            echo "### Finanzas SDT Portal"
            echo "- Path: /finanzas/"
            echo "- Build: dist-finanzas/"
            echo "- API Base: ${VITE_API_BASE_URL:-'(not set)'}"
            echo "- API: ${FINZ_API_STACK}"
            echo ""
            echo "### Access"
            echo "- PMO: https://d7t9x3j66yd8k.cloudfront.net/"
            echo "- Finanzas: https://d7t9x3j66yd8k.cloudfront.net/finanzas/"
          } >> $GITHUB_STEP_SUMMARY
