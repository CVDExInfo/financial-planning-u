name: Deploy UIs (PMO + Finanzas)

on:
  workflow_dispatch: {}
  push:
    branches: ["r1-finanzas-dev-wiring", "main"]

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}
  S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
  CLOUDFRONT_DIST_ID: ${{ vars.CLOUDFRONT_DIST_ID }}
  FINZ_API_STACK: ${{ vars.FINZ_API_STACK || 'finanzas-sd-api-dev' }}
  DEV_API_URL: ${{ vars.DEV_API_URL || '' }}
  VITE_FINZ_ENABLED: ${{ vars.VITE_FINZ_ENABLED || 'true' }}
  VITE_USE_MOCKS: "false"
  EXPECTED_API_ID: ${{ vars.FINZ_EXPECTED_API_ID || 'm3g6am67aj' }}

jobs:
  build-and-deploy-all:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Preflight env
        run: |
          set -euo pipefail
          for k in S3_BUCKET_NAME CLOUDFRONT_DIST_ID; do
            v="${!k:-}"; [ -n "$v" ] || { echo "❌ Missing repo var: $k"; exit 1; }
          done
          printf '%s\n' "VITE_USE_MOCKS=false" >> "$GITHUB_ENV"
          sed -i 's/\r$//' "$GITHUB_ENV"
          echo "✅ Env OK"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: |
          set -e
          echo "Installing frontend dependencies (prefer lock, fallback to dynamic)"
          if ! npm ci; then
            echo "npm ci failed (likely lock mismatch). Falling back to npm install."
            npm install
          fi

      - name: Normalize API base from repo var
        run: |
          set -euo pipefail
          if [ -z "${DEV_API_URL}" ]; then
            echo "⚠️  DEV_API_URL repo var is empty. Finanzas build will skip API env."; 
          else
            CLEAN_URL="${DEV_API_URL%/}"
            printf '%s\n' "DEV_API_URL=$CLEAN_URL" >> "$GITHUB_ENV"
            printf '%s\n' "VITE_API_BASE_URL=$CLEAN_URL" >> "$GITHUB_ENV"
            sed -i 's/\r$//' "$GITHUB_ENV"
            echo "Using DEV_API_URL=$CLEAN_URL"
          fi

      - name: "Build PMO Portal (base: /)"
        run: |
          echo "Building PMO Portal (base: /)..."
          BUILD_TARGET=pmo npm run build || { echo "❌ PMO build failed"; exit 1; }
          mkdir -p tmp-pmo && mv dist/* tmp-pmo/ && rm -rf dist && mv tmp-pmo dist-pmo
          echo "✅ PMO Portal built → dist-pmo/"

      - name: "Build Finanzas SDT Portal (base: /finanzas/)"
        env:
          VITE_API_BASE_URL: ${{ env.VITE_API_BASE_URL }}
          VITE_FINZ_ENABLED: ${{ env.VITE_FINZ_ENABLED }}
          VITE_USE_MOCKS: ${{ env.VITE_USE_MOCKS }}
        run: |
          echo "Building Finanzas SDT Portal (base: /finanzas/)..."
          BUILD_TARGET=finanzas npm run build || { echo "❌ Finanzas build failed"; exit 1; }
          mkdir -p tmp-finanzas && mv dist/* tmp-finanzas/ && rm -rf dist && mv tmp-finanzas dist-finanzas
          echo "✅ Finanzas Portal built → dist-finanzas/"

      - name: Configure AWS (OIDC)
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: deploy-ui-${{ github.run_id }}

      - name: Verify identity
        run: aws sts get-caller-identity

      - name: "Guard - S3 bucket and CloudFront exist"
        run: |
          set -euo pipefail
          echo "Verifying S3 bucket exists..."
          aws s3api head-bucket --bucket "${S3_BUCKET_NAME}" || {
            echo "❌ S3 bucket ${S3_BUCKET_NAME} not found"; exit 1; }
          echo "✅ S3 bucket found: ${S3_BUCKET_NAME}"

          echo "Verifying CloudFront distribution exists..."
          aws cloudfront get-distribution --id "${CLOUDFRONT_DIST_ID}" >/dev/null || {
            echo "❌ CloudFront distribution ${CLOUDFRONT_DIST_ID} not found"; exit 1; }
          echo "✅ CloudFront distribution found: ${CLOUDFRONT_DIST_ID}"

      - name: "Guard - API endpoint present (if provided)"
        if: env.DEV_API_URL != ''
        run: |
          set -euo pipefail
          BASE="${DEV_API_URL%/}"
          echo "Verifying API endpoint exists at $BASE"

          HOST_ID=$(echo "$BASE" | awk -F'[/.]' '{print $3}')
          echo "Extracted API host ID: $HOST_ID"

          if [ "$HOST_ID" != "$EXPECTED_API_ID" ]; then
            echo "❌ Expected API id ${EXPECTED_API_ID}, got ${HOST_ID}"; exit 1;
          fi
          echo "✅ API endpoint ID verified: ${HOST_ID}"

      - name: "Upload PMO Portal to S3 (root /)"
        run: |
          echo "Uploading PMO Portal to S3 root..."
          aws s3 sync dist-pmo/ "s3://${S3_BUCKET_NAME}/" \
            --exclude '*.map' \
            --delete
          echo "✅ PMO Portal uploaded to s3://${S3_BUCKET_NAME}/"

      - name: "Upload Finanzas Portal to S3 (/finanzas prefix)"
        run: |
          echo "Uploading Finanzas Portal to S3 /finanzas/ prefix..."
          aws s3 sync dist-finanzas/ "s3://${S3_BUCKET_NAME}/finanzas/" \
            --exclude '*.map' \
            --delete
          echo "✅ Finanzas Portal uploaded to s3://${S3_BUCKET_NAME}/finanzas/"

      - name: "Invalidate CloudFront (all paths)"
        run: |
          echo "Invalidating CloudFront cache..."
          aws cloudfront create-invalidation \
            --distribution-id "${CLOUDFRONT_DIST_ID}" \
            --paths '/*'
          echo "✅ CloudFront invalidation queued"

      - name: "UI Smoke (PMO root /)"
        env:
          PMO_PREFIX: ""
        run: |
          set -euo pipefail
          DOMAIN=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
          ROOT="https://${DOMAIN}/"
          STATUS=$(curl -sS -o /dev/null -w '%{http_code}' "$ROOT")
          echo "## PMO Portal (root /)" >> $GITHUB_STEP_SUMMARY
          echo "URL: $ROOT" >> $GITHUB_STEP_SUMMARY
          echo "Status: $STATUS" >> $GITHUB_STEP_SUMMARY

      - name: "UI Smoke (Finanzas /finanzas/)"
        env:
          FINZ_PREFIX: /finanzas
        run: |
          set -euo pipefail
          DOMAIN=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
          ROOT="https://${DOMAIN}${FINZ_PREFIX}/"
          STATUS=$(curl -sS -o /dev/null -w '%{http_code}' "$ROOT")
          echo "## Finanzas Portal (/finanzas/)" >> $GITHUB_STEP_SUMMARY
          echo "URL: $ROOT" >> $GITHUB_STEP_SUMMARY
          echo "Status: $STATUS" >> $GITHUB_STEP_SUMMARY

      - name: "API Readiness Check (if DEV_API_URL set)"
        if: env.DEV_API_URL != ''
        run: |
          set -euo pipefail
          BASE="${DEV_API_URL%/}"
          echo "Checking API readiness at $BASE"
          for i in $(seq 1 6); do
            CODE=$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || true)
            if [ "$CODE" = "200" ]; then
              echo "API ready (health=200)"
              break
            fi
            echo "Waiting for API... (try $i, code=$CODE)"
            sleep 5
            if [ "$i" = "6" ]; then echo "⚠️  API not ready (will continue)"; fi
          done

      - name: "API Smokes (if DEV_API_URL set)"
        if: env.DEV_API_URL != ''
        env:
          DEV_API_URL: ${{ env.DEV_API_URL }}
        run: |
          set -euo pipefail
          BASE="${DEV_API_URL%/}"
          echo "## Post-Deploy API Smokes" >> $GITHUB_STEP_SUMMARY
          echo "Base: $BASE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Health (public)
          echo "### GET /health" >> $GITHUB_STEP_SUMMARY
          curl -sS -f "$BASE/health" | jq . >> $GITHUB_STEP_SUMMARY || echo "⚠️  Could not fetch /health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          {
            echo "## UIs Deployed (dev)"
            echo ""
            echo "### PMO Portal"
            echo "- Path: / (CloudFront root)"
            echo "- Build: dist-pmo/"
            echo ""
            echo "### Finanzas SDT Portal"
            echo "- Path: /finanzas/"
            echo "- Build: dist-finanzas/"
            echo "- API Base: ${VITE_API_BASE_URL:-'(not set)'}"
            echo "- API: ${FINZ_API_STACK}"
            echo ""
            echo "### Access"
            echo "- PMO: https://d7t9x3j66yd8k.cloudfront.net/"
            echo "- Finanzas: https://d7t9x3j66yd8k.cloudfront.net/finanzas/"
          } >> $GITHUB_STEP_SUMMARY
