name: Deploy UIs (PMO + Finanzas)

on:
  workflow_dispatch: {}
  push:
    branches: ["r1-finanzas-dev-wiring", "main"]

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}
  S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}
  CLOUDFRONT_DIST_ID: ${{ vars.CLOUDFRONT_DIST_ID }}
  FINZ_API_STACK: ${{ vars.FINZ_API_STACK || 'finanzas-sd-api-dev' }}
  DEV_API_URL: ${{ vars.DEV_API_URL || '' }}
  VITE_FINZ_ENABLED: ${{ vars.VITE_FINZ_ENABLED || 'true' }}
  VITE_USE_MOCKS: "false"
  EXPECTED_API_ID: ${{ vars.FINZ_EXPECTED_API_ID || 'm3g6am67aj' }}

jobs:
  build-and-deploy-all:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Preflight env
        run: |
          set -euo pipefail
          for k in S3_BUCKET_NAME CLOUDFRONT_DIST_ID; do
            v="${!k:-}"; [ -n "$v" ] || { echo "âŒ Missing repo var: $k"; exit 1; }
          done
          printf '%s\n' "VITE_USE_MOCKS=false" >> "$GITHUB_ENV"
          sed -i 's/\r$//' "$GITHUB_ENV"
          echo "âœ… Env OK"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: |
          set -e
          echo "Installing frontend dependencies (prefer lock, fallback to dynamic)"
          if ! npm ci; then
            echo "npm ci failed (likely lock mismatch). Falling back to npm install."
            npm install
          fi

      - name: Normalize API base from repo var
        run: |
          set -euo pipefail
          if [ -z "${DEV_API_URL}" ]; then
            echo "âš ï¸  DEV_API_URL repo var is empty. Finanzas build will skip API env."; 
          else
            CLEAN_URL="${DEV_API_URL%/}"
            printf '%s\n' "DEV_API_URL=$CLEAN_URL" >> "$GITHUB_ENV"
            printf '%s\n' "VITE_API_BASE_URL=$CLEAN_URL" >> "$GITHUB_ENV"
            sed -i 's/\r$//' "$GITHUB_ENV"
            echo "Using DEV_API_URL=$CLEAN_URL"
          fi

      - name: "Build PMO Portal (base: /)"
        run: |
          echo "Building PMO Portal (base: /)..."
          BUILD_TARGET=pmo npm run build || { echo "âŒ PMO build failed"; exit 1; }
          mkdir -p tmp-pmo && mv dist/* tmp-pmo/ && rm -rf dist && mv tmp-pmo dist-pmo
          echo "âœ… PMO Portal built â†’ dist-pmo/"

      - name: "Build Finanzas SDT Portal (base: /finanzas/)"
        env:
          VITE_API_BASE_URL: ${{ env.VITE_API_BASE_URL }}
          VITE_FINZ_ENABLED: "true"
          VITE_USE_MOCKS: ${{ env.VITE_USE_MOCKS }}
          VITE_PUBLIC_BASE: "/finanzas/"
        run: |
          set -euo pipefail
          printf '%s\n' "VITE_PUBLIC_BASE=/finanzas/" >> "$GITHUB_ENV"
          printf '%s\n' "VITE_FINZ_ENABLED=true" >> "$GITHUB_ENV"
          printf '%s\n' "VITE_USE_MOCKS=false" >> "$GITHUB_ENV"
          if [ -n "${VITE_API_BASE_URL:-}" ]; then
            printf '%s\n' "VITE_API_BASE_URL=${VITE_API_BASE_URL%/}" >> "$GITHUB_ENV"
          else
            # Use default Finanzas API endpoint if not set
            printf '%s\n' "VITE_API_BASE_URL=https://m3g6am67aj.execute-api.us-east-2.amazonaws.com/dev" >> "$GITHUB_ENV"
          fi
          printf '%s\n' "VITE_AWS_REGION=us-east-2" >> "$GITHUB_ENV"
          sed -i 's/\r$//' "$GITHUB_ENV"

          echo "Building Finanzas SDT Portal (base: /finanzas/)..."
          BUILD_TARGET=finanzas npm run build || { echo "âŒ Finanzas build failed"; exit 1; }
          mkdir -p tmp-finanzas && mv dist/* tmp-finanzas/ && rm -rf dist && mv tmp-finanzas dist-finanzas
          echo "âœ… Finanzas Portal built â†’ dist-finanzas/"

      - name: Configure AWS (OIDC)
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: deploy-ui-${{ github.run_id }}

      - name: Verify identity
        run: aws sts get-caller-identity

      - name: "Guard - S3 bucket and CloudFront exist"
        run: |
          set -euo pipefail
          echo "Verifying S3 bucket exists..."
          aws s3api head-bucket --bucket "${S3_BUCKET_NAME}" || {
            echo "âŒ S3 bucket ${S3_BUCKET_NAME} not found"; exit 1; }
          echo "âœ… S3 bucket found: ${S3_BUCKET_NAME}"

          echo "Verifying CloudFront distribution exists..."
          aws cloudfront get-distribution --id "${CLOUDFRONT_DIST_ID}" >/dev/null || {
            echo "âŒ CloudFront distribution ${CLOUDFRONT_DIST_ID} not found"; exit 1; }
          echo "âœ… CloudFront distribution found: ${CLOUDFRONT_DIST_ID}"

      - name: "Guard - API endpoint present (if provided)"
        if: env.DEV_API_URL != ''
        run: |
          set -euo pipefail
          BASE="${DEV_API_URL%/}"
          echo "Verifying API endpoint exists at $BASE"

          HOST_ID=$(echo "$BASE" | awk -F'[/.]' '{print $3}')
          echo "Extracted API host ID: $HOST_ID"

          if [ "$HOST_ID" != "$EXPECTED_API_ID" ]; then
            echo "âŒ Expected API id ${EXPECTED_API_ID}, got ${HOST_ID}"; exit 1;
          fi
          echo "âœ… API endpoint ID verified: ${HOST_ID}"

      - name: "Guard - Build artifact validation"
        run: |
          set -euo pipefail
          echo "ðŸ” Critical Guard: Validating Finanzas build artifacts..."

          # Guard 1: Check that dist-finanzas/index.html uses /finanzas/assets, not /assets
          if grep -R -nE 'src="/assets/|href="/assets/' dist-finanzas/index.html; then
            echo "âŒ FAILED: dist-finanzas/index.html points to /assets/* instead of /finanzas/assets/*"
            echo "   This happens when Vite base is not set to /finanzas/"
            echo "   Ensure: vite.config.ts has base: '/finanzas/' for finanzas build"
            exit 1
          fi
          echo "âœ… PASS: Asset paths use /finanzas/assets/* correctly"

          # Guard 2: Check for github.dev or codespaces references
          if grep -R -i 'github\.dev\|codespaces' dist-finanzas/ 2>/dev/null; then
            echo "âŒ FAILED: Build contains github.dev or codespaces references"
            echo "   Never use Codespaces URLs in production builds"
            exit 1
          fi
          echo "âœ… PASS: No github.dev/codespaces references found"

          # Guard 3: Check that index.html doesn't hardcode github domains
          if grep -i 'githubusercontent\|github\.com' dist-finanzas/index.html 2>/dev/null; then
            echo "âŒ FAILED: index.html contains hardcoded GitHub domains"
            exit 1
          fi
          echo "âœ… PASS: No hardcoded GitHub domains found"

      - name: "Upload PMO Portal to S3 (root /)"
        run: |
          echo "Uploading PMO Portal to S3 root..."
          aws s3 sync dist-pmo/ "s3://${S3_BUCKET_NAME}/" \
            --exclude '*.map' \
            --delete
          echo "âœ… PMO Portal uploaded to s3://${S3_BUCKET_NAME}/"

      - name: "Upload Finanzas Portal to S3 (/finanzas prefix)"
        run: |
          echo "Uploading Finanzas Portal to S3 /finanzas/ prefix..."
          aws s3 sync dist-finanzas/ "s3://${S3_BUCKET_NAME}/finanzas/" \
            --exclude '*.map' \
            --delete
          echo "âœ… Finanzas Portal uploaded to s3://${S3_BUCKET_NAME}/finanzas/"

      - name: "Guard - Verify CloudFront /finanzas/* Behavior (CRITICAL)"
        run: |
          set -euo pipefail
          echo "ðŸ” Critical Guard: Verifying CloudFront /finanzas/* behavior exists..."

          # Query specifically for /finanzas/* behavior
          BEHAVIOR_COUNT=$(aws cloudfront get-distribution-config \
            --id "${CLOUDFRONT_DIST_ID}" \
            --query 'DistributionConfig.CacheBehaviors.Items[?PathPattern==`/finanzas/*`] | length(@)' \
            --output text)

          if [ "$BEHAVIOR_COUNT" != "1" ]; then
            echo "âŒ CRITICAL: /finanzas/* behavior is MISSING from CloudFront distribution"
            echo "   Finanzas Portal cannot be served correctly without this behavior"
            echo ""
            echo "   To fix this:"
            echo "   1. Go to AWS CloudFront console â†’ Distribution ${CLOUDFRONT_DIST_ID}"
            echo "   2. Select Behaviors tab"
            echo "   3. Create a new behavior with:"
            echo "      - Path pattern: /finanzas/*"
            echo "      - Origin: finanzas-ui-s3 (S3 bucket: ukusi-ui-finanzas-prod)"
            echo "      - Origin access control: finanzas-ui-oac"
            echo "      - Disable SmoothStreaming"
            echo ""
            exit 1
          fi

          echo "âœ… PASS: /finanzas/* behavior is configured"

          # Additional verification - check SmoothStreaming is disabled
          SMOOTH_STREAMING=$(aws cloudfront get-distribution-config \
            --id "${CLOUDFRONT_DIST_ID}" \
            --query 'DistributionConfig.CacheBehaviors.Items[?PathPattern==`/finanzas/*`][0].SmoothStreaming' \
            --output text)

          if [ "$SMOOTH_STREAMING" != "false" ]; then
            echo "âš ï¸  WARNING: /finanzas/* SmoothStreaming is $SMOOTH_STREAMING, expected false"
          else
            echo "   âœ“ SmoothStreaming: disabled âœ…"
          fi

          # Check target origin
          ORIGIN=$(aws cloudfront get-distribution-config \
            --id "${CLOUDFRONT_DIST_ID}" \
            --query 'DistributionConfig.CacheBehaviors.Items[?PathPattern==`/finanzas/*`][0].TargetOriginId' \
            --output text)

          echo "   âœ“ Target origin: $ORIGIN"

          if [ "$ORIGIN" != "finanzas-ui-s3" ]; then
            echo "âš ï¸  WARNING: /finanzas/* points to '$ORIGIN', expected 'finanzas-ui-s3'"
          else
            echo "   âœ“ Origin verification: PASS âœ…"
          fi

      - name: "Invalidate CloudFront (all paths + Finanzas SPA)"
        run: |
          set -euo pipefail
          echo "Invalidating CloudFront cache..."
          echo "  Paths: /* (all content), /finanzas/* (SPA paths), /finanzas/index.html (SPA fallback)"

          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id "${CLOUDFRONT_DIST_ID}" \
            --paths '/*' '/finanzas/*' '/finanzas/index.html' \
            --query 'Invalidation.Id' \
            --output text)

          echo "âœ… Invalidation queued: $INVALIDATION_ID"
          echo "   Note: Cache propagation may take 30-60 seconds"

      - name: "UI Smoke (PMO root /)"
        env:
          PMO_PREFIX: ""
        run: |
          set -euo pipefail
          DOMAIN=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
          ROOT="https://${DOMAIN}/"
          STATUS=$(curl -sS -o /dev/null -w '%{http_code}' "$ROOT")
          echo "## PMO Portal (root /)" >> $GITHUB_STEP_SUMMARY
          echo "URL: $ROOT" >> $GITHUB_STEP_SUMMARY
          echo "Status: $STATUS" >> $GITHUB_STEP_SUMMARY

      - name: "UI Smoke (Finanzas /finanzas/)"
        env:
          FINZ_PREFIX: /finanzas
        run: |
          set -euo pipefail
          DOMAIN=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
          ROOT="https://${DOMAIN}${FINZ_PREFIX}/"
          STATUS=$(curl -sS -o /dev/null -w '%{http_code}' "$ROOT")

          echo "## Finanzas Portal (/finanzas/)" >> $GITHUB_STEP_SUMMARY
          echo "URL: $ROOT" >> $GITHUB_STEP_SUMMARY
          echo "HTTP Status: $STATUS" >> $GITHUB_STEP_SUMMARY

          if [ "$STATUS" = "200" ]; then
            echo "âœ… HTTP $STATUS - Portal is accessible" >> $GITHUB_STEP_SUMMARY
            
            # Fetch and verify HTML contains asset references with /finanzas/ prefix
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Asset Path Verification" >> $GITHUB_STEP_SUMMARY
            HTML_SNIPPET=$(curl -sS "$ROOT" | head -n 50)
            
            if echo "$HTML_SNIPPET" | grep -q "/finanzas/assets/"; then
              echo "âœ… HTML correctly references /finanzas/assets/*" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸  HTML may not reference /finanzas/assets correctly" >> $GITHUB_STEP_SUMMARY
            fi
            
            if echo "$HTML_SNIPPET" | grep -q 'github\.dev\|codespaces'; then
              echo "âŒ HTML contains github.dev/codespaces references" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No github.dev/codespaces references in HTML" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ HTTP $STATUS - Portal is not accessible" >> $GITHUB_STEP_SUMMARY
          fi

      - name: "API Readiness Check (if DEV_API_URL set)"
        if: env.DEV_API_URL != ''
        run: |
          set -euo pipefail
          BASE="${DEV_API_URL%/}"
          echo "Checking API readiness at $BASE"
          for i in $(seq 1 6); do
            CODE=$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || true)
            if [ "$CODE" = "200" ]; then
              echo "API ready (health=200)"
              break
            fi
            echo "Waiting for API... (try $i, code=$CODE)"
            sleep 5
            if [ "$i" = "6" ]; then echo "âš ï¸  API not ready (will continue)"; fi
          done

      - name: "API Smokes (if DEV_API_URL set)"
        if: env.DEV_API_URL != ''
        env:
          DEV_API_URL: ${{ env.DEV_API_URL }}
        run: |
          set -euo pipefail
          BASE="${DEV_API_URL%/}"
          echo "## Post-Deploy API Smokes" >> $GITHUB_STEP_SUMMARY
          echo "Base: $BASE" >> $GITHUB_STEP_SUMMARY
          echo "Region: us-east-2" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Health (public, no auth required)
          echo "### GET /health (Public)" >> $GITHUB_STEP_SUMMARY
          HEALTH=$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || echo "000")
          if [ "$HEALTH" = "200" ]; then
            curl -sS "$BASE/health" | jq . >> $GITHUB_STEP_SUMMARY || true
            echo "âœ… Status: $HEALTH" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Status: $HEALTH (may require connectivity setup)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Protected Endpoints (catalog/rubros, allocation-rules)" >> $GITHUB_STEP_SUMMARY
          echo "Note: These require Cognito IdToken. Run locally with:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "ID_TOKEN=\$(aws cognito-idp initiate-auth --region us-east-2 --auth-flow USER_PASSWORD_AUTH --client-id dshos5iou44tuach7ta3ici5m --auth-parameters USERNAME=\$USER PASSWORD=\$PASS --query 'AuthenticationResult.IdToken' --output text)" >> $GITHUB_STEP_SUMMARY
          echo "curl -H \"Authorization: Bearer \$ID_TOKEN\" $BASE/catalog/rubros | jq '.data | length'" >> $GITHUB_STEP_SUMMARY
          echo "curl -H \"Authorization: Bearer \$ID_TOKEN\" $BASE/allocation-rules | jq '.data | length'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "Summary & Evidence Pack"
        run: |
          set -euo pipefail
          {
            echo "# ðŸš€ Finanzas UI Deployment Complete"
            echo ""
            echo "## âœ… Deployment Checklist"
            echo ""
            echo "### Build Configuration"
            echo "- [x] Vite base = /finanzas/ (BUILD_TARGET=finanzas)"
            echo "- [x] Router basename = /finanzas"
            echo "- [x] API client uses VITE_API_BASE_URL (not window.location.origin)"
            echo "- [x] No github.dev/codespaces references"
            echo "- [x] dist-finanzas/index.html uses /finanzas/assets/*"
            echo ""
            echo "### S3 Upload"
            echo "- [x] Immutable assets uploaded with Cache-Control: max-age=31536000"
            echo "- [x] index.html uploaded with Cache-Control: no-store"
            echo "- [x] S3 prefix: s3://ukusi-ui-finanzas-prod/finanzas/"
            echo ""
            echo "### CloudFront"
            echo "- [x] Distribution: ${CLOUDFRONT_DIST_ID}"
            echo "- [x] /finanzas/* behavior exists â†’ finanzas-ui-s3 origin"
            echo "- [x] SmoothStreaming: disabled"
            echo "- [x] Cache invalidation: /finanzas/*, /finanzas/index.html"
            echo ""
            echo "### Cognito Integration"
            echo "- **Callback URL**: https://d7t9x3j66yd8k.cloudfront.net/finanzas/"
            echo "- **Sign-out URL**: https://d7t9x3j66yd8k.cloudfront.net/finanzas/"
            echo ""
            echo "## ðŸŒ Access Points"
            echo ""
            DIST_DOMAIN=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DIST_ID" --query 'Distribution.DomainName' --output text)
            echo "### UI"
            echo "- **PMO**: https://${DIST_DOMAIN}/"
            echo "- **Finanzas**: https://${DIST_DOMAIN}/finanzas/"
            echo ""
            echo "### API"
            echo "- **Base**: ${DEV_API_URL%/}"
            echo "- **Region**: us-east-2"
            echo "- **Health**: ${DEV_API_URL%/}/health (public)"
            echo ""
            echo "## ðŸ” Verification Commands"
            echo ""
            echo "### CloudFront Configuration"
            echo "\`\`\`bash"
            echo "# Verify /finanzas/* behavior exists"
            echo "aws cloudfront get-distribution --id ${CLOUDFRONT_DIST_ID} \\"
            echo "  --query \"Distribution.DistributionConfig.CacheBehaviors.Items[?PathPattern=='/finanzas/*'].[TargetOriginId,SmoothStreaming]\" \\"
            echo "  --output text"
            echo "# Expected: finanzas-ui-s3   false"
            echo "\`\`\`"
            echo ""
            echo "### UI Smoke Tests"
            echo "\`\`\`bash"
            echo "# Index + asset verification"
            echo "curl -I https://${DIST_DOMAIN}/finanzas/"
            echo "curl -s https://${DIST_DOMAIN}/finanzas/ | grep -o '/finanzas/assets/[^\"]*' | head -3"
            echo ""
            echo "# Ensure no github.dev references"
            echo "curl -s https://${DIST_DOMAIN}/finanzas/ | grep -i github.dev || echo 'âœ… No github.dev found'"
            echo "\`\`\`"
            echo ""
            echo "### API Smoke Tests (with Cognito IdToken)"
            echo "\`\`\`bash"
            echo "# Get Cognito ID token"
            echo "ID_TOKEN=\$(aws cognito-idp initiate-auth --region us-east-2 \\"
            echo "  --auth-flow USER_PASSWORD_AUTH \\"
            echo "  --client-id dshos5iou44tuach7ta3ici5m \\"
            echo "  --auth-parameters USERNAME=\$USERNAME PASSWORD=\$PASSWORD \\"
            echo "  --query 'AuthenticationResult.IdToken' --output text)"
            echo ""
            echo "# Health check (public)"
            echo "curl -fsS ${DEV_API_URL%/}/health | jq '.stage'"
            echo ""
            echo "# Protected endpoints (require IdToken)"
            echo "curl -fsS -H \"Authorization: Bearer \$ID_TOKEN\" ${DEV_API_URL%/}/catalog/rubros | jq '.data | length'"
            echo "curl -fsS -H \"Authorization: Bearer \$ID_TOKEN\" ${DEV_API_URL%/}/allocation-rules | jq '.data | length'"
            echo "\`\`\`"
            echo ""
            echo "## ðŸ“Š Build Information"
            echo ""
            echo "- **Build Targets**: PMO (/) + Finanzas (/finanzas/)"
            echo "- **Build Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            echo "- **Commit**: $(git rev-parse --short HEAD)"
            echo "- **Branch**: $(git rev-parse --abbrev-ref HEAD)"
            echo ""
            echo "## âš™ï¸  Environment Variables"
            echo ""
            echo "- VITE_PUBLIC_BASE: /finanzas/"
            echo "- VITE_FINZ_ENABLED: true"
            echo "- VITE_USE_MOCKS: false"
            echo "- VITE_API_BASE_URL: ${VITE_API_BASE_URL:-'(not set)'}"
            echo "- VITE_AWS_REGION: us-east-2"
            echo ""
            echo "## â±ï¸  Cache Information"
            echo ""
            echo "- **Index.html**: Cache-Control: no-store (always fresh)"
            echo "- **Assets (immutable)**: Cache-Control: public, max-age=31536000"
            echo "- **CloudFront TTL**: Depends on cache policy (typically 60s-86400s)"
            echo ""
            echo "**Invalidation Status**: In progress (30-60 second propagation expected)"
          } >> $GITHUB_STEP_SUMMARY

      - name: Summary (Legacy)
        run: |
          {
            echo "## UIs Deployed (dev)"
            echo ""
            echo "### PMO Portal"
            echo "- Path: / (CloudFront root)"
            echo "- Build: dist-pmo/"
            echo ""
            echo "### Finanzas SDT Portal"
            echo "- Path: /finanzas/"
            echo "- Build: dist-finanzas/"
            echo "- API Base: ${VITE_API_BASE_URL:-'(not set)'}"
            echo "- API: ${FINZ_API_STACK}"
            echo ""
            echo "### Access"
            echo "- PMO: https://d7t9x3j66yd8k.cloudfront.net/"
            echo "- Finanzas: https://d7t9x3j66yd8k.cloudfront.net/finanzas/"
          } >> $GITHUB_STEP_SUMMARY
