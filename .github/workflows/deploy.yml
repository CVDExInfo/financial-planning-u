name: Deploy Financial UI

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  S3_BUCKET: ${{ vars.S3_BUCKET_NAME }}
  DIST_ID: ${{ vars.CLOUDFRONT_DIST_ID }}
  VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
  VITE_ACTA_API_ID: ${{ vars.VITE_ACTA_API_ID }}

jobs:
  preflight-checks:
    name: Preflight Checks
    runs-on: ubuntu-latest
    steps:
      - name: Verify Required Variables
        run: |
          echo "Verifying required environment variables..."
          
          if [ "${{ vars.AWS_REGION }}" != "us-east-2" ]; then
            echo "❌ ERROR: AWS_REGION must be us-east-2, got: ${{ vars.AWS_REGION }}"
            exit 1
          fi
          
          if [ "${{ vars.CLOUDFRONT_DIST_ID }}" != "EPQU7PVDLQXUA" ]; then
            echo "❌ ERROR: CLOUDFRONT_DIST_ID must be EPQU7PVDLQXUA, got: ${{ vars.CLOUDFRONT_DIST_ID }}"
            exit 1
          fi
          
          if [ "${{ vars.DISTRIBUTION_DOMAIN_NAME }}" != "d7t9x3j66yd8k.cloudfront.net" ]; then
            echo "❌ ERROR: DISTRIBUTION_DOMAIN_NAME must be d7t9x3j66yd8k.cloudfront.net, got: ${{ vars.DISTRIBUTION_DOMAIN_NAME }}"
            exit 1
          fi
          
          if [ -z "${{ secrets.OIDC_AWS_ROLE_ARN }}" ]; then
            echo "❌ ERROR: OIDC_AWS_ROLE_ARN secret is not set"
            exit 1
          fi
          
          echo "✅ All preflight checks passed"
          echo "   Region: ${{ vars.AWS_REGION }}"
          echo "   Distribution: ${{ vars.CLOUDFRONT_DIST_ID }}"
          echo "   Domain: ${{ vars.DISTRIBUTION_DOMAIN_NAME }}"
          echo "   S3 Bucket: ${{ vars.S3_BUCKET_NAME }}"

  build-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: preflight-checks
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build Application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Configure AWS Credentials (OIDC)
        id: configure-aws-oidc
        continue-on-error: true
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: deploy-${{ github.run_id }}

      - name: Fallback to Static Credentials (If Needed)
        if: steps.configure-aws-oidc.outcome == 'failure' && vars.FALLBACK_STATIC_KEYS == 'true'
        run: |
          echo "⚠️  OIDC authentication failed. Using static credentials fallback."
          echo "   This is a temporary measure and should be replaced with OIDC."
          
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ] || [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "❌ ERROR: Static credentials not available"
            exit 1
          fi
          
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=${{ env.AWS_REGION }}" >> $GITHUB_ENV
          echo "✅ Static credentials configured"

      - name: Verify Authentication Method
        run: |
          if [ "${{ steps.configure-aws-oidc.outcome }}" = "success" ]; then
            echo "✅ Using OIDC authentication (preferred)"
          else
            echo "⚠️  Using static credentials (fallback)"
          fi
          aws sts get-caller-identity

      - name: Verify S3 Bucket Access
        run: |
          echo "Verifying access to S3 bucket: $S3_BUCKET"
          if aws s3 ls "s3://$S3_BUCKET" > /dev/null 2>&1; then
            echo "✅ S3 bucket exists and is accessible"
          else
            echo "⚠️  S3 bucket not found. Creating bucket..."
            
            # Create bucket in us-east-2
            aws s3api create-bucket \
              --bucket "$S3_BUCKET" \
              --region "$AWS_REGION" \
              --create-bucket-configuration LocationConstraint="$AWS_REGION"
            
            # Block all public access
            aws s3api put-public-access-block \
              --bucket "$S3_BUCKET" \
              --public-access-block-configuration \
                "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
            
            # Enable versioning for rollback capability
            aws s3api put-bucket-versioning \
              --bucket "$S3_BUCKET" \
              --versioning-configuration Status=Enabled
            
            # Enable server-side encryption
            aws s3api put-bucket-encryption \
              --bucket "$S3_BUCKET" \
              --server-side-encryption-configuration '{
                "Rules": [{
                  "ApplyServerSideEncryptionByDefault": {
                    "SSEAlgorithm": "AES256"
                  },
                  "BucketKeyEnabled": true
                }]
              }'
            
            echo "✅ S3 bucket created successfully with:"
            echo "   - Public access blocked"
            echo "   - Versioning enabled"
            echo "   - Encryption enabled (AES256)"
            echo ""
            echo "⚠️  IMPORTANT: Configure CloudFront OAC bucket policy manually:"
            echo "   See docs/ops/readme.md for the required bucket policy"
          fi

      - name: Upload to S3
        run: |
          echo "Syncing files to S3 bucket: $S3_BUCKET"
          aws s3 sync dist/ s3://$S3_BUCKET/ --delete --cache-control "public,max-age=31536000,immutable" --exclude "index.html" --exclude "*.html"
          aws s3 sync dist/ s3://$S3_BUCKET/ --cache-control "public,max-age=0,must-revalidate" --exclude "*" --include "index.html" --include "*.html"
          echo "✅ Files synced successfully"

      - name: Invalidate CloudFront Cache
        run: |
          echo "Creating CloudFront invalidation for distribution: $DIST_ID"
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id $DIST_ID \
            --paths "/finanzas/*" \
            --query 'Invalidation.Id' \
            --output text)
          echo "✅ Invalidation created: $INVALIDATION_ID"
          echo "   View status at: https://console.aws.amazon.com/cloudfront/v3/home#/distributions/$DIST_ID"

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Deployment completed successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Distribution**: $DIST_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Domain**: ${{ vars.DISTRIBUTION_DOMAIN_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Path**: /finanzas/*" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: $S3_BUCKET" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: $AWS_REGION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access URLs" >> $GITHUB_STEP_SUMMARY
          echo "- https://${{ vars.DISTRIBUTION_DOMAIN_NAME }}/finanzas/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rollback" >> $GITHUB_STEP_SUMMARY
          echo "To rollback, restore the previous S3 bucket version:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "aws s3api list-object-versions --bucket $S3_BUCKET --prefix index.html" >> $GITHUB_STEP_SUMMARY
          echo "# Then restore specific version as needed" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
