name: Allocations Smoke Test (OIDC)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test (dev or prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      projectId:
        description: 'Project ID to test (optional, will use first from list if not provided)'
        required: false
        type: string
      baselineId:
        description: 'Baseline ID to test (optional)'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}
  DEPLOYMENT_ENV: ${{ github.event.inputs.environment || 'dev' }}
  # Note: API URLs should ideally be in repository variables, using fallback values for backward compatibility
  FINZ_API_URL: ${{ github.event.inputs.environment == 'prod' && 'https://m3g6am67aj.execute-api.us-east-2.amazonaws.com/prod' || (vars.DEV_API_URL || 'https://m3g6am67aj.execute-api.us-east-2.amazonaws.com/dev') }}

jobs:
  allocations-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Normalize line endings for local actions
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dos2unix
          find .github/actions -type f -print0 | xargs -0 dos2unix || true

      - name: Configure AWS credentials via OIDC
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: allocations-smoke-${{ github.run_id }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Generate JWT for API authentication
        id: jwt
        uses: ./.github/actions/cognito-generate-jwt
        with:
          user_pool_id: ${{ vars.COGNITO_USER_POOL_ID }}
          client_id: ${{ vars.COGNITO_WEB_CLIENT }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          aws_region: ${{ env.AWS_REGION }}

      - name: Wait for API health check
        env:
          BASE: ${{ env.FINZ_API_URL }}
        run: |
          set -euo pipefail
          for i in $(seq 1 12); do
            CODE=$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || true)
            if [ "$CODE" = "200" ]; then
              echo "✅ API ready (health=200)"; break
            fi
            echo "⏳ Waiting for API... (attempt $i, code=$CODE)"; sleep 5
            if [ "$i" = "12" ]; then echo "❌ API not ready"; exit 1; fi
          done

      - name: Run allocations smoke tests
        env:
          FINANZAS_API_BASE: ${{ env.FINZ_API_URL }}
          FINANZAS_COGNITO_REGION: ${{ env.AWS_REGION }}
          FINANZAS_COGNITO_CLIENT_ID: ${{ vars.COGNITO_WEB_CLIENT }}
          FINANZAS_COGNITO_USERNAME: ${{ secrets.USERNAME }}
          FINANZAS_COGNITO_PASSWORD: ${{ secrets.PASSWORD }}
          FINANZAS_PROJECT_ID: ${{ github.event.inputs.projectId }}
          FINANZAS_BASELINE_ID: ${{ github.event.inputs.baselineId }}
        run: |
          set -euo pipefail
          echo "# Allocations Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${DEPLOYMENT_ENV}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL**: ${FINANZAS_API_BASE}" >> $GITHUB_STEP_SUMMARY
          if [ -n "$FINANZAS_PROJECT_ID" ]; then
            echo "**Project ID**: ${FINANZAS_PROJECT_ID}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "$FINANZAS_BASELINE_ID" ]; then
            echo "**Baseline ID**: ${FINANZAS_BASELINE_ID}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run the smoke script and capture output
          node scripts/finanzas-api-smoke.mjs 2>&1 | tee smoke-output.log
          
          # Check if Allocations GET test passed
          if grep -q "Allocations GET" smoke-output.log && grep -q "✅ Success" smoke-output.log; then
            echo "## ✅ Allocations GET Test Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Allocations GET Test Failed" >> $GITHUB_STEP_SUMMARY
            echo "See logs below for details" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Add relevant output to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -A 10 "Allocations GET" smoke-output.log >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Validate allocations response structure
        if: success()
        env:
          FINANZAS_API_BASE: ${{ env.FINZ_API_URL }}
          TOKEN: ${{ steps.jwt.outputs.access_token }}
        run: |
          set -euo pipefail
          
          # Get a project from the list
          PROJECTS_JSON=$(curl -sS -f -H "Authorization: Bearer $TOKEN" "$FINANZAS_API_BASE/projects")
          PROJECT_ID=$(echo "$PROJECTS_JSON" | jq -r '.[0].project_id // .[0].id' | head -1)
          
          if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
            echo "⚠️ No projects found to test allocations endpoint"
            exit 0
          fi
          
          echo "Testing allocations endpoint with projectId=$PROJECT_ID"
          
          # Call allocations endpoint
          ALLOC_JSON=$(curl -sS -f -H "Authorization: Bearer $TOKEN" "$FINANZAS_API_BASE/allocations?projectId=$PROJECT_ID")
          
          # Validate response structure
          HAS_DATA=$(echo "$ALLOC_JSON" | jq 'has("data")')
          IS_ARRAY=$(echo "$ALLOC_JSON" | jq '.data | type == "array"')
          
          if [ "$HAS_DATA" != "true" ]; then
            echo "❌ Response missing 'data' field"
            exit 1
          fi
          
          if [ "$IS_ARRAY" != "true" ]; then
            echo "❌ Response 'data' is not an array"
            exit 1
          fi
          
          COUNT=$(echo "$ALLOC_JSON" | jq '.data | length')
          echo "✅ Allocations endpoint returned valid response with $COUNT items"
          
          # If we have items, validate structure
          if [ "$COUNT" -gt 0 ]; then
            FIRST_ITEM=$(echo "$ALLOC_JSON" | jq '.data[0]')
            HAS_RUBRO=$(echo "$FIRST_ITEM" | jq 'has("rubroId") or has("rubro_id")')
            HAS_AMOUNT=$(echo "$FIRST_ITEM" | jq 'has("amount")')
            
            if [ "$HAS_RUBRO" != "true" ]; then
              echo "⚠️ Warning: First allocation item missing rubroId/rubro_id"
            fi
            
            if [ "$HAS_AMOUNT" != "true" ]; then
              echo "⚠️ Warning: First allocation item missing amount field"
            fi
            
            echo "Sample allocation item:"
            echo "$FIRST_ITEM" | jq '.'
          fi

      - name: Collect AllocationsFn logs on failure
        if: failure()
        env:
          STACK: ${{ github.event.inputs.environment == 'prod' && 'finanzas-sd-api-prod' || 'finanzas-sd-api-dev' }}
        run: |
          set -euo pipefail
          
          # Try to get the allocations Lambda function name
          FN=$(aws cloudformation list-stack-resources --stack-name "$STACK" \
            --query "StackResourceSummaries[?contains(LogicalResourceId, 'Allocations')].PhysicalResourceId" \
            --output text | head -1)
          
          if [ -z "$FN" ]; then
            echo "⚠️ Could not find Allocations Lambda function in stack $STACK"
            exit 0
          fi
          
          echo "### CloudWatch Logs for $FN" >> $GITHUB_STEP_SUMMARY
          LOG_GROUP="/aws/lambda/$FN"
          
          # Get the most recent log stream
          STREAM=$(aws logs describe-log-streams \
            --log-group-name "$LOG_GROUP" \
            --order-by LastEventTime \
            --descending \
            --max-items 1 \
            --query 'logStreams[0].logStreamName' \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$STREAM" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            aws logs get-log-events \
              --log-group-name "$LOG_GROUP" \
              --log-stream-name "$STREAM" \
              --limit 100 \
              --query 'events[].message' \
              --output text | tail -n 100 >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No recent log streams found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload smoke test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allocations-smoke-logs-${{ github.event.inputs.environment }}
          path: smoke-output.log
          retention-days: 7
