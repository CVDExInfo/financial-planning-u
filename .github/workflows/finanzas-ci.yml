name: Finanzas CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-unit:
    name: Unit tests (fast)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('services/finanzas-api/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        working-directory: services/finanzas-api
        run: |
          rm -rf node_modules
          pnpm install --frozen-lockfile

      - name: Run unit tests
        working-directory: services/finanzas-api
        env:
          NODE_OPTIONS: --experimental-vm-modules
          SKIP_INTEGRATION_TESTS: "true"
        run: pnpm -s run test:unit

      - name: Upload unit test artifacts (optional)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: finanzas-unit-test-logs
          path: services/finanzas-api/jest*.log

  # TODO: Integration tests previously depended on seeded canonical projects data.
  # This job has been removed as part of removing seed:canonical-projects script.
  # If integration tests are needed in the future, they should be reworked to use
  # explicit test fixtures or a new data setup approach that doesn't rely on
  # the canonical-projects seed script.

  check-forbidden-rubros:
    name: Check for non-canonical rubro literals
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan for non-canonical rubro literals
        run: |
          echo "Checking for non-canonical rubro literals..."
          echo "Loading canonical IDs from data/rubros.taxonomy.json..."
          
          # Extract canonical IDs from taxonomy JSON
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo apt-get update -qq && sudo apt-get install -qq -y jq
          fi
          
          CANONICAL_IDS=$(jq -r '.items[].linea_codigo' data/rubros.taxonomy.json | sort -u)
          CANONICAL_COUNT=$(echo "$CANONICAL_IDS" | wc -l)
          
          echo "Loaded $CANONICAL_COUNT canonical rubro IDs"
          echo ""
          
          # Create a temporary file with canonical IDs for fast lookup
          echo "$CANONICAL_IDS" > /tmp/canonical-ids.txt
          
          # Search for rubro-like patterns in source code
          # Pattern: MOD-*, GSV-*, TEC-*, etc. (category code followed by hyphen and identifier)
          echo "Scanning for rubro-like patterns in source code..."
          
          # Find all potential rubro IDs in TypeScript/JavaScript files
          # Exclude: comments, imports, tests, canonical-taxonomy definitions, docs
          POTENTIAL_RUBROS=$(git grep -h -o -E '\b[A-Z]{3}-[A-Z0-9-]+\b' -- \
            '*.ts' '*.tsx' '*.js' '*.jsx' \
            ':!node_modules' \
            ':!.git' \
            ':!dist' \
            ':!build' \
            ':!**/canonical-taxonomy.ts' \
            ':!**/__tests__/**' \
            ':!*.md' \
            ':!data/rubros.taxonomy.json' \
            ':!scripts/**' \
            2>/dev/null | sort -u || true)
          
          if [ -z "$POTENTIAL_RUBROS" ]; then
            echo "✅ No rubro-like patterns found in source code"
            exit 0
          fi
          
          echo "Found $(echo "$POTENTIAL_RUBROS" | wc -l) unique rubro-like patterns"
          echo ""
          
          FOUND_VIOLATIONS=0
          NON_CANONICAL_IDS=""
          
          # Check each potential rubro against canonical list
          while IFS= read -r rubro; do
            [ -z "$rubro" ] && continue
            
            # Check if it's in the canonical list
            if ! grep -q "^${rubro}$" /tmp/canonical-ids.txt; then
              # Found a non-canonical ID, now check if it's actually used in code
              # (not just in a comment or string for documentation)
              MATCHES=$(git grep -n "\b${rubro}\b" -- \
                '*.ts' '*.tsx' '*.js' '*.jsx' \
                ':!node_modules' \
                ':!.git' \
                ':!dist' \
                ':!build' \
                ':!**/canonical-taxonomy.ts' \
                ':!**/__tests__/**' \
                ':!*.md' \
                ':!data/rubros.taxonomy.json' \
                ':!scripts/**' \
                2>/dev/null || true)
              
              if [ -n "$MATCHES" ]; then
                echo "❌ Non-canonical rubro ID: $rubro"
                echo "$MATCHES" | head -5
                echo ""
                FOUND_VIOLATIONS=1
                NON_CANONICAL_IDS="${NON_CANONICAL_IDS}${rubro}\n"
              fi
            fi
          done <<< "$POTENTIAL_RUBROS"
          
          if [ $FOUND_VIOLATIONS -eq 1 ]; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "❌ FAIL: Found non-canonical rubro IDs in source code"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "The following rubro IDs are NOT in data/rubros.taxonomy.json:"
            echo -e "$NON_CANONICAL_IDS"
            echo ""
            echo "Action required:"
            echo "1. If these are legitimate rubros, add them to data/rubros.taxonomy.json"
            echo "2. If these are legacy IDs, add mapping in LEGACY_RUBRO_ID_MAP (canonical-taxonomy.ts)"
            echo "3. If these are typos or mistakes, correct them to use canonical IDs"
            echo ""
            echo "See data/rubros.taxonomy.json for the complete list of canonical IDs"
            exit 1
          else
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "✅ PASS: All rubro IDs in source code are canonical"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          fi
