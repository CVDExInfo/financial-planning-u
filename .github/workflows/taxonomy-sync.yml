name: Taxonomy Sync and Deploy

on:
  push:
    paths:
      - 'data/rubros.taxonomy.json'
    branches:
      - main
      - develop
  workflow_dispatch:

# Top-level permissions: grant actions write so createWorkflowDispatch works
permissions:
  id-token: write
  contents: read
  actions: write

jobs:
  validate-taxonomy:
    name: Validate Taxonomy JSON
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate JSON structure
        run: |
          echo "Validating /data/rubros.taxonomy.json..."
          # Check if file exists
          if [ ! -f data/rubros.taxonomy.json ]; then
            echo "âŒ Taxonomy file not found at data/rubros.taxonomy.json"
            exit 1
          fi
          # Validate JSON syntax
          if ! jq empty data/rubros.taxonomy.json 2>&1; then
            echo "âŒ Invalid JSON syntax in taxonomy file"
            exit 1
          fi
          # Check required fields
          SCHEMA=$(jq -r '.schema' data/rubros.taxonomy.json)
          if [ "$SCHEMA" != "rubros-taxonomy/v1" ]; then
            echo "âŒ Invalid or missing schema field."
            echo "   Expected 'rubros-taxonomy/v1', got '$SCHEMA'"
            exit 1
          fi
          # Check items array exists and has entries
          ITEMS_COUNT=$(jq '.items | length' data/rubros.taxonomy.json)
          if [ "$ITEMS_COUNT" -eq 0 ]; then
            echo "âŒ Taxonomy must contain at least one item"
            exit 1
          fi
          echo "âœ… Taxonomy validation passed"
          echo "   Schema: $SCHEMA"
          echo "   Items: $ITEMS_COUNT"
          # Validate each item has required fields
          MISSING_FIELDS=$(jq -r '
            .items[] |
            select(
              .linea_codigo == null or
              .categoria_codigo == null or
              .linea_gasto == null or
              .tipo_costo == null or
              .tipo_ejecucion == null
            ) |
            .linea_codigo // "unknown"
          ' data/rubros.taxonomy.json)
          if [ -n "$MISSING_FIELDS" ]; then
            echo "âŒ Some items are missing required fields: $MISSING_FIELDS"
            exit 1
          fi
          echo "âœ… All items have required fields"
      - name: Check for duplicate IDs
        run: |
          echo "Checking for duplicate linea_codigo values..."
          DUPLICATES=$(jq -r \
            '.items[].linea_codigo' data/rubros.taxonomy.json | \
            sort | uniq -d)
          if [ -n "$DUPLICATES" ]; then
            echo "âŒ Found duplicate linea_codigo values:"
            echo "$DUPLICATES"
            exit 1
          fi
          echo "âœ… No duplicate IDs found"

  deploy-artifacts:
    name: Deploy Taxonomy Artifacts
    needs: validate-taxonomy
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws-region: us-east-2

      - name: Upload taxonomy to existing S3 bucket
        env:
          AWS_REGION: us-east-2
        run: |
          S3_BUCKET="ukusi-ui-finanzas-prod"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)

          aws s3 cp data/rubros.taxonomy.json \
            "s3://${S3_BUCKET}/taxonomy/rubros.taxonomy.json" \
            --acl bucket-owner-full-control \
            --sse AES256 \
            --metadata \
            "commit-sha=${{ github.sha }},branch=${{ github.ref_name }},timestamp=${TIMESTAMP}"

          aws s3 cp data/rubros.taxonomy.json \
            "s3://${S3_BUCKET}/taxonomy/archive/rubros.taxonomy.${TIMESTAMP}.json" \
            --acl bucket-owner-full-control \
            --sse AES256 \
            --metadata \
            "commit-sha=${{ github.sha }},branch=${{ github.ref_name }}"

          aws s3 cp data/rubros.taxonomy.json \
            "s3://${S3_BUCKET}/taxonomy/rubros.taxonomy.latest.json" \
            --acl bucket-owner-full-control \
            --sse AES256 \
            --metadata \
            "commit-sha=${{ github.sha }},branch=${{ github.ref_name }},timestamp=${TIMESTAMP}"

          echo "âœ… Taxonomy uploaded to S3"

  # NEW: Apply migration to DynamoDB (runs after upload)
  apply-migration:
    name: Apply Taxonomy Migration to DynamoDB
    needs: deploy-artifacts
    runs-on: ubuntu-latest
    # Only run automatic apply on main â€” change as needed
    if: github.ref_name == 'main'
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws-region: us-east-2
          output-env-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies (pnpm)
        run: |
          # Enable corepack and ensure pnpm is available
          corepack enable
          corepack prepare pnpm@latest --activate

          # Use frozen install if lockfile exists; otherwise install normally
          if [ -f pnpm-lock.yaml ]; then
            echo "pnpm-lock.yaml found â€” running frozen install"
            pnpm install --frozen-lockfile
          else
            echo "pnpm-lock.yaml not found â€” running pnpm install"
            pnpm install
          fi

      - name: Run taxonomy migration (APPLY)
        env:
          AWS_REGION: us-east-2
          TABLE_PREFIX: finz_
        run: |
          echo "ğŸ” Running migration in apply mode..."
          set -o pipefail
          pnpm exec tsx scripts/migrations/migrate-taxonomy-storage.ts --apply 2>&1 | tee scripts/migrations/migration-apply-${{ github.run_number }}.log
          # Ensure script exit status is respected
          if [ "${PIPESTATUS[0]}" -ne 0 ]; then
            echo "Migration failed. See scripts/migrations/migration-apply-${{ github.run_number }}.log"
            exit 1
          fi

      - name: Upload migration artifacts
        uses: actions/upload-artifact@v4
        with:
          name: taxonomy-migration-artifacts
          path: |
            scripts/migrations/*.json
            scripts/migrations/*.log
          retention-days: 14

  trigger-deployments:
    name: Trigger Service Deployments
    needs: [deploy-artifacts, apply-migration]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [ui, api]
    steps:
      - name: Trigger ${{ matrix.service }} deployment
        uses: actions/github-script@v7
        with:
          script: |
            const serviceName = '${{ matrix.service }}';
            const workflowFile = serviceName === 'ui'
              ? 'deploy-ui.yml'
              : 'deploy-api.yml';

            const msg = `Triggering ${serviceName} deployment`;
            console.log(`${msg}...`);

            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowFile,
                ref: context.ref,
              });
              console.log(`âœ… ${serviceName} deployment triggered`);

              // Optional: Verify workflow run was created
              await new Promise(resolve => setTimeout(resolve, 2000));
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowFile,
                per_page: 5,
              });

              const recentRun = runs.data.workflow_runs.find(run => {
                const runAge = Date.now() - new Date(run.created_at).getTime();
                return runAge < 30000; // Within last 30 seconds
              });

              if (!recentRun) {
                throw new Error(`No recent workflow run found for ${workflowFile}`);
              }
              console.log(`âœ… Verified workflow run #${recentRun.run_number} started`);

            } catch (error) {
              const errMsg =
                `âš ï¸ Failed to trigger ${serviceName} deployment`;
              console.error(`${errMsg}:`, error.message);
              
              // Fail loud on main branch
              if (context.ref === 'refs/heads/main') {
                throw error;
              }
              
              const note =
                `This is non-fatal on non-main branches. Deploy ${serviceName} manually.`;
              console.log(`   ${note}`);
            }

  notify:
    name: Send Notification
    needs: [validate-taxonomy, deploy-artifacts, trigger-deployments, apply-migration]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send success notification
        if: |
          needs.validate-taxonomy.result == 'success' &&
          needs.deploy-artifacts.result == 'success'
        run: |
          echo "âœ… Taxonomy sync completed successfully"
          echo "   Commit: ${{ github.sha }}"
          echo "   Branch: ${{ github.ref_name }}"

      - name: Send failure notification
        if: |
          needs.validate-taxonomy.result == 'failure' ||
          needs.deploy-artifacts.result == 'failure' ||
          needs.apply-migration.result == 'failure'
        run: |
          echo "âŒ Taxonomy sync failed"
          echo "   Commit: ${{ github.sha }}"
          echo "   Branch: ${{ github.ref_name }}"
          exit 1
