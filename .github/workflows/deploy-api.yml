name: Deploy Finanzas API (dev)
on:
  push:
    branches: [ "module/finanzas-api-mvp" ]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION:            ${{ vars.AWS_REGION }}
  FINZ_API_STACK:        ${{ vars.FINZ_API_STACK }}
  FINZ_API_STAGE:        ${{ vars.FINZ_API_STAGE }}

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Preflight env
        run: |
          set -euo pipefail
          for k in AWS_REGION FINZ_API_STACK FINZ_API_STAGE; do : "${!k:?$k empty}"; done
          echo "Env OK"

      - name: Configure AWS (OIDC)
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: deploy-api-${{ github.run_id }}

      - name: Verify identity
        run: aws sts get-caller-identity

      - name: Install SAM CLI
        run: |
          pipx install aws-sam-cli
          sam --version

      - name: Build
        working-directory: services/finanzas-api
        run: sam build

      - name: Deploy (dev)
        working-directory: services/finanzas-api
        run: |
          sam deploy --no-confirm-changeset \
            --stack-name "${FINZ_API_STACK}" \
            --resolve-s3 --capabilities CAPABILITY_IAM \
            --parameter-overrides CognitoUserPoolArn=${{ vars.COGNITO_USER_POOL_ARN }} CognitoUserPoolId=${{ vars.COGNITO_USER_POOL_ID }} StageName=${FINZ_API_STAGE}

      - name: Output API info
        id: out
        working-directory: services/finanzas-api
        run: |
          API_ID=$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" \
              --query "Stacks[0].Outputs[?OutputKey=='FinzApiId'].OutputValue" --output text)
          API_URL=$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" \
              --query "Stacks[0].Outputs[?OutputKey=='FinzApiUrl'].OutputValue" --output text)
          echo "api_id=$API_ID" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT

      - name: Smoke (health)
        run: |
          curl -sS --fail "${{ steps.out.outputs.api_url }}/health" | jq .

      - name: Summary
        run: |
          {
            echo "## Finanzas API (dev) deployed"
            echo ""
            echo "- Region: ${AWS_REGION}"
            echo "- Stack: ${FINZ_API_STACK}"
            echo "- Stage: ${FINZ_API_STAGE}"
            echo "- API ID: ${{ steps.out.outputs.api_id }}"
            echo "- URL: ${{ steps.out.outputs.api_url }}"
            echo ""
            echo "### Sample cURL"
            echo '```bash'
            echo "curl -sS ${{ steps.out.outputs.api_url }}/health"
            echo '```'
          } >> $GITHUB_STEP_SUMMARY
