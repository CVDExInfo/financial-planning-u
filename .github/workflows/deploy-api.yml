name: Deploy Finanzas API
on:
  push:
    branches:
      - "module/finanzas-api-mvp"
      - "r1-finanzas-dev-wiring"
      - "main"
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}
  # Determine environment based on branch
  DEPLOYMENT_ENV: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
  # Use prod stack and stage for main branch, dev otherwise
  FINZ_API_STACK: ${{ github.ref == 'refs/heads/main' && 'finanzas-sd-api-prod' || (vars.FINZ_API_STACK || 'finanzas-sd-api-dev') }}
  FINZ_API_STAGE: ${{ github.ref == 'refs/heads/main' && 'prod' || (vars.FINZ_API_STAGE || 'dev') }}
  COGNITO_USER_POOL_ID: ${{ vars.COGNITO_USER_POOL_ID }} # required
  COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }} # required
  COGNITO_WEB_CLIENT: ${{ vars.COGNITO_WEB_CLIENT }} # required
  # Per-environment API IDs for guard validation
  FINZ_API_ID_DEV: ${{ vars.FINZ_API_ID_DEV || 'm3g6am67aj' }}
  FINZ_API_ID_PROD: ${{ vars.FINZ_API_ID_PROD || '' }}
  POLICY_STORE_ID: ${{ vars.POLICY_STORE_ID || '' }} # optional, from AVP deployment

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Normalize line endings for local actions
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dos2unix
          find .github/actions -type f -print0 | xargs -0 dos2unix || true

      - name: Preflight env
        run: |
          set -euo pipefail
          echo "üöÄ Deployment Environment: ${DEPLOYMENT_ENV}"
          echo "üì¶ Stack Name: ${FINZ_API_STACK}"
          echo "üîå Stage: ${FINZ_API_STAGE}"
          echo "üåê Region: ${AWS_REGION}"
          if [ "${DEPLOYMENT_ENV}" = "prod" ]; then
            echo "üîë Expected API ID (prod): ${FINZ_API_ID_PROD:-<not set - first deploy>}"
          else
            echo "üîë Expected API ID (dev): ${FINZ_API_ID_DEV}"
          fi
          for k in AWS_REGION FINZ_API_STACK FINZ_API_STAGE COGNITO_USER_POOL_ID COGNITO_USER_POOL_ARN; do
            v="${!k:-}"; [ -n "$v" ] || { echo "‚ùå $k is empty"; exit 1; }
          done
          echo "‚úÖ Env OK"

      - name: Configure AWS (OIDC)
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: deploy-api-${{ github.run_id }}

      - name: Verify identity (fail fast)
        run: aws sts get-caller-identity

      - name: Preflight - Verify AVP Policy Store (optional)
        id: avp_check
        run: |
          set -euo pipefail
          if [ -n "${POLICY_STORE_ID:-}" ]; then
            echo "Verifying AVP Policy Store: $POLICY_STORE_ID"
            
            # Check if policy store exists
            if aws verifiedpermissions get-policy-store \
              --region "${AWS_REGION}" \
              --policy-store-id "$POLICY_STORE_ID" \
              --query 'policyStoreId' --output text >/dev/null 2>&1; then
              
              echo "‚úÖ AVP Policy Store verified: $POLICY_STORE_ID"
              echo "avp_enabled=true" >> $GITHUB_OUTPUT
              
              # Optional: Verify schema exists
              if aws verifiedpermissions get-schema \
                --region "${AWS_REGION}" \
                --policy-store-id "$POLICY_STORE_ID" \
                --query 'schema' --output text >/dev/null 2>&1; then
                echo "‚úÖ AVP Schema verified"
              else
                echo "‚ö†Ô∏è  Warning: AVP Policy Store exists but schema not found"
              fi
            else
              echo "‚ùå AVP Policy Store not found: $POLICY_STORE_ID"
              echo "Run 'Deploy AVP' workflow first to provision the policy store"
              exit 1
            fi
          else
            echo "‚ÑπÔ∏è  POLICY_STORE_ID not set - AVP authorization will be skipped"
            echo "avp_enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Install SAM CLI
        run: |
          pipx install aws-sam-cli
          sam --version

      - name: Install dependencies
        working-directory: services/finanzas-api
        run: |
          set -e
          echo "Installing API service dependencies"
          if ! npm ci; then
            echo "npm ci failed (lock mismatch). Falling back to npm install."
            npm install
          fi

      - name: Build
        working-directory: services/finanzas-api
        run: |
          set -euo pipefail
          # Install project dependencies (dev deps include esbuild & ts-node)
          if ! npm ci; then
            npm install
          fi
          # Ensure esbuild is available on the host PATH for SAM builder
          npm i -g esbuild || true
          # Also install into project node_modules as a fallback
          npm install esbuild --no-save || true
          export PATH="$PWD/node_modules/.bin:$PATH"
          sam build

      - name: Deploy (dev)
        working-directory: services/finanzas-api
        run: |
          sam deploy --no-confirm-changeset \
            --stack-name "${FINZ_API_STACK}" \
            --resolve-s3 --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              CognitoUserPoolArn=${{ env.COGNITO_USER_POOL_ARN }} \
              CognitoUserPoolId=${{ env.COGNITO_USER_POOL_ID }} \
              CognitoUserPoolClientId=${{ env.COGNITO_WEB_CLIENT }} \
              StageName=${{ env.FINZ_API_STAGE }} \
              PolicyStoreId="${POLICY_STORE_ID:-}"

      - name: Output API info
        id: out
        working-directory: services/finanzas-api
        run: |
          API_ID=$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" \
            --query "Stacks[0].Outputs[?OutputKey=='FinzApiId'].OutputValue" --output text)
          API_URL=$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" \
            --query "Stacks[0].Outputs[?OutputKey=='FinzApiUrl'].OutputValue" --output text)
          printf 'api_id=%s\n' "$API_ID" >> "$GITHUB_OUTPUT"
          printf 'api_url=%s\n' "$API_URL" >> "$GITHUB_OUTPUT"

      - name: Guard - canonical API id and required routes present
        run: |
          set -euo pipefail
          HOST_ID=$(echo "${{ steps.out.outputs.api_url }}" | awk -F'[/.]' '{print $3}')

          if [ "${DEPLOYMENT_ENV}" = "prod" ] && [ -z "${FINZ_API_ID_PROD:-}" ]; then
            echo "‚ÑπÔ∏è  Skipping API ID check for first prod deploy (FINZ_API_ID_PROD not set)"
          else
            # For dev, we always enforce; for prod, we enforce once FINZ_API_ID_PROD is set.
            if [ "${DEPLOYMENT_ENV}" = "prod" ]; then
              EXPECTED="${FINZ_API_ID_PROD}"
            else
              EXPECTED="${FINZ_API_ID_DEV}"
            fi

            if [ -n "${EXPECTED:-}" ] && [ "$HOST_ID" != "$EXPECTED" ]; then
              echo "‚ùå Expected API id ${EXPECTED}, got ${HOST_ID} from ${{ steps.out.outputs.api_url }}"; exit 1;
            fi

            echo "‚úÖ API ID matches expected: ${HOST_ID}"
          fi

          echo "Verifying routes on API ${HOST_ID}..."
          ROUTES=$(aws apigatewayv2 get-routes --api-id "$HOST_ID" --query 'Items[].RouteKey' --output text)

          # Verify mandatory routes
          for ROUTE in "GET /health" "GET /catalog/rubros" "POST /projects"; do
            echo "$ROUTES" | tr '\t' '\n' | grep -q "^${ROUTE}$" || {
              echo "‚ùå Mandatory route '${ROUTE}' not found on API ${HOST_ID}"; exit 1; }
            echo "‚úÖ Route found: ${ROUTE}"
          done

          # Verify authorizer
          AUTH_COUNT=$(aws apigatewayv2 get-authorizers --api-id "$HOST_ID" --query 'length(Items[?Name==`CognitoJwt`])')
          if [ "$AUTH_COUNT" = "0" ]; then
            echo "‚ùå CognitoJwt authorizer not found on API ${HOST_ID}"; exit 1;
          fi
          echo "‚úÖ CognitoJwt authorizer present"

      - name: Readiness - wait for /health (max 90s)
        env:
          BASE: ${{ steps.out.outputs.api_url }}
        run: |
          set -euo pipefail
          for i in $(seq 1 18); do
            CODE=$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || true)
            if [ "$CODE" = "200" ]; then
              echo "API ready (health=200)"; break
            fi
            echo "Waiting for API to be ready... (try $i, code=$CODE)"; sleep 5
            if [ "$i" = "18" ]; then echo "‚ùå API not ready in time"; exit 1; fi
          done

      - name: Smoke (health)
        run: curl -sS --fail "${{ steps.out.outputs.api_url }}/health" | jq .

      - name: Generate Cognito JWT
        id: jwt
        uses: ./.github/actions/cognito-generate-jwt
        with:
          user_pool_id: ${{ env.COGNITO_USER_POOL_ID }}
          client_id: ${{ env.COGNITO_WEB_CLIENT }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          aws_region: ${{ env.AWS_REGION }}

      - name: Smoke (protected POST /projects)
        continue-on-error: true
        run: |
          set -euo pipefail
          curl -sS -X POST "${{ steps.out.outputs.api_url }}/projects" \
            -H "Authorization: Bearer ${{ steps.jwt.outputs.access_token }}" \
            -H "Content-Type: application/json" \
            -d '{"cliente":"Cliente Alpha","nombre":"Proyecto A","fecha_inicio":"2025-01-01","fecha_fin":"2025-09-30","moneda":"COP"}' | jq .

      - name: Smoke (GET /catalog/rubros)
        run: |
          curl -sS --fail "${{ steps.out.outputs.api_url }}/catalog/rubros" | jq '.'

      - name: Smoke (GET /adjustments) expect 501
        continue-on-error: true
        run: |
          CODE=$(curl -s -o /tmp/adj.json -w '%{http_code}' -H "Authorization: Bearer ${{ steps.jwt.outputs.access_token }}" "${{ steps.out.outputs.api_url }}/adjustments" || true)
          echo "Adjustments status: $CODE" | tee -a $GITHUB_STEP_SUMMARY
          head -c 400 /tmp/adj.json || true

      - name: Collect CatalogFn logs (last 100 lines)
        if: failure()
        env:
          STACK: ${{ env.FINZ_API_STACK }}
        run: |
          set -euo pipefail
          FN=$(aws cloudformation list-stack-resources --stack-name "$STACK" \
            --query "StackResourceSummaries[?LogicalResourceId=='CatalogFn'].PhysicalResourceId" --output text)
          echo "CatalogFn: $FN" | tee -a $GITHUB_STEP_SUMMARY
          if [ -n "$FN" ]; then
            LOG="/aws/lambda/$FN"
            echo "### CloudWatch Logs (CatalogFn)" >> $GITHUB_STEP_SUMMARY
            aws logs get-log-events --log-group-name "$LOG" --log-stream-name $(aws logs describe-log-streams --log-group-name "$LOG" --order-by LastEventTime --descending --max-items 1 --query 'logStreams[0].logStreamName' --output text) --limit 100 --query 'events[].message' --output text | tail -n 100 | sed 's/^/    /' >> $GITHUB_STEP_SUMMARY || true
          else
            echo "Could not resolve CatalogFn physical id" | tee -a $GITHUB_STEP_SUMMARY
          fi

      - name: Smoke (GET /allocation-rules) with JWT
        run: |
          curl -sS --fail -H "Authorization: Bearer ${{ steps.jwt.outputs.access_token }}" \
            "${{ steps.out.outputs.api_url }}/allocation-rules" | jq '.'

      - name: Show routes
        run: |
          API_ID=$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" \
            --query "Stacks[0].Outputs[?OutputKey=='FinzApiId'].OutputValue" --output text || true)
          echo "API_ID: $API_ID"
          aws apigatewayv2 get-routes --api-id "$API_ID" --query 'Items[].RouteKey' --output text | tr '\t' '\n' | sort || true
          echo "### Routes" >> $GITHUB_STEP_SUMMARY
          aws apigatewayv2 get-routes --api-id "$API_ID" --query 'Items[].RouteKey' --output text | tr '\t' '\n' | sort | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || true
          echo "### Authorizers" >> $GITHUB_STEP_SUMMARY
          aws apigatewayv2 get-authorizers --api-id "$API_ID" --query 'Items[].Name' --output text | tr '\t' '\n' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || true

      - name: Seed Dynamo (rubros + taxonom√≠a)
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          TABLE_RUBROS: ${{ vars.TABLE_RUBROS || 'finz_rubros' }}
          TABLE_RUBROS_TAXONOMIA: ${{ vars.TABLE_RUBROS_TAXONOMIA || '' }}
        run: |
          set -euo pipefail
          : "${TABLE_RUBROS:=finz_rubros}"
          : "${TABLE_RUBROS_TAXONOMIA:=finz_rubros_taxonomia}"
          if ! npm ci; then npm install; fi
          echo "Tables: RUBROS=$TABLE_RUBROS TAX=$TABLE_RUBROS_TAXONOMIA"
          TAX_C=0
          if [ -n "${TABLE_RUBROS_TAXONOMIA}" ] && aws dynamodb describe-table --table-name "$TABLE_RUBROS_TAXONOMIA" >/dev/null 2>&1; then
            npx ts-node --project tsconfig.node.json scripts/ts-seeds/seed_rubros_taxonomia.ts | tee seed_tax.log
            TAX_C=$(grep -c '^Upserted taxonom√≠a:' seed_tax.log || true)
          else
            echo "Skip taxonomy seed"
          fi
          if aws dynamodb describe-table --table-name "$TABLE_RUBROS" >/dev/null 2>&1; then
            npx ts-node --project tsconfig.node.json scripts/ts-seeds/seed_rubros.ts | tee seed_rub.log
            RUB_C=$(grep -c '^Upserted rubro:' seed_rub.log || true)
          else
            echo "‚ùå Rubros table not found"; exit 1
          fi
          {
            echo "### Seeds"
            echo "- taxonomy: ${TAX_C}"
            echo "- rubros: ${RUB_C}"
          } >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          {
            echo "## üöÄ Finanzas API (${DEPLOYMENT_ENV}) deployed"
            echo ""
            echo "### Deployment Details"
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| **Environment** | **${DEPLOYMENT_ENV}** |"
            echo "| Region | ${AWS_REGION} |"
            echo "| Stack | ${FINZ_API_STACK} |"
            echo "| Stage | ${FINZ_API_STAGE} |"
            echo "| API ID | ${{ steps.out.outputs.api_id }} |"
            echo "| API URL | ${{ steps.out.outputs.api_url }} |"
            if [ "${DEPLOYMENT_ENV}" = "prod" ]; then
              echo "| Expected API ID (prod) | ${FINZ_API_ID_PROD:-<not set - first deploy>} |"
            else
              echo "| Expected API ID (dev) | ${FINZ_API_ID_DEV} |"
            fi
            echo "| AVP Enabled | ${{ steps.avp_check.outputs.avp_enabled || 'false' }} |"
            if [ -n "${POLICY_STORE_ID:-}" ]; then
              echo "| Policy Store ID | ${POLICY_STORE_ID} |"
            fi
            echo ""
            echo "### Authentication"
            echo "- **Authorizer**: CognitoJwt"
            echo "- **Issuer**: https://cognito-idp.us-east-2.amazonaws.com/${{ env.COGNITO_USER_POOL_ID }}"
            echo "- **Audience**: ${{ env.COGNITO_WEB_CLIENT }}"
            echo "- **User Pool ID**: ${{ env.COGNITO_USER_POOL_ID }}"
            echo ""
            echo "### Public Endpoints (no auth required)"
            echo "- \`GET /health\` ‚Üí Health check"
            echo "- \`GET /catalog/rubros\` ‚Üí Budget line items catalog"
            echo ""
            echo "### Protected Endpoints (require JWT)"
            echo "- \`GET /allocation-rules\` ‚Üí Allocation rules"
            echo "- \`POST /projects\` ‚Üí Create project"
            echo "- \`GET /adjustments\` ‚Üí Budget adjustments"
            echo ""
            echo "### Quick Test Commands"
            echo '```bash'
            echo "# Public endpoints (no auth)"
            echo "curl -sS ${{ steps.out.outputs.api_url }}/health | jq '.stage'"
            echo "curl -sS ${{ steps.out.outputs.api_url }}/catalog/rubros | jq '.data | length'"
            echo ""
            echo "# Protected endpoints (requires JWT)"
            echo "JWT_TOKEN=\$(aws cognito-idp initiate-auth --region ${AWS_REGION} \\"
            echo "  --auth-flow USER_PASSWORD_AUTH \\"
            echo "  --client-id ${{ env.COGNITO_WEB_CLIENT }} \\"
            echo "  --auth-parameters USERNAME=\$USERNAME PASSWORD=\$PASSWORD \\"
            echo "  --query 'AuthenticationResult.IdToken' --output text)"
            echo ""
            echo "curl -sS -H 'Authorization: Bearer \$JWT_TOKEN' ${{ steps.out.outputs.api_url }}/allocation-rules | jq '.data | length'"
            echo ""
            echo "# Create project (requires JWT with SDT group)"
            echo "curl -sS -X POST ${{ steps.out.outputs.api_url }}/projects \\"
            echo "  -H \"Authorization: Bearer \$JWT_TOKEN\" \\"
            echo "  -H \"Content-Type: application/json\" \\"
            echo "  -d '{\"cliente\":\"Cliente Alpha\",\"nombre\":\"Proyecto A\",\"fecha_inicio\":\"2025-01-01\",\"fecha_fin\":\"2025-09-30\",\"moneda\":\"COP\"}' | jq ."
            echo '```'
            echo ""
            echo "### Repository Variables for UI Deployment"
            echo ""
            echo "UI uses \`VITE_API_BASE_URL\` injected from \`FINZ_API_ID_<ENV>\` and stage."
            echo "For the current deployment, add this to GitHub repository variables:"
            echo '```'
            if [ "${DEPLOYMENT_ENV}" = "prod" ]; then
              echo "FINZ_API_ID_PROD=${{ steps.out.outputs.api_id }}"
            else
              echo "FINZ_API_ID_DEV=${{ steps.out.outputs.api_id }}"
            fi
            echo '```'
            echo ""
            echo "Optional override for development (if not using FINZ_API_ID_DEV):"
            echo '```'
            echo "DEV_API_URL=${{ steps.out.outputs.api_url }}"
            echo '```'
          } >> $GITHUB_STEP_SUMMARY
