name: Deploy Finanzas API (dev)
on:
  push:
    branches:
      - "module/finanzas-api-mvp"
      - "r1-finanzas-dev-wiring"
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}
  FINZ_API_STACK: ${{ vars.FINZ_API_STACK || 'finanzas-sd-api-dev' }}
  FINZ_API_STAGE: ${{ vars.FINZ_API_STAGE || 'dev' }}
  COGNITO_USER_POOL_ID: ${{ vars.COGNITO_USER_POOL_ID }} # required
  COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }} # required
  COGNITO_WEB_CLIENT: ${{ vars.COGNITO_WEB_CLIENT }} # required
  EXPECTED_API_ID: ${{ vars.FINZ_EXPECTED_API_ID || 'm3g6am67aj' }}

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Normalize line endings for local actions
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dos2unix
          find .github/actions -type f -print0 | xargs -0 dos2unix || true

      - name: Preflight env
        run: |
          set -euo pipefail
          for k in AWS_REGION FINZ_API_STACK FINZ_API_STAGE COGNITO_USER_POOL_ID COGNITO_USER_POOL_ARN; do
            v="${!k:-}"; [ -n "$v" ] || { echo "❌ $k is empty"; exit 1; }
          done
          echo "Env OK"

      - name: Configure AWS (OIDC)
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: deploy-api-${{ github.run_id }}

      - name: Verify identity (fail fast)
        run: aws sts get-caller-identity

      - name: Install SAM CLI
        run: |
          pipx install aws-sam-cli
          sam --version

      - name: Install dependencies
        working-directory: services/finanzas-api
        run: |
          set -e
          echo "Installing API service dependencies"
          if ! npm ci; then
            echo "npm ci failed (lock mismatch). Falling back to npm install."
            npm install
          fi

      - name: Build
        working-directory: services/finanzas-api
        run: |
          set -euo pipefail
          # Install project dependencies (dev deps include esbuild & ts-node)
          if ! npm ci; then
            npm install
          fi
          # Ensure esbuild is available on the host PATH for SAM builder
          npm i -g esbuild || true
          # Also install into project node_modules as a fallback
          npm install esbuild --no-save || true
          export PATH="$PWD/node_modules/.bin:$PATH"
          sam build

      - name: Deploy (dev)
        working-directory: services/finanzas-api
        run: |
          sam deploy --no-confirm-changeset \
            --stack-name "${FINZ_API_STACK}" \
            --resolve-s3 --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              CognitoUserPoolArn=${{ env.COGNITO_USER_POOL_ARN }} \
              CognitoUserPoolId=${{ env.COGNITO_USER_POOL_ID }} \
              StageName=${{ env.FINZ_API_STAGE }}

      - name: Output API info
        id: out
        working-directory: services/finanzas-api
        run: |
          API_ID=$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" \
            --query "Stacks[0].Outputs[?OutputKey=='FinzApiId'].OutputValue" --output text)
          API_URL=$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" \
            --query "Stacks[0].Outputs[?OutputKey=='FinzApiUrl'].OutputValue" --output text)
          printf 'api_id=%s\n' "$API_ID" >> "$GITHUB_OUTPUT"
          printf 'api_url=%s\n' "$API_URL" >> "$GITHUB_OUTPUT"

      - name: Guard - canonical API id and /health route present
        run: |
          set -euo pipefail
          HOST_ID=$(echo "${{ steps.out.outputs.api_url }}" | awk -F'[/.]' '{print $3}')
          if [ "$HOST_ID" != "$EXPECTED_API_ID" ]; then
            echo "❌ Expected API id ${EXPECTED_API_ID}, got ${HOST_ID} from ${{ steps.out.outputs.api_url }}"; exit 1;
          fi
          aws apigatewayv2 get-routes --api-id "$HOST_ID" --query 'Items[].RouteKey' --output text | tr '\t' '\n' | grep -q "GET /health" || {
            echo "❌ Route GET /health not found on API ${HOST_ID}"; exit 1; }

      - name: Readiness - wait for /health (max 90s)
        env:
          BASE: ${{ steps.out.outputs.api_url }}
        run: |
          set -euo pipefail
          for i in $(seq 1 18); do
            CODE=$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || true)
            if [ "$CODE" = "200" ]; then
              echo "API ready (health=200)"; break
            fi
            echo "Waiting for API to be ready... (try $i, code=$CODE)"; sleep 5
            if [ "$i" = "18" ]; then echo "❌ API not ready in time"; exit 1; fi
          done

      - name: Smoke (health)
        run: curl -sS --fail "${{ steps.out.outputs.api_url }}/health" | jq .

      - name: Generate Cognito JWT
        id: jwt
        uses: ./.github/actions/cognito-generate-jwt
        with:
          user_pool_id: ${{ env.COGNITO_USER_POOL_ID }}
          client_id: ${{ env.COGNITO_WEB_CLIENT }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          aws_region: ${{ env.AWS_REGION }}

      - name: Smoke (protected POST /projects)
        continue-on-error: true
        run: |
          set -euo pipefail
          curl -sS -X POST "${{ steps.out.outputs.api_url }}/projects" \
            -H "Authorization: Bearer ${{ steps.jwt.outputs.access_token }}" \
            -H "Content-Type: application/json" \
            -d '{"cliente":"Cliente Alpha","nombre":"Proyecto A","fecha_inicio":"2025-01-01","fecha_fin":"2025-09-30","moneda":"COP"}' | jq .

      - name: Smoke (GET /catalog/rubros)
        run: |
          curl -sS --fail "${{ steps.out.outputs.api_url }}/catalog/rubros" | jq '.'

      - name: Collect CatalogFn logs (last 100 lines)
        if: failure()
        env:
          STACK: ${{ env.FINZ_API_STACK }}
        run: |
          set -euo pipefail
          FN=$(aws cloudformation list-stack-resources --stack-name "$STACK" \
            --query "StackResourceSummaries[?LogicalResourceId=='CatalogFn'].PhysicalResourceId" --output text)
          echo "CatalogFn: $FN" | tee -a $GITHUB_STEP_SUMMARY
          if [ -n "$FN" ]; then
            LOG="/aws/lambda/$FN"
            echo "### CloudWatch Logs (CatalogFn)" >> $GITHUB_STEP_SUMMARY
            aws logs get-log-events --log-group-name "$LOG" --log-stream-name $(aws logs describe-log-streams --log-group-name "$LOG" --order-by LastEventTime --descending --max-items 1 --query 'logStreams[0].logStreamName' --output text) --limit 100 --query 'events[].message' --output text | tail -n 100 | sed 's/^/    /' >> $GITHUB_STEP_SUMMARY || true
          else
            echo "Could not resolve CatalogFn physical id" | tee -a $GITHUB_STEP_SUMMARY
          fi

      - name: Smoke (GET /allocation-rules) with JWT
        run: |
          curl -sS --fail -H "Authorization: Bearer ${{ steps.jwt.outputs.access_token }}" \
            "${{ steps.out.outputs.api_url }}/allocation-rules" | jq '.'

      - name: Show routes
        run: |
          API_ID=$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" \
            --query "Stacks[0].Outputs[?OutputKey=='FinzApiId'].OutputValue" --output text || true)
          echo "API_ID: $API_ID"
          aws apigatewayv2 get-routes --api-id "$API_ID" --query 'Items[].RouteKey' --output text || true

      - name: Seed Dynamo (rubros + taxonomía)
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          TABLE_RUBROS: ${{ vars.TABLE_RUBROS || 'finz_rubros' }}
          TABLE_RUBROS_TAXONOMIA: ${{ vars.TABLE_RUBROS_TAXONOMIA || '' }}
        run: |
          set -euo pipefail
          : "${TABLE_RUBROS:=finz_rubros}"
          : "${TABLE_RUBROS_TAXONOMIA:=finz_rubros_taxonomia}"
          if ! npm ci; then npm install; fi
          echo "Tables: RUBROS=$TABLE_RUBROS TAX=$TABLE_RUBROS_TAXONOMIA"
          TAX_C=0
          if [ -n "${TABLE_RUBROS_TAXONOMIA}" ] && aws dynamodb describe-table --table-name "$TABLE_RUBROS_TAXONOMIA" >/dev/null 2>&1; then
            npx ts-node --transpile-only scripts/ts-seeds/seed_rubros_taxonomia.ts | tee seed_tax.log
            TAX_C=$(grep -c '^Upserted taxonomía:' seed_tax.log || true)
          else
            echo "Skip taxonomy seed"
          fi
          if aws dynamodb describe-table --table-name "$TABLE_RUBROS" >/dev/null 2>&1; then
            npx ts-node --transpile-only scripts/ts-seeds/seed_rubros.ts | tee seed_rub.log
            RUB_C=$(grep -c '^Upserted rubro:' seed_rub.log || true)
          else
            echo "❌ Rubros table not found"; exit 1
          fi
          {
            echo "### Seeds"
            echo "- taxonomy: ${TAX_C}"
            echo "- rubros: ${RUB_C}"
          } >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          {
            echo "## Finanzas API (dev) deployed"
            echo "- Region: ${AWS_REGION}"
            echo "- Stack: ${FINZ_API_STACK}"
            echo "- Stage: ${FINZ_API_STAGE}"
            echo "- API ID: ${{ steps.out.outputs.api_id }}"
            echo "- URL: ${{ steps.out.outputs.api_url }}"
            echo ""
            echo "### Sample cURL"
            echo '```bash'
            echo "curl -sS ${{ steps.out.outputs.api_url }}/health"
            echo "curl -sS ${{ steps.out.outputs.api_url }}/catalog/rubros"
            echo "curl -sS -H 'Authorization: Bearer $JWT_TOKEN' ${{ steps.out.outputs.api_url }}/allocation-rules"
            echo "# Requires JWT with SDT group:"
            echo "curl -sS -X POST ${{ steps.out.outputs.api_url }}/projects \\"
            echo "  -H \"Authorization: Bearer \$JWT_TOKEN\" \\"
            echo "  -H \"Content-Type: application/json\" \\"
            echo "  -d '{\"cliente\":\"Cliente Alpha\",\"nombre\":\"Proyecto A\",\"fecha_inicio\":\"2025-01-01\",\"fecha_fin\":\"2025-09-30\",\"moneda\":\"COP\"}'"
            echo '```'
          } >> $GITHUB_STEP_SUMMARY
