name: Deploy Finanzas API
on:
  push:
    branches:
      - "module/finanzas-api-mvp"
      - "r1-finanzas-dev-wiring"
      - "main"
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}

  # Current reality: single stage (dev) only
  DEPLOYMENT_ENV: dev
  FINZ_API_STACK: ${{ vars.FINZ_API_STACK_DEV || 'finanzas-sd-api-dev' }}
  FINZ_API_STAGE: ${{ vars.FINZ_API_STAGE_DEV || vars.FINZ_API_STAGE || 'dev' }}

  # Expected API ID (guard)
  FINZ_EXPECTED_API_ID: ${{ vars.FINZ_EXPECTED_API_ID || vars.FINZ_API_ID_DEV || vars.FINZ_API_ID || vars.DEV_API_ID || '' }}

  # Cognito (required)
  COGNITO_USER_POOL_ID: ${{ vars.COGNITO_USER_POOL_ID }}
  COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
  COGNITO_WEB_CLIENT: ${{ vars.COGNITO_WEB_CLIENT || vars.COGNITO_CLIENT_ID }}

  # AVP (optional)
  POLICY_STORE_ID: ${{ vars.POLICY_STORE_ID || '' }}
  REQUIRED_POLICY_IDS_DEV: ${{ vars.REQUIRED_POLICY_IDS_DEV || '' }}
  ALLOW_STAGE_DRIFT: ${{ vars.ALLOW_STAGE_DRIFT || 'true' }}

  # SAM parameters
  TABLE_PREFIX: finz_
  DOCS_BUCKET_NAME: ${{ vars.FINANZAS_BUCKET_NAME || vars.S3_BUCKET_NAME || 'ukusi-ui-finanzas-prod' }}
  TAXONOMY_S3_BUCKET: ukusi-ui-finanzas-prod

  # AWS role for OIDC
  OIDC_ROLE_ARN: ${{ secrets.OIDC_AWS_ROLE_ARN || vars.OIDC_AWS_ROLE_ARN }}

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Normalize line endings for local actions
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dos2unix
          find .github/actions -type f -print0 | xargs -0 dos2unix || true

      - name: Install OS dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Preflight env
        run: |
          set -euo pipefail
          echo "üöÄ env=${DEPLOYMENT_ENV} stage=${FINZ_API_STAGE} stack=${FINZ_API_STACK} region=${AWS_REGION}"
          for k in AWS_REGION DEPLOYMENT_ENV FINZ_API_STACK FINZ_API_STAGE OIDC_ROLE_ARN COGNITO_USER_POOL_ID COGNITO_USER_POOL_ARN COGNITO_WEB_CLIENT; do
            if [ -z "${!k:-}" ]; then
              echo "‚ùå $k is empty"
              exit 1
            fi
          done
          if [ -z "${FINZ_EXPECTED_API_ID:-}" ]; then
            echo "‚ùå FINZ_EXPECTED_API_ID is empty (set FINZ_EXPECTED_API_ID or FINZ_API_ID_DEV repo variable)"
            exit 1
          fi
          echo "‚úÖ Env OK"

      - name: Configure AWS (OIDC)
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ env.OIDC_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: deploy-finanzas-api-${{ github.run_id }}

      - name: Verify identity (fail fast)
        run: aws sts get-caller-identity

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('services/finanzas-api/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install SAM CLI
        run: |
          pipx install aws-sam-cli
          sam --version

      - name: Install dependencies
        working-directory: services/finanzas-api
        run: |
          set -euo pipefail
          echo "Installing API service dependencies"
          rm -rf node_modules
          pnpm install --frozen-lockfile

      - name: Validate SAM template (fail fast)
        working-directory: services/finanzas-api
        run: |
          set -euo pipefail
          sam validate --lint

      - name: Build
        working-directory: services/finanzas-api
        run: |
          set -euo pipefail
          pnpm add -g esbuild || true
          pnpm add esbuild --save-dev --frozen-lockfile=false || true
          export PATH="$PWD/node_modules/.bin:$PATH"
          sam build

      - name: Preflight - Verify AVP Policy Store (optional)
        id: avp_check
        run: |
          set -euo pipefail
          if [ -n "${POLICY_STORE_ID:-}" ]; then
            echo "Verifying AVP Policy Store: $POLICY_STORE_ID"
            if aws verifiedpermissions get-policy-store \
              --region "${AWS_REGION}" \
              --policy-store-id "$POLICY_STORE_ID" \
              --query 'policyStoreId' --output text >/dev/null 2>&1; then
              echo "‚úÖ AVP Policy Store verified: $POLICY_STORE_ID"
              echo "avp_enabled=true" >> "$GITHUB_OUTPUT"
            else
              echo "‚ùå AVP Policy Store not found: $POLICY_STORE_ID"
              echo "Run the AVP deployment workflow first to provision the policy store."
              exit 1
            fi
          else
            echo "‚ÑπÔ∏è POLICY_STORE_ID not set - AVP checks will be skipped"
            echo "avp_enabled=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Drift guard - AVP schema + required policy IDs (optional)
        if: steps.avp_check.outputs.avp_enabled == 'true'
        run: |
          set -euo pipefail

          if [ "${ALLOW_STAGE_DRIFT}" = "true" ]; then
            echo "‚ö†Ô∏è  ALLOW_STAGE_DRIFT=true; skipping AVP schema drift check"
          else
            echo "üîç Validating AVP schema against repo..."

            REMOTE_SCHEMA_JSON="$(aws verifiedpermissions get-schema \
              --policy-store-id "$POLICY_STORE_ID" \
              --region "$AWS_REGION" \
              --output json)"

            REMOTE_SCHEMA="$(echo "$REMOTE_SCHEMA_JSON" | jq -er '
              if (.schema | type) == "string" then .schema
              elif (.schema | type) == "object" then
                (.schema.definition.cedarJson? // .schema.cedarJson? // .schema.definition? // empty)
              else empty end
            ')" || true

            if [ -z "${REMOTE_SCHEMA:-}" ]; then
              echo "‚ùå Unable to read Cedar schema from policy store $POLICY_STORE_ID"
              echo "$REMOTE_SCHEMA_JSON" | head -c 400 || true
              exit 1
            fi

            printf '%s' "$REMOTE_SCHEMA" > /tmp/remote-schema.cedar

            LOCAL_SCHEMA_PATH="avp/schema.cedar"
            if [ ! -f "$LOCAL_SCHEMA_PATH" ]; then
              echo "‚ùå Local schema file not found at: $LOCAL_SCHEMA_PATH"
              exit 1
            fi

            REMOTE_NORM="$(tr -d '[:space:]' < /tmp/remote-schema.cedar)"
            LOCAL_NORM="$(tr -d '[:space:]' < "$LOCAL_SCHEMA_PATH")"

            if [ "$REMOTE_NORM" != "$LOCAL_NORM" ]; then
              echo "‚ùå Schema drift detected between policy store and $LOCAL_SCHEMA_PATH"
              exit 1
            fi

            echo "‚úÖ AVP schema matches repository version"
          fi

          REQUIRED_IDS="$(echo "${REQUIRED_POLICY_IDS_DEV:-}" | tr ',' ' ' | xargs)"
          if [ -n "$REQUIRED_IDS" ]; then
            echo "üîí Verifying required DEV AVP policies: $REQUIRED_IDS"
            POLICY_IDS="$(aws verifiedpermissions list-policies \
              --policy-store-id "$POLICY_STORE_ID" \
              --region "$AWS_REGION" \
              --query 'policies[].policyId' \
              --output text | tr '\t' '\n')"

            MISSING=()
            for PID in $REQUIRED_IDS; do
              echo "$POLICY_IDS" | grep -q "^${PID}$" || MISSING+=("$PID")
            done

            if [ ${#MISSING[@]} -gt 0 ]; then
              echo "‚ùå Missing required policy IDs: ${MISSING[*]}"
              exit 1
            fi

            echo "‚úÖ Required DEV AVP policies present"
          else
            echo "‚ÑπÔ∏è No REQUIRED_POLICY_IDS_DEV configured; skipping policy-id guard"
          fi

      - name: Preflight - Check stack status
        run: |
          set -euo pipefail
          STACK_STATUS=$(aws cloudformation describe-stacks \
            --stack-name "${FINZ_API_STACK}" \
            --region "${AWS_REGION}" \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null || echo "DOES_NOT_EXIST")
          if [[ "$STACK_STATUS" == *"_IN_PROGRESS" ]]; then
            echo "‚ùå Stack is already in progress (Status: $STACK_STATUS)"
            exit 1
          fi
          echo "‚úÖ Stack status check passed: $STACK_STATUS"

      - name: Auto-delete stack in rollback state
        run: |
          set -euo pipefail
          STACK_STATUS=$(aws cloudformation describe-stacks \
            --stack-name "${FINZ_API_STACK}" \
            --region "${AWS_REGION}" \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null || echo "DOES_NOT_EXIST")
          if [ "$STACK_STATUS" = "ROLLBACK_COMPLETE" ] || [ "$STACK_STATUS" = "ROLLBACK_FAILED" ]; then
            aws cloudformation delete-stack --stack-name "${FINZ_API_STACK}" --region "${AWS_REGION}"
            aws cloudformation wait stack-delete-complete --stack-name "${FINZ_API_STACK}" --region "${AWS_REGION}"
          fi

      - name: Deploy
        working-directory: services/finanzas-api
        run: |
          set -euo pipefail
          PARAMS=(
            "CognitoUserPoolArn=${COGNITO_USER_POOL_ARN}"
            "CognitoUserPoolId=${COGNITO_USER_POOL_ID}"
            "CognitoUserPoolClientId=${COGNITO_WEB_CLIENT}"
            "StageName=${FINZ_API_STAGE}"
            "TablePrefix=${TABLE_PREFIX}"
            "DocsBucketName=${DOCS_BUCKET_NAME}"
            "TaxonomyS3Bucket=${TAXONOMY_S3_BUCKET}"
          )
          if [ -n "${POLICY_STORE_ID:-}" ]; then
            PARAMS+=("PolicyStoreId=${POLICY_STORE_ID}")
          fi

          sam deploy --no-confirm-changeset --no-fail-on-empty-changeset \
            --stack-name "${FINZ_API_STACK}" \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
            --region "${AWS_REGION}" \
            --parameter-overrides "${PARAMS[@]}"

      - name: Output API info
        id: out
        run: |
          set -euo pipefail
          API_ID=$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" \
            --region "${AWS_REGION}" \
            --query "Stacks[0].Outputs[?OutputKey=='FinzApiId'].OutputValue" --output text)
          API_URL=$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" \
            --region "${AWS_REGION}" \
            --query "Stacks[0].Outputs[?OutputKey=='FinzApiUrl'].OutputValue" --output text)
          printf 'api_id=%s\n' "$API_ID" >> "$GITHUB_OUTPUT"
          printf 'api_url=%s\n' "$API_URL" >> "$GITHUB_OUTPUT"

      - name: Guard - canonical API id and required routes present
        run: |
          set -euo pipefail
          API_ID="${{ steps.out.outputs.api_id }}"
          if [ -n "${FINZ_EXPECTED_API_ID:-}" ] && [ "$API_ID" != "$FINZ_EXPECTED_API_ID" ]; then
            echo "‚ùå Expected API id ${FINZ_EXPECTED_API_ID}, got ${API_ID}"
            exit 1
          fi
          ROUTES=$(aws apigatewayv2 get-routes --api-id "$API_ID" --region "${AWS_REGION}" \
            --query 'Items[].RouteKey' --output text)
          for ROUTE in "GET /health" "GET /catalog/rubros" "POST /projects"; do
            echo "$ROUTES" | tr '\t' '\n' | grep -q "^${ROUTE}$" || exit 1
          done

      - name: Readiness - wait for /health (max 90s)
        env:
          BASE: ${{ steps.out.outputs.api_url }}
        run: |
          set -euo pipefail
          for i in $(seq 1 18); do
            CODE=$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || true)
            if [ "$CODE" = "200" ]; then exit 0; fi
            sleep 5
          done
          exit 1
