name: Deploy Finanzas API

on:
  push:
    branches:
      - "module/finanzas-api-mvp"
      - "r1-finanzas-dev-wiring"
      - "main"
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}

  # DEV only (today)
  DEPLOYMENT_ENV: dev
  FINZ_API_STACK: ${{ vars.FINZ_API_STACK_DEV || 'finanzas-sd-api-dev' }}
  FINZ_API_STAGE: ${{ vars.FINZ_API_STAGE_DEV || vars.FINZ_API_STAGE || 'dev' }}

  # Cognito (required)
  COGNITO_USER_POOL_ID: ${{ vars.COGNITO_USER_POOL_ID }}
  COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
  COGNITO_WEB_CLIENT: ${{ vars.COGNITO_WEB_CLIENT || vars.COGNITO_CLIENT_ID }}

  # API ID guard (dev)
  FINZ_EXPECTED_API_ID: ${{ vars.FINZ_EXPECTED_API_ID || vars.FINZ_API_ID_DEV || vars.FINZ_API_ID || vars.DEV_API_ID }}

  # Buckets
  FINANZAS_BUCKET_NAME: ${{ vars.FINANZAS_BUCKET_NAME || vars.S3_BUCKET_NAME || 'ukusi-ui-finanzas-prod' }}

  # AVP (optional)
  POLICY_STORE_ID: ${{ vars.POLICY_STORE_ID || '' }}
  REQUIRED_POLICY_IDS_DEV: ${{ vars.REQUIRED_POLICY_IDS_DEV || '' }}

  # Drift behavior (you already have this)
  ALLOW_STAGE_DRIFT: ${{ vars.ALLOW_STAGE_DRIFT || 'false' }}

jobs:
  deploy-api:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Normalize line endings for local actions
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y dos2unix
          if [ -d ".github/actions" ]; then
            find .github/actions -type f -print0 | xargs -0 dos2unix || true
          fi

      - name: Install helpers
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Preflight env
        run: |
          set -euo pipefail
          echo "ðŸš€ Environment: ${DEPLOYMENT_ENV}"
          echo "ðŸ“¦ Stack: ${FINZ_API_STACK}"
          echo "ðŸ”Œ Stage: ${FINZ_API_STAGE}"
          echo "ðŸŒŽ Region: ${AWS_REGION}"
          echo "ðŸ§­ Expected API ID: ${FINZ_EXPECTED_API_ID}"
          echo "ðŸ›¡ï¸  ALLOW_STAGE_DRIFT: ${ALLOW_STAGE_DRIFT}"
          for k in AWS_REGION FINZ_API_STACK FINZ_API_STAGE COGNITO_USER_POOL_ID COGNITO_USER_POOL_ARN COGNITO_WEB_CLIENT; do
            v="${!k:-}"
            if [ -z "$v" ]; then
              echo "âŒ Missing env: $k"
              exit 1
            fi
          done
          echo "âœ… Env OK"

      - name: Configure AWS (OIDC)
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: deploy-finanzas-api-${{ github.run_id }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Preflight - Verify AVP Policy Store (optional)
        id: avp_check
        run: |
          set -euo pipefail
          if [ -n "${POLICY_STORE_ID:-}" ]; then
            echo "ðŸ”Ž Checking policy store: ${POLICY_STORE_ID}"
            if aws verifiedpermissions get-policy-store \
              --region "${AWS_REGION}" \
              --policy-store-id "${POLICY_STORE_ID}" \
              --query 'policyStoreId' --output text >/dev/null 2>&1; then
              echo "âœ… Policy store exists"
              echo "avp_enabled=true" >> "$GITHUB_OUTPUT"
            else
              echo "âŒ Policy store not found: ${POLICY_STORE_ID}"
              exit 1
            fi
          else
            echo "â„¹ï¸ POLICY_STORE_ID not set; skipping AVP guards"
            echo "avp_enabled=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install SAM CLI
        run: |
          set -euo pipefail
          pipx install aws-sam-cli
          sam --version

      - name: Install dependencies
        working-directory: services/finanzas-api
        run: |
          set -euo pipefail
          if ! npm ci; then
            echo "npm ci failed; falling back to npm install"
            npm install
          fi

      - name: Build (SAM)
        working-directory: services/finanzas-api
        run: |
          set -euo pipefail
          npm i -g esbuild || true
          npm install esbuild --no-save || true
          export PATH="$PWD/node_modules/.bin:$PATH"
          sam build

      - name: Drift guard - AVP schema + required policy IDs (DEV-only)
        if: steps.avp_check.outputs.avp_enabled == 'true'
        run: |
          set -euo pipefail
          echo "ðŸ” Validating AVP schema + required policy IDs (DEV-only)"

          REMOTE_SCHEMA_JSON="$(aws verifiedpermissions get-schema \
            --policy-store-id "$POLICY_STORE_ID" \
            --region "$AWS_REGION" \
            --output json)"

          REMOTE_SCHEMA="$(echo "$REMOTE_SCHEMA_JSON" | jq -er '
            if (.schema | type) == "string" then .schema
            elif (.schema | type) == "object" then
              (.schema.definition.cedarJson? // .schema.cedarJson? // .schema.definition? // empty)
            else empty end
          ')" || true

          if [ -z "${REMOTE_SCHEMA:-}" ]; then
            echo "âŒ Unable to read Cedar schema from policy store $POLICY_STORE_ID"
            echo "$REMOTE_SCHEMA_JSON" | head -c 400 || true
            if [ "${ALLOW_STAGE_DRIFT}" = "true" ]; then
              echo "âš ï¸ ALLOW_STAGE_DRIFT=true -> continuing despite schema read failure"
              exit 0
            fi
            exit 1
          fi

          printf '%s' "$REMOTE_SCHEMA" > /tmp/remote-schema.cedar

          LOCAL_SCHEMA_PATH="${GITHUB_WORKSPACE}/avp/schema.cedar"
          echo "ðŸ“„ Local schema path: ${LOCAL_SCHEMA_PATH}"

          if [ ! -f "$LOCAL_SCHEMA_PATH" ]; then
            echo "âŒ Local schema file not found at: ${LOCAL_SCHEMA_PATH}"
            if [ "${ALLOW_STAGE_DRIFT}" = "true" ]; then
              echo "âš ï¸ ALLOW_STAGE_DRIFT=true -> continuing (cannot validate drift)"
              exit 0
            fi
            exit 1
          fi

          REMOTE_NORM="$(tr -d '[:space:]' < /tmp/remote-schema.cedar)"
          LOCAL_NORM="$(tr -d '[:space:]' < "$LOCAL_SCHEMA_PATH")"

          if [ "$REMOTE_NORM" != "$LOCAL_NORM" ]; then
            echo "âŒ Schema drift detected between policy store and repo schema"
            echo "Remote preview (first 220 chars):"
            head -c 220 /tmp/remote-schema.cedar || true
            echo ""
            echo "Local preview (first 220 chars):"
            head -c 220 "$LOCAL_SCHEMA_PATH" || true

            if [ "${ALLOW_STAGE_DRIFT}" = "true" ]; then
              echo "âš ï¸ ALLOW_STAGE_DRIFT=true -> continuing despite drift"
            else
              exit 1
            fi
          else
            echo "âœ… AVP schema matches repository version"
          fi

          REQUIRED_IDS="$(echo "${REQUIRED_POLICY_IDS_DEV:-}" | tr ',' ' ' | xargs)"
          if [ -n "$REQUIRED_IDS" ]; then
            echo "ðŸ”’ Verifying required DEV policy IDs: $REQUIRED_IDS"
            POLICY_IDS="$(aws verifiedpermissions list-policies \
              --policy-store-id "$POLICY_STORE_ID" \
              --region "$AWS_REGION" \
              --query 'policies[].policyId' \
              --output text | tr '\t' '\n')"

            MISSING=()
            for PID in $REQUIRED_IDS; do
              echo "$POLICY_IDS" | grep -q "^${PID}$" || MISSING+=("$PID")
            done

            if [ ${#MISSING[@]} -gt 0 ]; then
              echo "âŒ Missing required policy IDs: ${MISSING[*]}"
              if [ "${ALLOW_STAGE_DRIFT}" = "true" ]; then
                echo "âš ï¸ ALLOW_STAGE_DRIFT=true -> continuing despite missing policy IDs"
              else
                exit 1
              fi
            else
              echo "âœ… Required DEV AVP policies present"
            fi
          else
            echo "â„¹ï¸ No REQUIRED_POLICY_IDS_DEV configured; skipping policy-id guard"
          fi

      - name: Preflight - Block deploy if stack update already in progress
        run: |
          set -euo pipefail
          STATUS="$(aws cloudformation describe-stacks \
            --stack-name "${FINZ_API_STACK}" \
            --region "${AWS_REGION}" \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null || echo "DOES_NOT_EXIST")"
          echo "Stack status: $STATUS"
          if [[ "$STATUS" == *"_IN_PROGRESS" ]]; then
            echo "âŒ Stack is IN_PROGRESS; retry after it finishes"
            exit 1
          fi

      - name: Auto-delete stack if stuck in rollback
        run: |
          set -euo pipefail
          STATUS="$(aws cloudformation describe-stacks \
            --stack-name "${FINZ_API_STACK}" \
            --region "${AWS_REGION}" \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null || echo "DOES_NOT_EXIST")"

          if [ "$STATUS" = "ROLLBACK_COMPLETE" ] || [ "$STATUS" = "ROLLBACK_FAILED" ]; then
            echo "â™»ï¸ Deleting stuck stack ${FINZ_API_STACK} ($STATUS)"
            aws cloudformation delete-stack --stack-name "${FINZ_API_STACK}" --region "${AWS_REGION}"
            aws cloudformation wait stack-delete-complete --stack-name "${FINZ_API_STACK}" --region "${AWS_REGION}"
            echo "âœ… Stack deleted"
          else
            echo "â„¹ï¸ No rollback deletion needed"
          fi

      - name: Deploy (SAM)
        working-directory: services/finanzas-api
        run: |
          set -euo pipefail

          PARAMS=(
            "CognitoUserPoolArn=${COGNITO_USER_POOL_ARN}"
            "CognitoUserPoolId=${COGNITO_USER_POOL_ID}"
            "CognitoUserPoolClientId=${COGNITO_WEB_CLIENT}"
            "StageName=${FINZ_API_STAGE}"
            "TablePrefix=finz_"
            "DocsBucketName=${FINANZAS_BUCKET_NAME}"
          )

          if [ -n "${POLICY_STORE_ID:-}" ]; then
            PARAMS+=("PolicyStoreId=${POLICY_STORE_ID}")
          fi

          sam deploy --no-confirm-changeset \
            --stack-name "${FINZ_API_STACK}" \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND \
            --region "${AWS_REGION}" \
            --parameter-overrides "${PARAMS[@]}" \
          || {
            echo "âŒ sam deploy failed; recent CFN events:"
            aws cloudformation describe-stack-events \
              --stack-name "${FINZ_API_STACK}" \
              --max-items 20 \
              --query 'StackEvents[0:10].[LogicalResourceId,ResourceStatus,ResourceStatusReason]' \
              --output table || true
            exit 1
          }

      - name: Read outputs (API ID / URL)
        id: out
        run: |
          set -euo pipefail
          API_ID="$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" \
            --region "${AWS_REGION}" \
            --query "Stacks[0].Outputs[?OutputKey=='FinzApiId'].OutputValue" --output text)"
          API_URL="$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" \
            --region "${AWS_REGION}" \
            --query "Stacks[0].Outputs[?OutputKey=='FinzApiUrl'].OutputValue" --output text)"

          echo "api_id=${API_ID}" >> "$GITHUB_OUTPUT"
          echo "api_url=${API_URL}" >> "$GITHUB_OUTPUT"

      - name: Guard - API ID matches expected + required routes
        run: |
          set -euo pipefail
          URL="${{ steps.out.outputs.api_url }}"
          HOST_ID="$(echo "$URL" | awk -F'[/.]' '{print $3}')"
          EXPECTED="${FINZ_EXPECTED_API_ID:-}"

          echo "API URL: $URL"
          echo "Derived API ID: $HOST_ID"
          echo "Expected API ID: $EXPECTED"

          if [ -n "$EXPECTED" ] && [ "$HOST_ID" != "$EXPECTED" ]; then
            echo "âŒ Expected API id ${EXPECTED}, got ${HOST_ID}"
            exit 1
          fi
          echo "âœ… API ID ok"

          ROUTES="$(aws apigatewayv2 get-routes --api-id "$HOST_ID" --query 'Items[].RouteKey' --output text || true)"
          for ROUTE in "GET /health" "GET /catalog/rubros" "POST /projects"; do
            echo "$ROUTES" | tr '\t' '\n' | grep -q "^${ROUTE}$" || { echo "âŒ Missing route: $ROUTE"; exit 1; }
          done
          echo "âœ… Required routes present"

          AUTH_COUNT="$(aws apigatewayv2 get-authorizers --api-id "$HOST_ID" --query 'length(Items[?Name==`CognitoJwt`])' --output text || echo 0)"
          if [ "$AUTH_COUNT" = "0" ]; then
            echo "âŒ CognitoJwt authorizer not found"
            exit 1
          fi
          echo "âœ… CognitoJwt authorizer present"

      - name: Readiness - wait for /health (max 90s)
        env:
          BASE: ${{ steps.out.outputs.api_url }}
        run: |
          set -euo pipefail
          for i in $(seq 1 18); do
            CODE="$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || true)"
            if [ "$CODE" = "200" ]; then
              echo "âœ… API ready"
              exit 0
            fi
            echo "Waiting... try $i (code=$CODE)"
            sleep 5
          done
          echo "âŒ API not ready in time"
          exit 1

      - name: Smoke (public)
        run: |
          set -euo pipefail
          curl -sS --fail "${{ steps.out.outputs.api_url }}/health" | jq .
          curl -sS --fail "${{ steps.out.outputs.api_url }}/catalog/rubros" | jq .

      - name: Generate Cognito JWT (tester)
        id: jwt
        uses: ./.github/actions/cognito-generate-jwt
        with:
          user_pool_id: ${{ env.COGNITO_USER_POOL_ID }}
          client_id: ${{ env.COGNITO_WEB_CLIENT }}
          username: ${{ vars.COGNITO_TESTER_USERNAME }}
          password: ${{ vars.COGNITO_TESTER_PASSWORD }}
          aws_region: ${{ env.AWS_REGION }}

      - name: Smoke (protected)
        continue-on-error: true
        run: |
          set -euo pipefail
          curl -sS -H "Authorization: Bearer ${{ steps.jwt.outputs.access_token }}" \
            "${{ steps.out.outputs.api_url }}/allocation-rules" | jq .

      - name: Show routes (debug)
        run: |
          set -euo pipefail
          API_ID="${{ steps.out.outputs.api_id }}"
          echo "Routes for API: $API_ID"
          aws apigatewayv2 get-routes --api-id "$API_ID" --query 'Items[].RouteKey' --output text | tr '\t' '\n' | sort || true

      - name: Summary
        run: |
          {
            echo "## ðŸš€ Finanzas API deployed (DEV)"
            echo ""
            echo "| Item | Value |"
            echo "|---|---|"
            echo "| Region | ${AWS_REGION} |"
            echo "| Stack | ${FINZ_API_STACK} |"
            echo "| Stage | ${FINZ_API_STAGE} |"
            echo "| API ID | ${{ steps.out.outputs.api_id }} |"
            echo "| API URL | ${{ steps.out.outputs.api_url }} |"
            echo "| Expected API ID | ${FINZ_EXPECTED_API_ID} |"
            echo "| Policy Store | ${POLICY_STORE_ID} |"
            echo "| Allow Drift | ${ALLOW_STAGE_DRIFT} |"
          } >> "$GITHUB_STEP_SUMMARY"
