name: Deploy Finanzas API (DEV)

on:
  push:
    branches:
      - "main"
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}

  # DEV-only for now
  DEPLOYMENT_ENV: dev
  FINZ_API_STACK: finanzas-sd-api-dev
  FINZ_API_STAGE: dev

  # Required (Cognito)
  COGNITO_USER_POOL_ID: ${{ vars.COGNITO_USER_POOL_ID }}
  COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
  COGNITO_WEB_CLIENT: ${{ vars.COGNITO_WEB_CLIENT }}

  # REQUIRED: do not default this (prevents wrong API ID regression)
  FINZ_API_ID_DEV: ${{ vars.FINZ_API_ID_DEV }}

  # Optional (AVP)
  POLICY_STORE_ID: ${{ vars.POLICY_STORE_ID || '' }}
  REQUIRED_POLICY_IDS_DEV: ${{ vars.REQUIRED_POLICY_IDS_DEV || '' }}

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install helpers
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Preflight env (fail fast)
        run: |
          set -euo pipefail
          echo "üöÄ ENV=${DEPLOYMENT_ENV}"
          echo "üì¶ STACK=${FINZ_API_STACK}"
          echo "üîå STAGE=${FINZ_API_STAGE}"
          echo "üåé REGION=${AWS_REGION}"

          for k in AWS_REGION DEPLOYMENT_ENV FINZ_API_STACK FINZ_API_STAGE \
                   COGNITO_USER_POOL_ID COGNITO_USER_POOL_ARN COGNITO_WEB_CLIENT FINZ_API_ID_DEV; do
            v="${!k:-}"
            if [ -z "$v" ]; then
              echo "‚ùå Missing required env/var: $k"
              exit 1
            fi
          done

          echo "‚úÖ Env OK"
          echo "üîë Expected DEV API ID: ${FINZ_API_ID_DEV}"

      - name: Configure AWS (OIDC)
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: finz-deploy-${{ github.run_id }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Preflight - Verify AVP Policy Store (optional)
        id: avp
        run: |
          set -euo pipefail
          if [ -z "${POLICY_STORE_ID:-}" ]; then
            echo "‚ÑπÔ∏è POLICY_STORE_ID not set. AVP drift checks will be skipped."
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "üîé Checking AVP Policy Store: $POLICY_STORE_ID"
          aws verifiedpermissions get-policy-store \
            --policy-store-id "$POLICY_STORE_ID" \
            --region "$AWS_REGION" >/dev/null

          echo "‚úÖ AVP Policy Store exists"
          echo "enabled=true" >> "$GITHUB_OUTPUT"

      - name: Install SAM CLI
        run: |
          set -euo pipefail
          pipx install aws-sam-cli
          sam --version

      - name: Install dependencies (API)
        working-directory: services/finanzas-api
        run: |
          set -euo pipefail
          if ! npm ci; then
            echo "npm ci failed; falling back to npm install"
            npm install
          fi

      - name: Build (SAM)
        working-directory: services/finanzas-api
        run: |
          set -euo pipefail
          npm i -g esbuild || true
          npm install esbuild --no-save || true
          export PATH="$PWD/node_modules/.bin:$PATH"
          sam build

      - name: AVP drift guard (schema + required policy IDs)
        if: steps.avp.outputs.enabled == 'true'
        working-directory: services/finanzas-api
        run: |
          set -euo pipefail
          echo "üîç Validating AVP schema and required policy IDs..."

          REMOTE_SCHEMA_JSON="$(aws verifiedpermissions get-schema \
            --policy-store-id "$POLICY_STORE_ID" \
            --region "$AWS_REGION" \
            --output json)"

          # Support multiple AWS response shapes safely
          REMOTE_SCHEMA="$(echo "$REMOTE_SCHEMA_JSON" | jq -er '
            if (.schema | type) == "string" then .schema
            elif (.schema | type) == "object" then
              (.schema.definition.cedarJson? // .schema.cedarJson? // .schema.definition? // empty)
            else empty end
          ')" || true

          if [ -z "${REMOTE_SCHEMA:-}" ]; then
            echo "‚ùå Unable to read Cedar schema from policy store: $POLICY_STORE_ID"
            echo "$REMOTE_SCHEMA_JSON" | head -c 400 || true
            exit 1
          fi

          printf '%s' "$REMOTE_SCHEMA" > /tmp/remote-schema.cedar

          # Find local schema file (dev-only) - try common repo layouts
          CANDIDATES=(
            "../../avp/schema.cedar"
            "../avp/schema.cedar"
            "avp/schema.cedar"
            "../../services/finanzas-api/avp/schema.cedar"
          )

          LOCAL_SCHEMA_PATH=""
          for c in "${CANDIDATES[@]}"; do
            if [ -f "$c" ]; then
              LOCAL_SCHEMA_PATH="$c"
              break
            fi
          done

          if [ -z "$LOCAL_SCHEMA_PATH" ]; then
            echo "‚ùå Could not find local schema.cedar from services/finanzas-api."
            echo "Tried:"
            printf ' - %s\n' "${CANDIDATES[@]}"
            exit 1
          fi

          echo "üìÑ Local schema: $LOCAL_SCHEMA_PATH"

          REMOTE_NORM="$(tr -d '[:space:]' < /tmp/remote-schema.cedar)"
          LOCAL_NORM="$(tr -d '[:space:]' < "$LOCAL_SCHEMA_PATH")"

          if [ "$REMOTE_NORM" != "$LOCAL_NORM" ]; then
            echo "‚ùå Schema drift detected between policy store and $LOCAL_SCHEMA_PATH"
            exit 1
          fi

          echo "‚úÖ AVP schema matches repository version"

          REQUIRED_IDS="$(echo "${REQUIRED_POLICY_IDS_DEV:-}" | tr ',' ' ' | xargs)"
          if [ -n "$REQUIRED_IDS" ]; then
            echo "üîí Verifying required DEV policies: $REQUIRED_IDS"
            POLICY_IDS="$(aws verifiedpermissions list-policies \
              --policy-store-id "$POLICY_STORE_ID" \
              --region "$AWS_REGION" \
              --query 'policies[].policyId' \
              --output text | tr '\t' '\n')"

            MISSING=()
            for PID in $REQUIRED_IDS; do
              echo "$POLICY_IDS" | grep -q "^${PID}$" || MISSING+=("$PID")
            done

            if [ ${#MISSING[@]} -gt 0 ]; then
              echo "‚ùå Missing required policy IDs: ${MISSING[*]}"
              exit 1
            fi
            echo "‚úÖ Required DEV AVP policies present"
          else
            echo "‚ÑπÔ∏è No REQUIRED_POLICY_IDS_DEV configured; skipping policy-id guard"
          fi

      - name: Preflight - Check stack status
        run: |
          set -euo pipefail
          STATUS="$(aws cloudformation describe-stacks \
            --stack-name "${FINZ_API_STACK}" \
            --region "${AWS_REGION}" \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null || echo "DOES_NOT_EXIST")"

          echo "Stack status: $STATUS"
          if [[ "$STATUS" == *"_IN_PROGRESS" ]]; then
            echo "‚ùå Stack update in progress. Retry later."
            exit 1
          fi

      - name: Auto-delete stack if stuck in rollback
        run: |
          set -euo pipefail
          STATUS="$(aws cloudformation describe-stacks \
            --stack-name "${FINZ_API_STACK}" \
            --region "${AWS_REGION}" \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null || echo "DOES_NOT_EXIST")"

          if [ "$STATUS" = "ROLLBACK_COMPLETE" ] || [ "$STATUS" = "ROLLBACK_FAILED" ]; then
            echo "‚ôªÔ∏è Deleting stuck stack: ${FINZ_API_STACK} ($STATUS)"
            aws cloudformation delete-stack --stack-name "${FINZ_API_STACK}" --region "${AWS_REGION}"
            aws cloudformation wait stack-delete-complete --stack-name "${FINZ_API_STACK}" --region "${AWS_REGION}"
            echo "‚úÖ Deleted. Proceeding."
          else
            echo "‚ÑπÔ∏è No delete needed ($STATUS)"
          fi

      - name: Deploy (SAM)
        working-directory: services/finanzas-api
        run: |
          set -euo pipefail

          sam deploy --no-confirm-changeset \
            --stack-name "${FINZ_API_STACK}" \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND \
            --region "${AWS_REGION}" \
            --parameter-overrides \
              CognitoUserPoolArn="${COGNITO_USER_POOL_ARN}" \
              CognitoUserPoolId="${COGNITO_USER_POOL_ID}" \
              CognitoUserPoolClientId="${COGNITO_WEB_CLIENT}" \
              StageName="${FINZ_API_STAGE}" \
              TablePrefix="finz_" \
              DocsBucketName="ukusi-ui-finanzas-prod" \
              PolicyStoreId="${POLICY_STORE_ID}" \
            || {
              echo "‚ùå sam deploy failed; showing recent CFN events"
              aws cloudformation describe-stack-events \
                --stack-name "${FINZ_API_STACK}" \
                --region "${AWS_REGION}" \
                --max-items 25 \
                --query 'StackEvents[0:12].[LogicalResourceId,ResourceStatus,ResourceStatusReason]' \
                --output table || true
              exit 1
            }

      - name: Output API info
        id: out
        run: |
          set -euo pipefail
          API_ID="$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" --region "${AWS_REGION}" \
            --query "Stacks[0].Outputs[?OutputKey=='FinzApiId'].OutputValue" --output text)"
          API_URL="$(aws cloudformation describe-stacks --stack-name "${FINZ_API_STACK}" --region "${AWS_REGION}" \
            --query "Stacks[0].Outputs[?OutputKey=='FinzApiUrl'].OutputValue" --output text)"

          echo "api_id=$API_ID" >> "$GITHUB_OUTPUT"
          echo "api_url=$API_URL" >> "$GITHUB_OUTPUT"
          echo "API_ID=$API_ID"
          echo "API_URL=$API_URL"

      - name: Guard - API id matches expected DEV id
        run: |
          set -euo pipefail
          HOST_ID="$(echo "${{ steps.out.outputs.api_url }}" | awk -F'[/.]' '{print $3}')"
          if [ "$HOST_ID" != "${FINZ_API_ID_DEV}" ]; then
            echo "‚ùå Expected DEV API id ${FINZ_API_ID_DEV} but got ${HOST_ID}"
            exit 1
          fi
          echo "‚úÖ API ID matches expected DEV id: $HOST_ID"

      - name: Guard - required routes + authorizer exist
        run: |
          set -euo pipefail
          API_ID="${{ steps.out.outputs.api_id }}"

          ROUTES="$(aws apigatewayv2 get-routes --api-id "$API_ID" --query 'Items[].RouteKey' --output text | tr '\t' '\n')"

          for ROUTE in "GET /health" "GET /catalog/rubros" "POST /projects"; do
            echo "$ROUTES" | grep -q "^${ROUTE}$" || { echo "‚ùå Missing route: $ROUTE"; exit 1; }
            echo "‚úÖ Route: $ROUTE"
          done

          AUTH_COUNT="$(aws apigatewayv2 get-authorizers --api-id "$API_ID" --query 'length(Items[?Name==`CognitoJwt`])' --output text)"
          if [ "$AUTH_COUNT" = "0" ]; then
            echo "‚ùå CognitoJwt authorizer not found"
            exit 1
          fi
          echo "‚úÖ CognitoJwt authorizer present"

      - name: Readiness - wait for /health (max 90s)
        env:
          BASE: ${{ steps.out.outputs.api_url }}
        run: |
          set -euo pipefail
          for i in $(seq 1 18); do
            CODE="$(curl -sS -o /dev/null -w '%{http_code}' "$BASE/health" || true)"
            if [ "$CODE" = "200" ]; then
              echo "‚úÖ API ready (health=200)"
              exit 0
            fi
            echo "‚è≥ Waiting... try=$i code=$CODE"
            sleep 5
          done
          echo "‚ùå API not ready in time"
          exit 1

      - name: Smoke - GET /health
        run: |
          set -euo pipefail
          curl -sS --fail "${{ steps.out.outputs.api_url }}/health" | jq .

      - name: Generate Cognito JWT (for protected smokes)
        id: jwt
        uses: ./.github/actions/cognito-generate-jwt
        with:
          user_pool_id: ${{ env.COGNITO_USER_POOL_ID }}
          client_id: ${{ env.COGNITO_WEB_CLIENT }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          aws_region: ${{ env.AWS_REGION }}

      - name: Smoke - GET /allocation-rules (JWT)
        run: |
          set -euo pipefail
          curl -sS --fail \
            -H "Authorization: Bearer ${{ steps.jwt.outputs.access_token }}" \
            "${{ steps.out.outputs.api_url }}/allocation-rules" | jq .

      - name: Collect CatalogFn logs (only on failure)
        if: failure()
        run: |
          set -euo pipefail
          STACK="${FINZ_API_STACK}"

          FN="$(aws cloudformation list-stack-resources --stack-name "$STACK" --region "${AWS_REGION}" \
            --query "StackResourceSummaries[?LogicalResourceId=='CatalogFn'].PhysicalResourceId" --output text || true)"

          echo "CatalogFn physical id: $FN" | tee -a "$GITHUB_STEP_SUMMARY"
          if [ -z "${FN:-}" ] || [ "$FN" = "None" ]; then
            echo "Could not resolve CatalogFn physical id" | tee -a "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          LOG_GROUP="/aws/lambda/$FN"
          STREAM="$(aws logs describe-log-streams --log-group-name "$LOG_GROUP" --region "${AWS_REGION}" \
            --order-by LastEventTime --descending --max-items 1 --query 'logStreams[0].logStreamName' --output text || true)"

          if [ -z "${STREAM:-}" ] || [ "$STREAM" = "None" ]; then
            echo "No log streams found for $LOG_GROUP" | tee -a "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "### CloudWatch Logs (CatalogFn)" >> "$GITHUB_STEP_SUMMARY"
          aws logs get-log-events \
            --log-group-name "$LOG_GROUP" \
            --log-stream-name "$STREAM" \
            --region "${AWS_REGION}" \
            --limit 100 \
            --query 'events[].message' \
            --output text | tail -n 100 | sed 's/^/    /' >> "$GITHUB_STEP_SUMMARY" || true

      - name: Summary
        run: |
          set -euo pipefail
          {
            echo "## ‚úÖ Finanzas API deployed (DEV)"
            echo ""
            echo "| Key | Value |"
            echo "|---|---|"
            echo "| Region | ${AWS_REGION} |"
            echo "| Stack | ${FINZ_API_STACK} |"
            echo "| Stage | ${FINZ_API_STAGE} |"
            echo "| API ID | ${{ steps.out.outputs.api_id }} |"
            echo "| API URL | ${{ steps.out.outputs.api_url }} |"
            echo "| Expected DEV API ID | ${FINZ_API_ID_DEV} |"
            echo "| AVP Enabled | ${{ steps.avp.outputs.enabled || 'false' }} |"
            if [ -n "${POLICY_STORE_ID:-}" ]; then
              echo "| Policy Store ID | ${POLICY_STORE_ID} |"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
