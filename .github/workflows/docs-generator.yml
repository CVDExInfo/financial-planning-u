name: Documentation Generator - AWS Architecture Diagrams & Bilingual Pipeline

# Triggers:
# - Manual workflow_dispatch (any branch)
# - Push to main with documentation changes
# - PR with documentation changes (for validation only, no commit)
on:
  workflow_dispatch:
    inputs:
      commit_generated:
        description: 'Commit generated files to repository'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'diagrams/**'
      - 'scripts/docs/**'
      - '.github/workflows/docs-generator.yml'
  pull_request:
    paths:
      - 'docs/**'
      - 'diagrams/**'
      - 'scripts/docs/**'
      - '.github/workflows/docs-generator.yml'

permissions:
  contents: write  # Required to commit and push generated documentation
  pull-requests: write

jobs:
  build-docs:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # Step 2: Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # Step 3: Install project dependencies
      - name: Install dependencies
        run: npm ci
      
      # Step 4: Install Pandoc for document conversion
      - name: Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-latex-extra texlive-lang-spanish
          pandoc --version
      
      # Step 5: Install Mermaid CLI for diagram rendering
      - name: Install Mermaid CLI
        run: |
          npm install -g @mermaid-js/mermaid-cli@11.4.1
          mmdc --version
      
      # Step 6: Install Chromium for mermaid-cli (required for rendering)
      - name: Install Chromium dependencies
        run: |
          sudo apt-get install -y chromium-browser
          export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
          export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
      
      # Step 7: Validate diagram syntax
      - name: Validate diagrams
        run: |
          echo "Validating Mermaid diagram syntax..."
          chmod +x scripts/docs/validate-diagrams.sh
          ./scripts/docs/validate-diagrams.sh
      
      # Step 8: Render diagrams to PNG/SVG
      - name: Render diagrams
        env:
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium-browser
        run: |
          echo "Rendering diagrams to PNG and SVG..."
          mkdir -p public/docs/latest/diagrams
          
          # Find all .mmd files in diagrams directories
          for mmd_file in diagrams/*.mmd docs/diagrams/*.mmd docs/architecture/diagrams/*.mmd; do
            if [ -f "$mmd_file" ]; then
              filename=$(basename "$mmd_file" .mmd)
              echo "Rendering: $filename"
              
              # Render to PNG (high resolution)
              mmdc -i "$mmd_file" -o "public/docs/latest/diagrams/${filename}.png" -t base -w 2400 -H 1600 -b transparent || echo "Warning: Failed to render PNG for $filename"
              
              # Render to SVG
              mmdc -i "$mmd_file" -o "public/docs/latest/diagrams/${filename}.svg" -t base -b transparent || echo "Warning: Failed to render SVG for $filename"
            fi
          done
          
          echo "Diagram rendering completed"
          ls -lh public/docs/latest/diagrams/ || echo "No diagrams generated"
      
      # Step 9: Run documentation rendering script
      - name: Generate documentation
        env:
          USE_CVDEX_BRANDING: ${{ vars.USE_CVDEX_BRANDING || 'false' }}
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium-browser
        run: |
          echo "Branding: $USE_CVDEX_BRANDING"
          npm run render-docs
      
      # Step 13: Verify output files exist
      - name: Verify generated files
        run: |
          echo "Checking for generated documentation files..."
          ls -lah public/docs/latest/
          
          # Count PDF, DOCX, and SVG files
          PDF_COUNT=$(find public/docs/latest -name "*.pdf" -type f | wc -l)
          DOCX_COUNT=$(find public/docs/latest -name "*.docx" -type f | wc -l)
          SVG_COUNT=$(find public/docs/latest -name "*.svg" -type f | wc -l)
      # Step 10: Verify output files exist
      - name: Verify generated files
        run: |
          echo "Checking for generated documentation files..."
          ls -lah public/docs/latest/ || mkdir -p public/docs/latest/
          
          # Count PDF, DOCX, PNG, and SVG files
          PDF_COUNT=$(find public/docs/latest -name "*.pdf" -type f 2>/dev/null | wc -l)
          DOCX_COUNT=$(find public/docs/latest -name "*.docx" -type f 2>/dev/null | wc -l)
          PNG_COUNT=$(find public/docs/latest -name "*.png" -type f 2>/dev/null | wc -l)
          SVG_COUNT=$(find public/docs/latest -name "*.svg" -type f 2>/dev/null | wc -l)
          
          echo "Generated files:"
          echo "  PDFs: $PDF_COUNT"
          echo "  DOCXs: $DOCX_COUNT"
          echo "  Diagrams (PNG): $PNG_COUNT"
          echo "  Diagrams (SVG): $SVG_COUNT"
          
          # Verify at least some diagrams were generated
          TOTAL_DIAGRAMS=$((PNG_COUNT + SVG_COUNT))
          if [ $TOTAL_DIAGRAMS -lt 1 ]; then
            echo "Warning: No diagram files found"
          else
            echo "âœ“ Generated $TOTAL_DIAGRAMS diagram files"
          fi
          
          echo "âœ“ Verification complete"
      
      # Step 11: Configure Git (only if committing)
      - name: Configure Git
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.commit_generated == 'true')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      # Step 12: Stage generated files (only on main or manual with commit enabled)
      - name: Stage documentation changes
        id: stage_docs
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.commit_generated == 'true')
        run: |
          git add public/docs/latest/

          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "changes=true" >> $GITHUB_OUTPUT

      # Step 12b: Create docs PR from generated branch
      - name: Create or update Finanzas docs PR
        if: (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.commit_generated == 'true')) && steps.stage_docs.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: Update Finanzas diagrams and documentation [skip ci]"
          branch: docs/finanzas-generated
          base: main
          title: "docs: Update Finanzas diagrams and documentation"
          body: |
            This PR contains updated Finanzas SD documentation and diagrams generated by the docs workflow.
            Please review and merge to apply the latest documentation.
            
            - Branding flag: `${{ vars.USE_CVDEX_BRANDING || 'false' }}`
            - Workflow run: `${{ github.workflow }} #${{ github.run_number }}`
          labels: documentation, finanzas
          add-paths: |
            public/docs/latest/**
      
      # Step 13: Create artifact for download
      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: finanzas-docs-diagrams-${{ github.run_number }}
          path: public/docs/latest/
          retention-days: 90
          if-no-files-found: warn
      
      # Step 14: Generate job summary
      - name: Generate job summary
        if: always()
        run: |
          echo "## ðŸ“Š AWS Architecture Diagrams & Documentation Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branding:** ${{ vars.USE_CVDEX_BRANDING == 'true' && 'CVDex' || 'Ikusi' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Generated At:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d public/docs/latest ]; then
            PDF_COUNT=$(find public/docs/latest -name "*.pdf" -type f 2>/dev/null | wc -l)
            DOCX_COUNT=$(find public/docs/latest -name "*.docx" -type f 2>/dev/null | wc -l)
            PNG_COUNT=$(find public/docs/latest -name "*.png" -type f 2>/dev/null | wc -l)
            SVG_COUNT=$(find public/docs/latest -name "*.svg" -type f 2>/dev/null | wc -l)
            echo "- **PDF files:** $PDF_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **DOCX files:** $DOCX_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Diagram PNG files:** $PNG_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Diagram SVG files:** $SVG_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ¨ AWS Architecture Diagrams" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            TOTAL_DIAGRAMS=$((PNG_COUNT + SVG_COUNT))
            if [ $TOTAL_DIAGRAMS -gt 0 ]; then
              echo "Generated **$TOTAL_DIAGRAMS** high-quality AWS architecture diagrams:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              find public/docs/latest/diagrams -name "*.svg" -type f 2>/dev/null -exec basename {} .svg \; | sed 's/^/- âœ… /' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Formats:** PNG (2400x1600) and SVG (scalable)" >> $GITHUB_STEP_SUMMARY
              echo "**Color Scheme:** AWS 2025 Framework (Orange, Blue, Purple, Green)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ No diagrams were generated" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Output Directory" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -lh public/docs/latest/diagrams/ 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || echo "No diagrams directory" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Output directory not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifact Download" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the generated documentation and diagrams from the **Artifacts** section of this workflow run." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact Name:** \`finanzas-docs-diagrams-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Retention:** 90 days" >> $GITHUB_STEP_SUMMARY
