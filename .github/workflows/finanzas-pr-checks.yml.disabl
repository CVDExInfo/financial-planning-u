name: Finanzas PR Quality Gates

on:
  pull_request:
    branches: ["main"]
    paths:
      - 'src/**'
      - 'vite.config.ts'
      - 'package*.json'
      - '.github/workflows/finanzas-pr-checks.yml'
      - 'scripts/build-guards-finanzas.sh'
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-2' }}
  VITE_API_BASE_URL: ${{ vars.DEV_API_URL || 'https://m3g6am67aj.execute-api.us-east-2.amazonaws.com/dev' }}
  VITE_FINZ_ENABLED: "true"
  VITE_USE_MOCKS: "false"
  VITE_PUBLIC_BASE: "/finanzas/"

jobs:
  finanzas-quality-gates:
    runs-on: ubuntu-latest
    name: Finanzas Quality Gates
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: |
          set -e
          echo "Installing frontend dependencies..."
          if ! npm ci; then
            echo "npm ci failed (likely lock mismatch). Falling back to npm install."
            npm install
          fi

      # ============================================================
      # Guard: Environment Variables Validation
      # ============================================================
      - name: "Guard: Environment Variables Validation"
        run: |
          set -euo pipefail
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║   Environment Variables Validation                            ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""
          
          FAILED=0
          
          # Check required variables
          echo "Checking required environment variables..."
          
          if [ -z "${VITE_API_BASE_URL:-}" ]; then
            echo "❌ VITE_API_BASE_URL is not set"
            FAILED=1
          else
            echo "✅ VITE_API_BASE_URL=${VITE_API_BASE_URL}"
          fi
          
          if [ -z "${VITE_FINZ_ENABLED:-}" ]; then
            echo "❌ VITE_FINZ_ENABLED is not set"
            FAILED=1
          else
            echo "✅ VITE_FINZ_ENABLED=${VITE_FINZ_ENABLED}"
          fi
          
          if [ -z "${VITE_PUBLIC_BASE:-}" ]; then
            echo "❌ VITE_PUBLIC_BASE is not set"
            FAILED=1
          else
            echo "✅ VITE_PUBLIC_BASE=${VITE_PUBLIC_BASE}"
          fi
          
          # Validate VITE_PUBLIC_BASE value
          if [ "${VITE_PUBLIC_BASE}" != "/finanzas/" ]; then
            echo "❌ VITE_PUBLIC_BASE must be '/finanzas/', got '${VITE_PUBLIC_BASE}'"
            FAILED=1
          fi
          
          # Validate VITE_FINZ_ENABLED value
          if [ "${VITE_FINZ_ENABLED}" != "true" ]; then
            echo "❌ VITE_FINZ_ENABLED must be 'true', got '${VITE_FINZ_ENABLED}'"
            FAILED=1
          fi
          
          echo ""
          if [ $FAILED -eq 0 ]; then
            echo "✅ All required environment variables are set correctly"
          else
            echo "❌ Environment validation failed"
            exit 1
          fi

      # ============================================================
      # Build: Finanzas UI
      # ============================================================
      - name: "Build: Finanzas UI"
        env:
          BUILD_TARGET: finanzas
          VITE_API_BASE_URL: ${{ env.VITE_API_BASE_URL }}
          VITE_FINZ_ENABLED: "true"
          VITE_USE_MOCKS: "false"
          VITE_PUBLIC_BASE: "/finanzas/"
        run: |
          set -euo pipefail
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║   Building Finanzas UI                                        ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Build Configuration:"
          echo "  BUILD_TARGET: ${BUILD_TARGET}"
          echo "  VITE_PUBLIC_BASE: ${VITE_PUBLIC_BASE}"
          echo "  VITE_FINZ_ENABLED: ${VITE_FINZ_ENABLED}"
          echo "  VITE_API_BASE_URL: ${VITE_API_BASE_URL}"
          echo ""
          
          BUILD_TARGET=finanzas npm run build || {
            echo "❌ Finanzas build failed"
            exit 1
          }
          
          echo ""
          echo "✅ Finanzas build completed successfully"
          echo "   Output: dist-finanzas/"

      # ============================================================
      # Guard: Build Artifact Validation
      # ============================================================
      - name: "Guard: Build Artifact Validation"
        run: |
          set -euo pipefail
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║   Build Artifact Validation (Critical Guards)                ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""
          
          chmod +x ./scripts/build-guards-finanzas.sh
          
          # Run comprehensive build guards
          ./scripts/build-guards-finanzas.sh --skip-env-check || {
            echo ""
            echo "❌ Build guards failed - see details above"
            exit 1
          }

      # ============================================================
      # Lint: Code Quality
      # ============================================================
      - name: "Lint: Code Quality Check"
        continue-on-error: true
        run: |
          set -euo pipefail
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║   Code Quality - ESLint                                       ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""
          
          npm run lint || {
            echo "⚠️  Linting found issues (non-blocking)"
            echo "   Please review and fix linting warnings/errors"
          }

      # ============================================================
      # Test: API Smoke Tests (Optional)
      # ============================================================
      - name: "Test: API Health Check"
        continue-on-error: true
        run: |
          set -euo pipefail
          echo "╔════════════════════════════════════════════════════════════════╗"
          echo "║   API Health Check                                            ║"
          echo "╚════════════════════════════════════════════════════════════════╝"
          echo ""
          
          API_BASE="${VITE_API_BASE_URL%/}"
          echo "Testing API: $API_BASE/health"
          
          HEALTH_CODE=$(curl -sS -o /tmp/health.json -w '%{http_code}' "$API_BASE/health" || echo "000")
          
          if [ "$HEALTH_CODE" = "200" ]; then
            echo "✅ API Health: $HEALTH_CODE OK"
            cat /tmp/health.json | jq . || cat /tmp/health.json
          else
            echo "⚠️  API Health: $HEALTH_CODE (expected 200)"
            echo "   This is non-blocking but should be investigated"
          fi

      # ============================================================
      # Summary
      # ============================================================
      - name: "Summary: PR Quality Gates"
        if: success()
        run: |
          set -euo pipefail
          {
            echo "# ✅ Finanzas PR Quality Gates - All Checks Passed"
            echo ""
            echo "## Build Configuration"
            echo "| Variable | Value |"
            echo "|----------|-------|"
            echo "| BUILD_TARGET | finanzas |"
            echo "| VITE_PUBLIC_BASE | ${VITE_PUBLIC_BASE} |"
            echo "| VITE_FINZ_ENABLED | ${VITE_FINZ_ENABLED} |"
            echo "| VITE_API_BASE_URL | ${VITE_API_BASE_URL} |"
            echo ""
            echo "## Quality Gates Status"
            echo "- ✅ Environment variables validated"
            echo "- ✅ Finanzas UI build successful"
            echo "- ✅ Base path verification passed (/finanzas/)"
            echo "- ✅ No hardcoded development URLs found"
            echo "- ✅ Asset integrity verified"
            echo ""
            echo "## Build Output"
            echo "- **Directory**: dist-finanzas/"
            echo "- **Base Path**: /finanzas/"
            echo "- **Assets**: dist-finanzas/assets/"
            echo ""
            echo "## Next Steps"
            echo "1. Review the PR changes"
            echo "2. Ensure all tests pass"
            echo "3. Get peer review approval"
            echo "4. Merge when ready"
            echo ""
            echo "---"
            echo "*This automated check ensures Finanzas builds correctly with proper configuration*"
          } >> $GITHUB_STEP_SUMMARY

      - name: "Summary: PR Quality Gates (Failure)"
        if: failure()
        run: |
          set -euo pipefail
          {
            echo "# ❌ Finanzas PR Quality Gates - Checks Failed"
            echo ""
            echo "## Failed Checks"
            echo "One or more quality gates failed. Please review the logs above."
            echo ""
            echo "## Common Issues"
            echo "1. **Base Path Mismatch**: Ensure vite.config.ts has \`base: '/finanzas/'\`"
            echo "2. **Development URLs**: Remove any github.dev, codespaces, or localhost references"
            echo "3. **Environment Variables**: Check that all required vars are set"
            echo "4. **Build Errors**: Review TypeScript/Vite build errors"
            echo ""
            echo "## How to Fix"
            echo "1. Review the failed guard output above"
            echo "2. Run locally: \`BUILD_TARGET=finanzas npm run build\`"
            echo "3. Run guards locally: \`./scripts/build-guards-finanzas.sh\`"
            echo "4. Fix issues and push changes"
            echo ""
            echo "## Local Testing"
            echo "\`\`\`bash"
            echo "# Set environment"
            echo "export VITE_API_BASE_URL=\"https://m3g6am67aj.execute-api.us-east-2.amazonaws.com/dev\""
            echo "export VITE_FINZ_ENABLED=\"true\""
            echo "export VITE_PUBLIC_BASE=\"/finanzas/\""
            echo ""
            echo "# Build"
            echo "BUILD_TARGET=finanzas npm run build"
            echo ""
            echo "# Run guards"
            echo "./scripts/build-guards-finanzas.sh"
            echo "\`\`\`"
          } >> $GITHUB_STEP_SUMMARY
