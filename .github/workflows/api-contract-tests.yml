name: API Contract Tests (Newman + No-Fallback Guard)
on:
  pull_request:
    paths:
      - "postman/**"
      - "services/finanzas-api/**"
      - ".github/workflows/api-contract-tests.yml"
  schedule:
    - cron: "0 2 * * *"  # Nightly at 2 AM UTC
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  contract-tests:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    # Promote repo vars + secret presence flags
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      DEV_API_URL: ${{ vars.DEV_API_URL }}
      COGNITO_USER_POOL_ID: ${{ vars.COGNITO_USER_POOL_ID }}
      COGNITO_WEB_CLIENT: ${{ vars.COGNITO_WEB_CLIENT }}
      HAS_USERNAME: ${{ secrets.USERNAME != '' }}
      HAS_PASSWORD: ${{ secrets.PASSWORD != '' }}
      HAS_OIDC_ROLE: ${{ secrets.OIDC_AWS_ROLE_ARN != '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Normalize line endings for local actions
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dos2unix
          find .github/actions -type f -print0 | xargs -0 dos2unix || true

      - name: Preflight repo settings
        shell: bash
        run: |
          set -euo pipefail
          for k in AWS_REGION DEV_API_URL COGNITO_USER_POOL_ID COGNITO_WEB_CLIENT; do
            v="${!k:-}"
            [[ -n "$v" ]] || { echo "âŒ Missing env: $k"; exit 1; }
          done
          [[ "$HAS_USERNAME"  == "true" ]] || { echo "âŒ Missing repo secret: USERNAME"; exit 1; }
          [[ "$HAS_PASSWORD"  == "true" ]] || { echo "âŒ Missing repo secret: PASSWORD"; exit 1; }
          [[ "$HAS_OIDC_ROLE" == "true" ]] || { echo "âŒ Missing repo secret: OIDC_AWS_ROLE_ARN"; exit 1; }
          echo "âœ… Vars/Secrets OK"

      - name: Configure AWS (OIDC)
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: contract-tests-${{ github.run_id }}

      - name: Normalize base URL
        run: |
          set -euo pipefail
          : "${DEV_API_URL:?DEV_API_URL is empty}"
          # Strip whitespace and trailing slashes
          CLEAN_URL=$(echo "$DEV_API_URL" | tr -d '\r\n' | sed 's:/*$::')
          echo "Using DEV_API_URL: ${CLEAN_URL}"
          printf 'BASE=%s\n' "$CLEAN_URL" >> "$GITHUB_ENV"
          sed -i 's/\r$//' "$GITHUB_ENV"

      - name: Generate Cognito JWT
        id: jwt
        uses: ./.github/actions/cognito-generate-jwt
        with:
          user_pool_id: ${{ env.COGNITO_USER_POOL_ID }}
          client_id: ${{ env.COGNITO_WEB_CLIENT }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          aws_region: ${{ env.AWS_REGION }}

      - name: "Install Node + Newman"
        run: |
          npm install -g newman newman-reporter-json
          newman --version

      - name: "Newman Contract Tests - Finanzas SD API"
        id: newman
        continue-on-error: false
        run: |
          set -euo pipefail

          POSTMAN_COLLECTION="postman/finanzas-sd-api-collection.json"
          POSTMAN_ENV="postman/finanzas-sd-dev.postman_environment.json"
          OUTPUT_DIR="/tmp/newman"
          mkdir -p "$OUTPUT_DIR"

          echo "Running Newman contract tests with collection: $POSTMAN_COLLECTION"
          echo "Base URL: ${{ env.BASE }}"

          # Run Newman with proper environment variables
          newman run "$POSTMAN_COLLECTION" \
            --environment "$POSTMAN_ENV" \
            --env-var "baseUrl=${{ env.BASE }}" \
            --env-var "access_token=${{ steps.jwt.outputs.access_token }}" \
            --env-var "username=${{ secrets.USERNAME }}" \
            --env-var "password=${{ secrets.PASSWORD }}" \
            --env-var "cognito_client_id=${{ env.COGNITO_WEB_CLIENT }}" \
            --reporters cli,junit,json \
            --reporter-junit-export "$OUTPUT_DIR/newman-junit.xml" \
            --reporter-json-export "$OUTPUT_DIR/newman-report.json" \
            --timeout-request 10000 \
            --timeout-script 5000 \
            --bail

          printf '%s\n' "newman_report=$OUTPUT_DIR/newman-report.json" >> "$GITHUB_OUTPUT"
          echo "âœ… Newman contract tests completed successfully"

      - name: "Parse Newman Results and Generate Report"
        if: always()
        run: |
          set -euo pipefail
          REPORT="/tmp/newman/newman-report.json"

          {
            echo "## ðŸ§ª Newman API Contract Test Results"
            echo ""
            
            if [ ! -f "$REPORT" ]; then
              echo "âš ï¸  No Newman report found. Tests may have failed to execute."
              exit 0
            fi
            
            TOTAL=$(jq '.run.stats.tests.total' "$REPORT" 2>/dev/null || echo "?")
            PASSED=$(jq '.run.stats.tests.passed' "$REPORT" 2>/dev/null || echo "?")
            FAILED=$(jq '.run.stats.tests.failed' "$REPORT" 2>/dev/null || echo "?")
            
            echo "### ðŸ“Š Summary"
            echo "- **Total Tests**: $TOTAL"
            echo "- **Passed**: âœ… $PASSED"
            echo "- **Failed**: âŒ $FAILED"
            echo ""
            
            if [ "$FAILED" != "0" ] && [ "$FAILED" != "?" ]; then
              echo "### âŒ Failed Tests"
              jq -r '.run.executions[] | select(.assertions[]? | select(.error != null)) | "- **\(.item.name)**: \(.assertions[] | select(.error != null) | .error.message // "Unknown error")"' "$REPORT" 2>/dev/null || echo "- (parsing error)"
              echo ""
            fi
            
            echo "### ðŸ“‹ Endpoints Tested"
            jq -r '.run.executions[] | "- \(.item.name): HTTP \(.response.code // "N/A") (\(.response.responseTime // 0)ms)"' "$REPORT" 2>/dev/null | head -30 || echo "- (parsing error)"
            echo ""

            # Check for no-fallback guard failures
            FALLBACK_FAILURES=$(jq -r '.run.executions[] | .assertions[]? | select(.assertion | contains("fallback marker")) | select(.error != null)' "$REPORT" 2>/dev/null | wc -l || echo "0")
            if [ "$FALLBACK_FAILURES" != "0" ]; then
              echo "### ðŸš¨ No-Fallback Guard Violations"
              echo "Found **$FALLBACK_FAILURES** responses containing mock/DEFAULT data markers!"
              echo ""
              jq -r '.run.executions[] | select(.assertions[]? | select(.assertion | contains("fallback marker")) | select(.error != null)) | "- **\(.item.name)**: Contains DEFAULT/mock data"' "$REPORT" 2>/dev/null || echo "- (parsing error)"
              echo ""
            else
              echo "### âœ… No-Fallback Guard: PASSED"
              echo "No DEFAULT or mock data markers detected in any responses."
              echo ""
            fi
            
            echo "### ðŸ“ Configuration"
            echo "- **API Base**: ${{ env.BASE }}"
            echo "- **Collection**: postman/finanzas-sd-api-collection.json"
            echo "- **Environment**: postman/finanzas-sd-dev.postman_environment.json"
            echo "- **Cognito Pool**: ${{ env.COGNITO_USER_POOL_ID }}"
          } >> $GITHUB_STEP_SUMMARY

      - name: "Upload Newman Report"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-contract-report
          path: |
            /tmp/newman/newman-report.json
            /tmp/newman/newman-junit.xml
          if-no-files-found: warn
          retention-days: 30

      - name: "Contract Tests Complete"
        if: always()
        run: |
          {
            echo "## âœ… Contract Test Execution Complete"
            echo ""
            echo "All API contract tests have been executed with the no-fallback guard enabled."
            echo "Review the detailed results above and check artifacts for full Newman reports."
          } >> "$GITHUB_STEP_SUMMARY"

