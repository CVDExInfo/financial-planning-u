name: API Contract Tests (Newman + Core Actions)
on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["r1-finanzas-dev-wiring"]
    paths:
      - "postman/**"
      - "services/finanzas-api/src/**"
      - ".github/workflows/api-contract-tests.yml"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  contract-tests:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    # Promote repo vars + secret presence flags
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      DEV_API_URL: ${{ vars.DEV_API_URL }}
      COGNITO_USER_POOL_ID: ${{ vars.COGNITO_USER_POOL_ID }}
      COGNITO_WEB_CLIENT: ${{ vars.COGNITO_WEB_CLIENT }}
      HAS_USERNAME: ${{ secrets.USERNAME != '' }}
      HAS_PASSWORD: ${{ secrets.PASSWORD != '' }}
      HAS_OIDC_ROLE: ${{ secrets.OIDC_AWS_ROLE_ARN != '' }}

    steps:
      - uses: actions/checkout@v4

      - name: Normalize line endings for local actions
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dos2unix
          find .github/actions -type f -print0 | xargs -0 dos2unix || true

      - name: Preflight repo settings
        shell: bash
        run: |
          set -euo pipefail
          for k in AWS_REGION DEV_API_URL COGNITO_USER_POOL_ID COGNITO_WEB_CLIENT; do
            v="${!k:-}"
            [[ -n "$v" ]] || { echo "❌ Missing env: $k"; exit 1; }
          done
          [[ "$HAS_USERNAME"  == "true" ]] || { echo "❌ Missing repo secret: USERNAME"; exit 1; }
          [[ "$HAS_PASSWORD"  == "true" ]] || { echo "❌ Missing repo secret: PASSWORD"; exit 1; }
          [[ "$HAS_OIDC_ROLE" == "true" ]] || { echo "❌ Missing repo secret: OIDC_AWS_ROLE_ARN"; exit 1; }
          echo "✅ Vars/Secrets OK"

      - name: Configure AWS (OIDC)
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ secrets.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: contract-tests-${{ github.run_id }}

      - name: Normalize base URL
        run: |
          set -euo pipefail
          : "${DEV_API_URL:?DEV_API_URL is empty}"
          # Strip whitespace and trailing slashes
          CLEAN_URL=$(echo "$DEV_API_URL" | tr -d '\r\n' | sed 's:/*$::')
          echo "Using DEV_API_URL: ${CLEAN_URL}"
          printf 'BASE=%s\n' "$CLEAN_URL" >> "$GITHUB_ENV"
          sed -i 's/\r$//' "$GITHUB_ENV"

      - name: Generate Cognito JWT
        id: jwt
        uses: ./.github/actions/cognito-generate-jwt
        with:
          user_pool_id: ${{ env.COGNITO_USER_POOL_ID }}
          client_id: ${{ env.COGNITO_WEB_CLIENT }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          aws_region: ${{ env.AWS_REGION }}

      - name: "Install Node + Newman"
        run: |
          npm install -g newman newman-reporter-json
          newman --version

      - name: "Newman Contract Tests - Full Collection"
        id: newman
        continue-on-error: true
        run: |
          set -euo pipefail

          POSTMAN_FILE="postman/Finanzas.postman_collection.json"
          OUTPUT_FILE="/tmp/newman-report.json"

          echo "Running Newman with collection: $POSTMAN_FILE"

          # Create temporary environment file
          cat > /tmp/newman-env.json <<EOF
          {
            "id": "finanzas-env",
            "name": "Finanzas API (Test)",
            "values": [
              {
                "key": "base_url",
                "value": "${{ env.BASE }}",
                "type": "string"
              },
              {
                "key": "jwt_token",
                "value": "${{ steps.jwt.outputs.id_token }}",
                "type": "string"
              }
            ]
          }
          EOF

          newman run "$POSTMAN_FILE" \
            --environment /tmp/newman-env.json \
            --reporters json,cli \
            --reporter-json-export "$OUTPUT_FILE" \
            --timeout-request 10000 \
            --timeout-script 5000 || true

          printf '%s\n' "newman_report=$OUTPUT_FILE" >> "$GITHUB_OUTPUT"
          echo "✅ Newman tests completed"

      - name: "Parse Newman Results"
        if: always()
        run: |
          set -euo pipefail
          REPORT="/tmp/newman-report.json"

          {
            echo "## Newman Contract Test Results"
            echo ""
            
            if [ ! -f "$REPORT" ]; then
              echo "⚠️  No Newman report found. Tests may have failed to execute."
              exit 0
            fi
            
            TOTAL=$(jq '.run.stats.tests.total' "$REPORT" 2>/dev/null || echo "?")
            PASSED=$(jq '.run.stats.tests.passed' "$REPORT" 2>/dev/null || echo "?")
            FAILED=$(jq '.run.stats.tests.failed' "$REPORT" 2>/dev/null || echo "?")
            
            echo "### Summary"
            echo "- Total: $TOTAL"
            echo "- Passed: $PASSED"
            echo "- Failed: $FAILED"
            echo ""
            
            echo "#### Requests Tested"
            jq -r '.run.executions[] | "- \(.item.name) (HTTP \(.response.code))"' "$REPORT" 2>/dev/null | head -20 || echo "- (parsing error)"
          } >> $GITHUB_STEP_SUMMARY

      - name: "Upload Newman Report"
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: newman-report
          path: /tmp/newman-report.json
          if-no-files-found: warn
          retention-days: 30

      - name: "Core Action Smoke Tests (5 MVP actions)"
        id: smokes
        run: |
          set -euo pipefail
          BASE="${{ env.BASE }}"
          JWT="${{ steps.jwt.outputs.id_token }}"

          {
            echo "## Core Action Smoke Tests (MVP)"
            echo ""
          } >> $GITHUB_STEP_SUMMARY

          # Action 1: Load Rubros
          {
            echo "### Action 1: Load Rubros (GET /catalog/rubros)"
            CODE=$(curl -sS -o /tmp/rubros.json -w '%{http_code}' \
              -H "Authorization: Bearer $JWT" \
              "$BASE/catalog/rubros")
            echo "- HTTP Status: $CODE"
            if [ "$CODE" = "200" ]; then
              COUNT=$(jq '.data | length' /tmp/rubros.json 2>/dev/null || echo "?")
              echo "- Rubros Count: $COUNT"
              echo "- ✅ PASS"
            else
              echo "- ❌ FAIL (expected 200)"
            fi
            echo ""
          } >> $GITHUB_STEP_SUMMARY

          # Action 2: View Allocation Rules
          {
            echo "### Action 2: View Allocation Rules (GET /allocation-rules)"
            CODE=$(curl -sS -o /tmp/rules.json -w '%{http_code}' \
              -H "Authorization: Bearer $JWT" \
              "$BASE/allocation-rules")
            echo "- HTTP Status: $CODE"
            if [ "$CODE" = "200" ] || [ "$CODE" = "501" ]; then
              COUNT=$(jq '.data | length' /tmp/rules.json 2>/dev/null || echo "?")
              echo "- Rules Count: $COUNT"
              [ "$CODE" = "200" ] && echo "- ✅ PASS" || echo "- ⚠️  501 (not yet implemented)"
            else
              echo "- ❌ FAIL (expected 200 or 501)"
            fi
            echo ""
          } >> $GITHUB_STEP_SUMMARY

          # Action 3: Create Project
          {
            echo "### Action 3: Create Project (POST /projects)"
            CODE=$(curl -sS -o /tmp/proj.json -w '%{http_code}' -X POST \
              -H "Authorization: Bearer $JWT" \
              -H "Content-Type: application/json" \
              -d '{"name":"Test Project","client":"Test Client"}' \
              "$BASE/projects" || true)
            echo "- HTTP Status: $CODE"
            if [ "$CODE" = "201" ] || [ "$CODE" = "200" ]; then
              echo "- ✅ PASS"
            elif [ "$CODE" = "501" ]; then
              echo "- ⚠️  501 (not yet implemented)"
            else
              echo "- ⚠️  Got $CODE (may not be implemented in MVP)"
            fi
            echo ""
          } >> $GITHUB_STEP_SUMMARY

          # Action 4: Bulk Allocate (skipped - requires valid project)
          {
            echo "### Action 4: Bulk Allocate (PUT /projects/{id}/allocations:bulk)"
            echo "- Status: SKIPPED (requires valid project_id from Action 3)"
            echo ""
          } >> $GITHUB_STEP_SUMMARY

          # Action 5: Record Adjustment
          {
            echo "### Action 5: Record Adjustment (POST /adjustments)"
            CODE=$(curl -sS -o /tmp/adj.json -w '%{http_code}' -X POST \
              -H "Authorization: Bearer $JWT" \
              -H "Content-Type: application/json" \
              -d '{"project_id":"test-proj","type":"test","amount":1000}' \
              "$BASE/adjustments" || true)
            echo "- HTTP Status: $CODE"
            if [ "$CODE" = "201" ] || [ "$CODE" = "200" ]; then
              echo "- ✅ PASS"
            elif [ "$CODE" = "501" ] || [ "$CODE" = "400" ]; then
              echo "- ⚠️  $CODE (expected for MVP - stub or validation)"
            else
              echo "- ❌ FAIL (unexpected status)"
            fi
            echo ""
          } >> $GITHUB_STEP_SUMMARY

      - name: Test GET /health
        continue-on-error: true
        run: |
          curl -sS --fail "$BASE/health" | jq .

      - name: Test GET /catalog/rubros
        continue-on-error: true
        run: |
          curl -sS --fail "$BASE/catalog/rubros" | jq .

      - name: Test GET /allocation-rules (auth required)
        continue-on-error: true
        run: |
          curl -sS --fail -H "Authorization: Bearer ${{ steps.jwt.outputs.id_token }}" "$BASE/allocation-rules" | jq .

      - name: Summary
        if: always()
        run: |
          {
            echo "## Contract Test Execution Complete"
            echo ""
            echo "### Configuration"
            echo "- API Base: ${{ env.BASE }}"
            echo "- Cognito Pool: ${{ env.COGNITO_USER_POOL_ID }}"
            echo "- Postman Collection: postman/Finanzas.postman_collection.json"
            echo ""
            echo "### Test Modes"
            echo "- Newman: Full collection automated testing"
            echo "- Core Smokes: 5 MVP actions validation"
            echo ""
            echo "### Artifacts"
            echo "- Newman report: Available in workflow artifacts"
            echo "- Action Map: docs/ui-api-action-map.md"
          } >> "$GITHUB_STEP_SUMMARY"
