name: API Contract Tests (Newman + No-Fallback Guard)
on:
  pull_request:
    paths:
      - "postman/**"
      - "services/finanzas-api/**"
      - ".github/workflows/api-contract-tests.yml"
  schedule:
    - cron: "0 2 * * *"  # Nightly at 2 AM UTC
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  contract-tests:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      DEV_API_URL: ${{ vars.DEV_API_URL }}
      COGNITO_USER_POOL_ID: ${{ vars.COGNITO_USER_POOL_ID }}
      COGNITO_WEB_CLIENT: ${{ vars.COGNITO_WEB_CLIENT }}
      USERNAME: ${{ vars.COGNITO_TESTER_USERNAME }}
      PASSWORD: ${{ vars.COGNITO_TESTER_PASSWORD }}
      OIDC_AWS_ROLE_ARN: ${{ vars.OIDC_AWS_ROLE_ARN }}
      HAS_USERNAME: ${{ vars.COGNITO_TESTER_USERNAME != '' }}
      HAS_PASSWORD: ${{ vars.COGNITO_TESTER_PASSWORD != '' }}
      HAS_OIDC_ROLE: ${{ vars.OIDC_AWS_ROLE_ARN != '' }}
      DDB_DRY_RUN: "true"

    steps:
      - uses: actions/checkout@v4

      - name: Normalize line endings for local actions
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dos2unix
          find .github/actions -type f -print0 | xargs -0 dos2unix || true

      - name: Preflight repo settings
        shell: bash
        run: |
          set -euo pipefail
          for k in AWS_REGION DEV_API_URL COGNITO_USER_POOL_ID COGNITO_WEB_CLIENT; do
            v="${!k:-}"
            [[ -n "$v" ]] || { echo "âŒ Missing env: $k"; exit 1; }
          done
          [[ "$HAS_USERNAME"  == "true" ]] || { echo "âŒ Missing env: COGNITO_TESTER_USERNAME"; exit 1; }
          [[ "$HAS_PASSWORD"  == "true" ]] || { echo "âŒ Missing env: COGNITO_TESTER_PASSWORD"; exit 1; }
          [[ "$HAS_OIDC_ROLE" == "true" ]] || { echo "âŒ Missing env: OIDC_AWS_ROLE_ARN"; exit 1; }
          echo "âœ… Vars/Secrets OK"

      - name: Configure AWS (OIDC)
        uses: ./.github/actions/oidc-configure-aws
        with:
          role_arn: ${{ env.OIDC_AWS_ROLE_ARN }}
          aws_region: ${{ env.AWS_REGION }}
          session_name: contract-tests-${{ github.run_id }}

      - name: Normalize base URL
        run: |
          set -euo pipefail
          : "${DEV_API_URL:?DEV_API_URL is empty}"
          # Strip whitespace and trailing slashes
          CLEAN_URL=$(echo "$DEV_API_URL" | tr -d '\r\n' | sed 's:/*$::')
          echo "Using DEV_API_URL: ${CLEAN_URL}"
          printf 'BASE=%s\n' "$CLEAN_URL" >> "$GITHUB_ENV"
          sed -i 's/\r$//' "$GITHUB_ENV"

      - name: Generate Cognito JWT
        # âš ï¸ CI Test User Group Requirement:
        # The test user (USERNAME/PASSWORD secrets) MUST belong to at least one
        # of the authorized Cognito groups for Finanzas SD. Valid groups include:
        # SDT (Service Delivery Team), PM (Project Manager), FIN (Finance), AUD (Audit).
        # 
        # If tests fail with HTTP 403 and response body:
        #   {"error":"forbidden: valid group required"}
        # This indicates a GROUP MEMBERSHIP MISCONFIGURATION, not an API bug.
        # 
        # To fix:
        # 1. Go to AWS Console â†’ Cognito â†’ User Pool (from COGNITO_USER_POOL_ID)
        # 2. Navigate to Users and Groups
        # 3. Find the CI test user (from USERNAME secret)
        # 4. Add the user to one of the authorized groups (e.g., SDT)
        # 5. Re-run this workflow
        id: jwt
        uses: ./.github/actions/cognito-generate-jwt
        with:
          user_pool_id: ${{ env.COGNITO_USER_POOL_ID }}
          client_id: ${{ env.COGNITO_WEB_CLIENT }}
          username: ${{ env.USERNAME }}
          password: ${{ env.PASSWORD }}
          aws_region: ${{ env.AWS_REGION }}

      - name: "Install Node + Newman"
        run: |
          pnpm add -g newman newman-reporter-json
          newman --version

      - uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('services/finanzas-api/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: "Setup Canonical Test Data (Non-blocking)"
        id: seed_data
        continue-on-error: true
        env:
          STAGE: dev
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          set -euo pipefail
          
          echo "ðŸŒ± Setting up canonical test data for API tests (optional)"
          echo "âš ï¸  This step is non-blocking - tests should work without seeded data"
          cd services/finanzas-api
          
          # Install dependencies if needed
          if [ ! -d "node_modules" ]; then
            echo "Installing dependencies..."
            rm -rf node_modules
            pnpm install --frozen-lockfile
          fi
          
          # Reset dev environment (delete non-canonical projects)
          echo "ðŸ§¹ Resetting dev environment..."
          pnpm -s run reset:dev-projects -- --force || {
            echo "âš ï¸  Reset failed or no projects to delete - continuing"
          }
          
          # Seed canonical projects
          echo "ðŸ“¦ Seeding canonical projects..."
          pnpm -s run seed:canonical-projects || {
            echo "âš ï¸  Seeding failed - continuing without canonical data"
            exit 0
          }
          
          # Verify canonical projects
          echo "ðŸ” Verifying canonical projects..."
          pnpm -s run verify:canonical-projects || {
            echo "âš ï¸  Verification failed - continuing anyway"
            exit 0
          }
          
          echo "âœ… Canonical test data setup complete"

      - name: "Newman Contract Tests - Finanzas SD API (Non-blocking)"
        id: newman
        continue-on-error: true
        run: |
          set -euo pipefail

          POSTMAN_COLLECTION="postman/finanzas-sd-api-collection.json"
          POSTMAN_ENV="postman/finanzas-sd-dev.postman_environment.json"
          OUTPUT_DIR="/tmp/newman"
          mkdir -p "$OUTPUT_DIR"

          echo "Running Newman contract tests with collection: $POSTMAN_COLLECTION"
          echo "Base URL: ${{ env.BASE }}"

          newman run "$POSTMAN_COLLECTION" \
            --environment "$POSTMAN_ENV" \
            --env-var "baseUrl=${{ env.BASE }}" \
            --env-var "access_token=${{ steps.jwt.outputs.access_token }}" \
            --env-var "username=${{ env.USERNAME }}" \
            --env-var "password=${{ env.PASSWORD }}" \
            --env-var "cognito_client_id=${{ env.COGNITO_WEB_CLIENT }}" \
            --reporters cli,junit,json \
            --reporter-junit-export "$OUTPUT_DIR/newman-junit.xml" \
            --reporter-json-export "$OUTPUT_DIR/newman-report.json" \
            --timeout-request 10000 \
            --timeout-script 5000 \
            --bail

          printf '%s\n' "newman_report=$OUTPUT_DIR/newman-report.json" >> "$GITHUB_OUTPUT"
          echo "âœ… Newman contract tests completed successfully"

      - name: "Parse Newman Results and Generate Report"
        if: always()
        run: |
          set -euo pipefail
          REPORT="/tmp/newman/newman-report.json"

          {
            echo "## ðŸ§ª Newman API Contract Test Results"
            echo ""
            
            if [ ! -f "$REPORT" ]; then
              echo "âš ï¸  No Newman report found. Tests may have failed to execute."
              exit 0
            fi
            
            TOTAL=$(jq '.run.stats.tests.total' "$REPORT" 2>/dev/null || echo "?")
            PASSED=$(jq '.run.stats.tests.passed' "$REPORT" 2>/dev/null || echo "?")
            FAILED=$(jq '.run.stats.tests.failed' "$REPORT" 2>/dev/null || echo "?")
            
            echo "### ðŸ“Š Summary"
            echo "- **Total Tests**: $TOTAL"
            echo "- **Passed**: âœ… $PASSED"
            echo "- **Failed**: âŒ $FAILED"
            echo ""
            
            if [ "$FAILED" != "0" ] && [ "$FAILED" != "?" ]; then
              echo "### âŒ Failed Tests"
              jq -r '.run.executions[] | select(.assertions[]? | select(.error != null)) | "- **\(.item.name)**: \(.assertions[] | select(.error != null) | .error.message // "Unknown error")"' "$REPORT" 2>/dev/null || echo "- (parsing error)"
              echo ""
            fi
            
            echo "### ðŸ“‹ Endpoints Tested"
            jq -r '.run.executions[] | "- \(.item.name): HTTP \(.response.code // "N/A") (\(.response.responseTime // 0)ms)"' "$REPORT" 2>/dev/null | head -30 || echo "- (parsing error)"
            echo ""

            # Check for no-fallback guard failures
            FALLBACK_FAILURES=$(jq -r '.run.executions[] | .assertions[]? | select(.assertion | contains("fallback marker")) | select(.error != null)' "$REPORT" 2>/dev/null | wc -l || echo "0")
            if [ "$FALLBACK_FAILURES" != "0" ]; then
              echo "### ðŸš¨ No-Fallback Guard Violations"
              echo "Found **$FALLBACK_FAILURES** responses containing mock/DEFAULT data markers!"
              echo ""
              jq -r '.run.executions[] | select(.assertions[]? | select(.assertion | contains("fallback marker")) | select(.error != null)) | "- **\(.item.name)**: Contains DEFAULT/mock data"' "$REPORT" 2>/dev/null || echo "- (parsing error)"
              echo ""
            else
              echo "### âœ… No-Fallback Guard: PASSED"
              echo "No DEFAULT or mock data markers detected in any responses."
              echo ""
            fi
            
            echo "### ðŸ“ Configuration"
            echo "- **API Base**: ${{ env.BASE }}"
            echo "- **Collection**: postman/finanzas-sd-api-collection.json"
            echo "- **Environment**: postman/finanzas-sd-dev.postman_environment.json"
            echo "- **Cognito Pool**: ${{ env.COGNITO_USER_POOL_ID }}"
          } >> $GITHUB_STEP_SUMMARY

      - name: "Upload Newman Report"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-contract-report
          path: |
            /tmp/newman/newman-report.json
            /tmp/newman/newman-junit.xml
          if-no-files-found: warn
          retention-days: 30

      - name: "Contract Tests Complete"
        if: always()
        run: |
          {
            echo "## â„¹ï¸  Legacy Contract Test Execution Complete"
            echo ""
            echo "âš ï¸  **Note**: Newman contract tests are now NON-BLOCKING and may contain outdated schema validations."
            echo ""
            echo "These legacy tests check for specific field names (e.g., \`fecha_fin\`) that may not exist in real data."
            echo "They are retained for historical reference but **do not block PR merges**."
            echo ""
            echo "**Recommended**: Use the new behavioral tests (\`npm run test:behavioral\`) which:"
            echo "- Discover real data without requiring seeds"
            echo "- Validate data shapes without asserting exact field names"
            echo "- Test CORS, RBAC, and API reachability"
            echo ""
            echo "See \`.github/workflows/behavioral-api-tests.yml\` for the new blocking test suite."
          } >> "$GITHUB_STEP_SUMMARY"
